{% include "arrangement/vue/select2.html" %}

<template id="vuec-rooms-select">
    <select2 
        @input="(values) => processOutgoing(values)"
        :options="rooms" 
        :multiple="true" 
        :selected="selected" 
        placeholder="Velg rom og presets">

    </select>
</template>

<script>
    let RoomsSelect = {
        template: '#vuec-rooms-select',
        delimiters: ['[[', ']]'],
        components: { Select2 },
        emits: ['update:selected'],
        props: {
            selected: {
                type: Array,
                required: true
            }
        },
        data: function () {
            return {
                presets: [],
                rooms: [],
                selectedRooms: this.selected
            }
        },
        watch: {
            selected: function (newSelected) {
                // Process the ids, replacing with presets where applicable
                let transformedIdsArray = this.processIncoming(newSelected);

                // Set the selected ids
                this.selectedRooms = transformedIdsArray;
            }
        },
        methods: {
            processIncoming: function (selectedIds) {
                Object.values(this.presets).forEach(function (preset) {
                    let allArePresent = true;
                    preset.rooms.forEach(function (room) {
                        if (selectedIds.indexOf(room.id) === -1) {
                            allArePresent = false;
                        }
                    });
                    if (allArePresent) {
                        selectedIds.push("PRESET-" + preset.id);

                        preset.rooms.forEach(function (room) {
                            if (selectedIds.indexOf(room.id) !== -1) {
                                selectedIds.splice(selectedIds.indexOf(room.id), 1);
                            }
                        });
                    }
                });

                return selectedIds;
            },
            processOutgoing: function (selectedIds) {
                let roomIds = [];
                console.log("selectedIds", this.presetsLookup);
                selectedIds.forEach(function(id) {
                    if (String(id).startsWith("PRESET-")) {
                        roomIds = roomIds.concat(this.presetsLookup[id].rooms.map((room) => room.id));
                    }
                    else {
                        roomIds.push(id);
                    }
                }.bind(this));

                console.log("new roomids", roomIds)

                this.$emit('update:selected', roomIds);
            },
            getRooms: async function () {
                return await fetch("/arrangement/room/select2/json")
                    .then(response => response.json());
            },
            getPresets: async function () {
                return await fetch("/arrangement/room_preset/json_list")
                    .then(response => response.json());
            }
        },
        mounted: function () {
            this.getRooms().then(rooms => {
                this.rooms = rooms;
            });
            this.getPresets().then(presets => {
                let presetsLookup = {};
                presets.forEach((preset) => {
                    presetsLookup["PRESET-" + preset.id] = preset;
                });

                this.presetsLookup = presetsLookup;
            });
        }
    }
</script>