{% load static i18n %}
{% load crispy_forms_tags %}
{% load custom_tags %}


<div id="{{dialogId}}" title="{{object.name}}" class="{{discriminator}}">
    <h3>{{object.name}}</h3>
    <h5>Fra {{object.start.start}} til {{object.end.end}}</h5>

    {% if user|has_group:"planners" or user.is_superuser %}
    <button class="btn wb-btn-secondary mb-3" d-trigger="delete"><i class="fas fa-trash"></i>&nbsp; Slett</button>
    <button class="btn wb-btn-main mb-3" 
        d-trigger="triggerCascadeTree"
        data-mdb-toggle="tooltip"
        title="Synkroniser verdier fra arrangementet ned til aktivitetene">
        <i class="fas fa-tree"></i>
        Kaskadeendringer & Synkronisitet
    </button>
    {% endif %}
    
    <input type="hidden" id="_selectedAudienceId" />
    <input type="hidden" id="_selectedArrangementTypeId" />

    <div class="row">
        <div class="col-4">
            <div class="alert wb-bg-secondary">
                <div class="clearfix">
                    <div class="float-start">
                        <h6 class="mb-0 d-inline fw-lighter"><i class="fas fa-star"></i> Hovedplanlegger:</h4>
                        <h4 class="mb-0">{{ object.responsible }}</h4>

                        <small class="d-block"><i class="fas fa-envelope"></i> {{ object.responsible.personal_email }}</small>
                            
                    </div>
                    {% if user|has_group:"planner" or user.is_superuser %}
                    <a class="btn wb-btn-blank float-end shadow-0" href="#"
                            type="button"
                            id="mainPlannerDialog__promotePlannerBtn">
                        Endre
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if object.next_event %}
        <div class="col-4">
            <div class="alert wb-bg-secondary">
                <h6 class="mb-0 d-inline fw-lighter">
                    <i class="fas fa-calendar"></i>
                    Neste aktivitet
                    <h4 class="mb-0">{{object.next_event.title}}</h4>
                    <small>{{object.next_event.start|date:"d.m.Y H:i:s"}} - {{object.next_event.end|date:"d.m.Y H:i:s"}}</small>
                </h6>
            </div>
        </div>
        {% endif %}
    </div>


    <ul class="nav nav-tabs webook-tabs" id="arrangement-info-dialog-tabs">
        <!-- Information/General -->
        <li class="nav-item" role="presentation">
            <a  href="#arrangementInfoDialog_tabs_information"
                id="arrangementInfoDialog_tabs_information-link"
                class="nav-link active"
                role="tab"
                data-mdb-toggle="tab">
                Arrangementsinformasjon
            </a>
        </li>
        <!-- Timeslots -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_timeslots"
                id="arrangementInfoDialog_tabs_timeslots-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Tidsplaner & Aktiviteter
            </a>
        </li>
        <!-- Notes -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_notes"
                id="arrangementInfoDialog_tabs_notes-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Notater
            </a>
        </li>
        <!-- Files -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_files"
                id="arrangementInfoDialog_tabs_files-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Filer
            </a>
        </li>
    </ul>

    <div class="tab-content pt-4">
        <!-- Information / General Tab -->
        <div class="tab-pane fade show active" id="arrangementInfoDialog_tabs_information" role="tabpanel">

            <div class="row">
                <div class="col-8">
    
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group mb-2">
                                <label class="form-label">Navn:</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.name.id_for_label }}"
                                    value="{{ form.name.value|default:'' }}"
                                    name="{{ form.name.name }}"
                                    placeholder="{% trans 'Name of the arrangement' %}..."/>
                                
                                {% if form.name.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group mb-2">
                                <label class="form-label">Navn (<em class="small">Engelsk</em>):</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.name_en.id_for_label }}"
                                    value="{{ form.name_en.value|default:'' }}"
                                    name="{{ form.name_en.name }}"
                                    placeholder="{% trans 'Name of the arrangement (in english)' %}..."/>
            
                                {% if form.name_en.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.name_en.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Billettkode:</label>
                        <input type="text"
                            class="form-control form-control-md"
                            id="{{ form.ticket_code.id_for_label }}"
                            value="{{ form.ticket_code.value|default:'' }}"
                            name="{{ form.ticket_code.name }}"
                            placeholder="{% trans 'Ticket code' %}..."/>
        
                        {% if form.ticket_code.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.ticket_code.errors }}
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="form-group mt-4">
                        <div class="row mt-2">
                            <div class="col-lg-6 col-sm-12">
                                <h4 class="mb-0">Møtested</h4>
                                <label class="form-label">Møtested:</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.meeting_place.id_for_label }}"
                                    value="{{ form.meeting_place.value|default:'' }}"
                                    name="{{ form.meeting_place.name }}"
                                    placeholder="Møtested..."/>
                
                                {% if form.meeting_place.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.meeting_place.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <h4 class="mb-0">Besøkende</h4>
                                <label class="form-label">Forventet antall besøkende:</label>
                                <input type="number"
                                    min="0"
                                    class="form-control form-control-md"
                                    id="{{ form.expected_visitors.id_for_label }}"
                                    value="{{ form.expected_visitors.value|default:'0' }}"
                                    name="{{ form.expected_visitors.name }}"
                                    placeholder="{% trans 'Forventet antall besøkende' %}..."
                                    required/>
                
                                {% if form.expected_visitors.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.expected_visitors.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <label class="form-label">Møtested (Engelsk):</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.meeting_place_en.id_for_label }}"
                                    value="{{ form.meeting_place_en.value|default:'' }}"
                                    name="{{ form.meeting_place_en.name }}"
                                    placeholder="{% trans 'Meeting place (english)' %}..."/>
        
                                {% if form.meeting_place_en.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.meeting_place.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <label class="form-label">Faktisk antall besøkende:</label>
                                <input type="number"
                                    min="0"
                                    class="form-control form-control-md"
                                    id="{{ form.actual_visitors.id_for_label }}"
                                    value="{{ form.actual_visitors.value|default:'' }}"
                                    name="{{ form.actual_visitors.name }}"
                                    placeholder="{% trans 'Faktisk antall besøkende' %}..."/>
        
                                {% if form.actual_visitors.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.actual_visitors.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <h4 class="mt-3">Planleggere</h4>
                    <div class="form-group mt-2">
                        <label class="form-label">Planleggere:</label>
                        <div class="row">
                            <div class="col-lg-6 col-sm-12">
                                <div>
                                    <select multiple id="mainPlannerDialog_plannersSelect" class="form-control">
                                        <option value="MAIN" data-toggle="tooltip" title="Hovedplanlegger" disabled>{{object.responsible}}</option>
                                        {% for planner in object.planners.all %}
                                            <option value="{{planner.pk}}">{{planner}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% if user|has_group:"planner" or user.is_superuser %}
                            <div class="col-lg-6 col-sm-12">
                                <div>
                                    <a href='#' class='shadow-0 btn wb-btn-secondary btn-block mb-2 btn-sm'
                                            d-trigger="triggerAddPlannersDialog">
                                        <i class='fas fa-plus'></i>
                                        Legg til planlegger(e)
                                    </a>
                                </div>
                                <div>
                                    <a href='#' class='shadow-0 btn wb-btn-secondary btn-block btn-sm' id='mainDialog_removePlannerBtn'
                                        d-trigger="removePlanners">
                                        <i class='fas fa-trash'></i>
                                        Fjern valgte planleggere
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="form-group">
                        <label for="{{form.location.id_for_label}}" class="form-label">Lokasjon</label>
                        {{ form.location }}
                    </div>
                    <div id="jsTreeSelects">
                        <div class="mb-2 mt-2">
                            <label for="{{ form.audience.id_for_label }}" class="form-label">
                                <i class="fas fa-users"></i>&nbsp;
                                Målgruppe
                            </label>
                            <div id="audience_jstree_select" class="dialog-popover-left-fix"></div>
                            
                            {% if form.audience.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.audience.errors }}
                            </div>
                            {% endif %}
                        </div>            
                        <div class="mb-2">
                            <label for="{{ form.arrangement_type.id_for_label }}" class="form-label select-label">
                                <i class="fas fa-cog"></i>&nbsp;
                                Arrangementstype
                            </label>
                            <div id="arrangement_type_jstree_select" class="dialog-popover-left-fix"></div>
                            {% if form.arrangement_type.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.arrangement_type.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            <label>
                                <i class="fas fa-cog"></i>&nbsp;
                                Status
                            </label>
                            <div id="status_type_jstree_select" class="dialog-popover-left-fix"></div>
                            {% if form.status_type.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.status_type.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <h4>Skjermvisning</h4>
        
                        <div class="row">
                            <div class="col-lg-4 col-sm-12">
                                <label class="form-label">Vises på skjermen: </label>
                                {{ form.display_layouts }}
                            </div>
                            <div class="col-lg-8 col-sm-12 mt-sm-2 mt-lg-0 mb-2">
                                <div 
                                    class="form-group"
                                    id="display-layout-text-group"
                                    style="display:none;">
                                    
                                    <div>
                                        {{ form.display_text|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {{ form.errors }}

            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix  border-top pt-3">
                <div class="float-end">
                    <a href="#" class="btn wb-btn-secondary btn-lg"
                        d-trigger="close">
                        <i class="fas fa-times"></i>
                        Avbryt
                    </a>
                    
                    <a class="btn shadow-0 wb-btn-main" href="#"
                        d-trigger="submit">
                        <i class="fas fa-check"></i>
                        Lagre endringer
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        

        <!-- Timeslots Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_timeslots" role="tabpanel">
            {% if user|has_group:"planner" or user.is_superuser %}
            <div class="clearfix">
                <div class="float-end">
                    <a class="btn wb-btn-main"
                        d-trigger="triggerNewTimePlanDialog">
                        Ny tidsplan
                    </a>
                    <a class="btn wb-btn-main"
                        d-trigger="triggerNewSimpleActivityDialog">
                        Ny enkel aktivitet
                    </a>
                </div>
            </div>
            {% endif %}

            <ul class="nav nav-tabs webook-tabs mt-1" role="tablist">
                <li class="nav-item" role="presentation">
                    <a href="#timeslots_tabs_series" class="nav-link active" data-mdb-toggle="tab">
                        Tidsplaner
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="#timeslots_tabs_activities" class="nav-link" data-mdb-toggle="tab">
                        Aktiviteter
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Series Tab -->
                <div class="tab-pane fade show active" id="timeslots_tabs_series"role="tabpanel">
                     <div class="table-responsive">
                        <table class='table'>
                            <thead>
                            </thead>
            
                            <tbody>
                                {% for event_serie in object.series.all %}
                                <tr>
                                    <td>
                                        <div class="p-4 rounded-6 wb-bg-extra">
                                            <h4>
                                                <i class="fas fa-redo"></i>&nbsp;
                                                {{event_serie.serie_plan_manifest.title}}
                                            </h4>
                                            <div>
                                                <h6>
                                                    {{ event_serie.serie_plan_manifest.schedule_description }}
                                                    <small>({{event_serie.serie_plan_manifest.start_time}} - {{event_serie.serie_plan_manifest.end_time}})</small>

                                                    <small class="d-block mt-2">
                                                        <i class="fas fa-star"></i> {{event_serie.serie_plan_manifest.responsible}}
                                                    </small>
                                                    <small class="d-block mt-2">
                                                        <i class="fas fa-users"></i> {{event_serie.serie_plan_manifest.audience}}
                                                    </small>
                                                    <small class="d-block mt-2">
                                                        <i class="fas fa-cogs"></i> {{event_serie.serie_plan_manifest.arrangement_type}}
                                                    </small>
                                                    <small class="d-block mt-2">
                                                        <i class="fas fa-cogs"></i> {{event_serie.serie_plan_manifest.status}}
                                                    </small>
                                                </h6>
                                            </div>
            
                                            <div class="accordion accordion-flush" id="accordion_{{event_serie.pk}}">
                                                <div class="accordion-item">
                                                <h6 class="accordion-header" id="flush-headingOne">
                                                    <button
                                                            class="accordion-button collapsed wb-bg-extra"
                                                            type="button"
                                                            data-mdb-toggle="collapse"
                                                            data-mdb-target="#flush-collapseOne_{{event_serie.pk}}"
                                                            aria-expanded="false"
                                                            aria-controls="flush-collapseOne">
                                                        Filer
                                                    </button>
                                                </h6>
                                                <div
                                                    id="flush-collapseOne_{{event_serie.pk}}"
                                                    class="accordion-collapse collapse"
                                                    aria-labelledby="flush-headingOne"
                                                    data-mdb-parent="#accordion_{{event_serie.pk}}">
                                                    <div class="accordion-body  wb-bg-extra">
                                                        <div title="Last opp filer under '{{arrangement.name}}'" class=" wb-bg-extra">
                                                            {% if user|has_group:"planner" or user.is_superuser %}
                                                            <div class="clearfix">
                                                                <button class="btn btn-sm wb-btn-secondary float-end"
                                                                    d-trigger="uploadFilesToEventSerie"
                                                                    d-arg-event_serie_pk="{{ event_serie.pk }}">
                                                                    <i class="fas fa-upload"></i>
                                                                    Last opp fil(er)
                                                                </button>
                                                            </div>
                                                            {% endif %}

                                                            {% if not event_serie.files.exists %}
                                                            <h6>Ingen filer lastet opp her ennå</h6>
                                                            {% endif %}


                                                            {% for file in event_serie.files.all %}
                                                                <div class="bg-white p-3 mt-2 rounded-pill">
                                                                    <span>{{file.filename}}</span>
                                                                    <span class="float-end">
                                                                        <a href="#"
                                                                                d-trigger="deleteFile"
                                                                                d-arg-type_discriminator="event_serie"
                                                                                d-arg-file_id="{{file.pk}}">
                                                                            <i class="fas fa-trash"></i>
                                                                        </a>

                                                                        <a data-mdb-toggle="tooltip"
                                                                                class="ms-2 me-3"
                                                                                title="{% trans 'Download this file' %}"
                                                                                href="/media/{{file.file}}"
                                                                                download>
                                                                            <i class="fas fa-download"></i>
                                                                        </a>
                                                                    </span>
                                                                </div>
                                                            {% endfor %}

                                                        </div>
                                                    </div>
                                                </div>
                                                </div>
                                                <div class="accordion-item">
                                                <h6 class="accordion-header" id="flush-headingTwo">
                                                    <button
                                                    class="accordion-button collapsed  wb-bg-extra"
                                                    type="button"
                                                    data-mdb-toggle="collapse"
                                                    data-mdb-target="#flush-collapseTwo_{{event_serie.pk}}"
                                                    aria-expanded="false"
                                                    aria-controls="flush-collapseTwo_{{event_serie.pk}}">
                                                        Aktiviteter
                                                    </button>
                                                </h6>
                                                <div
                                                    id="flush-collapseTwo_{{event_serie.pk}}"
                                                    class="accordion-collapse collapse"
                                                    aria-labelledby="flush-headingTwo"
                                                    data-mdb-parent="#accordion_{{event_serie.pk}}">
                                                    <div class="accordion-body wb-bg-extra" style="max-height: 30em; overflow: scroll;">
                                                        {% for event in event_serie.events.all %}
                                                            <div class="bg-white p-3 mt-2 rounded-pill">
                                                                <span>
                                                                    {{event.start}} / {{event.end}}
                                                                </span>
                                                                
                                                                {% if user|has_group:"planner" or user.is_superuser %}
                                                                <span class="float-end">
                                                                    <a href="#" d-trigger="openEditEvent" d-arg-event_pk="{{ event.pk }}">
                                                                        <i class="fas fa-edit"></i>
                                                                    </a>
                                                                    
                                                                    <a href="#" class="ms-2 me-3">
                                                                        <i class="fas fa-trash"></i>
                                                                    </a>
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {% if user|has_group:"planners" or user.is_superuser %}
                                        <div class="mt-2">
                                            <button class="btn wb-btn-blank"
                                                data-mdb-toggle="tooltip"
                                                title="Delete this time plan"
                                                d-arg-event_serie_pk="{{event_serie.pk}}"
                                                d-trigger="deleteEventSerie">
                                                <i class="fas fa-trash"></i>
                                                Slett
                                            </button>
                                            <button class="btn btn-sm wb-btn-blank"
                                                data-mdb-toggle="tooltip"
                                                title="Edit this time plan"
                                                d-arg-event_serie_pk="{{event_serie.pk}}"
                                                d-trigger="triggerEditSerie">
                                                <i class="fas fa-edit"></i>
                                                Rediger tidsplan
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- Activities/Events Tab -->
                <div class="tab-pane fade" id="timeslots_tabs_activities" role="tabpanel">
                    <div class="table-responsive"  style="max-height:20rem!important; overflow-y: scroll;">
                        <table class="table table-sm interactiveTable"  id="eventsTable">
                            <thead>
                                <tr class="wb-bg-secondary">
                                    <th>
                                        Aktivitet
                                    </th>
                                    <th>
                                        Del av serie?
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in object.event_set.all %}
                                    <tr id="eventsTable_event_{{event.pk}}"
                                        d-trigger="triggerInspectEvent"
                                        d-arg-event_pk="{{event.pk}}">
                                        <td>
                                            {{ event.title }} - <small>{{event.start|date:"d.m.Y H:i:s"}} - {{event.end|date:"d.m.Y H:i:s"}}</small>
                                        </td>
                                        <td>
                                            {% if event.serie %}
                                                <i class="fas fa-check text-success"></i>
                                            {% else %}
                                                <i class="fas fa-times text-danger"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_notes" role="tabpanel">

            {% if not object.notes.exists %}
                <div class="alert wb-bg-secondary">
                    <h4 class="text-center">Ingen notater skrevet ennå!</h4>
                    {% if user|has_group:"planner" or user.is_superuser %}
                    <div class="row">
                        <div class="col text-center">
                            <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                            d-trigger="triggerNewNoteDialog">
                            <i class="fas fa-feather"></i>
                            Nytt notat
                        </a>
                        </div>
                    </div
                    {% endif %}
                </div>
            {% elif user|has_group:"planner" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-main shadow-0 mb-2 float-end" 
                        d-trigger="triggerNewNoteDialog">
                        <i class="fas fa-feather"></i>
                        Nytt notat
                    </a>
                </div>
            {% endif %}

            <div style="overflow-y: scroll; max-height: 30em;">
                {% for note in object.notes.all %}
                <div class="p-3 border rounded-6 shadow-3 mt-2" id="note_{{note.pk}}">
                    {{note.content|safe}}
    
                    <hr>
    
                    <div class="clearfix">
                        <div class="float-start">
                            <div class="float-start">
                                {% if note.has_personal_information %}
                                    <i class="fas fa-shield-alt text-warning h3"></i> <strong>Inneholder <abbr class="me-3" title="Personlig identifiserende informasjon">PII</abbr></strong>
                                {% endif %}
                                <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created|date:'d.m.Y H:i' }}</em>
                            </div>
                        </div>
                        {% if user|has_group:"planner" or user.is_superuser %}
                        <div class="float-end">
                            <a href="#" class="btn wb-btn-main"
                                d-trigger="deleteNote"
                                d-arg-note_pk="{{ note.pk }}">
                                <i class="fas fa-trash"></i>
                            </a>
    
                            <a href="#" class="btn wb-btn-main"
                                d-trigger="triggerUpdateNoteDialog"
                                d-arg-note_pk="{{ note.pk }}">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Receipts Tab -->
        <!-- <div class="tab-pane fade" id="arrangementInfoDialog_tabs_receipts" role="tabpanel">
            Kvitteringer...
        </div> -->

        <!-- Files Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_files" role="tabpanel">
            {% if arrangement.files.exists %}
                {% if user|has_group:"planner" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-main shadow-0 float-end"
                            d-trigger="triggerUploadFilesToArrangementDialog"
                            href="#">
                        <i class="fas fa-upload"></i>
                        Upload file(s)
                    </a>
                </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Fil</th>
                            </tr>
                        </thead>
        
                        <tbody>
                            {% for file in arrangement.files.all %}
                                <tr>
                                    <td>
                                        {% if user|has_group:"planner" or user.is_superuser %}
                                        <a class="btn wb-btn-secondary btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                            data-mdb-toggle="tooltip"
                                            title="{% trans 'Delete this file' %}"
                                            d-trigger="deleteFile"
                                            d-arg-type_discriminator="arrangement"
                                            d-arg-file_id="{{file.pk}}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                        <a class="btn wb-btn-secondary btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                            data-mdb-toggle="tooltip"
                                            title="{% trans 'Download this file' %}"
                                            href="/media/{{file.file}}" download>
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </td>
                                    <td>{{ file.filename }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert wb-bg-secondary">
                    <h4 class="text-center">Ingen filer lastet opp her ennå!</h4>
                    {% if user|has_group:"planner" or user.is_superuser %}
                    <div class="row">
                        <div class="col text-center">
                            <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                            d-trigger="triggerUploadFilesToArrangementDialog"
                            href="#">
                            <i class="fas fa-upload"></i>
                            Last opp
                        </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>


<script type="module">
    import { JSTreeSelect } from "{% static 'js/jsTreeSelect.js' %}";

    new Dialog({
        managerName: '{{managerName}}',
        dialogId: '{{dialogId}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                dialog.querySelectorAll("input,select").forEach( (inputElement) => inputElement.setAttribute("disabled", "") );
            {% endif %}

            dialog.querySelectorAll("#arrangement-info-dialog-tabs a[data-mdb-toggle='tab']")
                .forEach( (element) => {
                    element.addEventListener('click', (event) => {
                        console.log(event);
                        dialog.data.currentlyActiveTab = event.target.id;
                    })
                } )

            dialog.data.audienceJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#audience_jstree_select'),
                initialSelected: { id: '{{ object.audience.id }}', text: '{{ object.audience.name }}', parent: '{{object.audience.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/audience/tree",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen målgruppe valgt ennå",
                selectFirstTimeButtonText: 'Velg målgruppe',
                changeSelectedValueButtonText: 'målgruppe',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.arrangementTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#arrangement_type_jstree_select'),
                initialSelected: { id: '{{ object.arrangement_type.id }}', text: '{{ object.arrangement_type.name }}', parent: '{{object.arrangement_type.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/arrangementtype/treelist",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen arrangementstype valgt ennå",
                selectFirstTimeButtonText: 'Velg arrangementstype',
                changeSelectedValueButtonText: 'Endre arrangementstype',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.statusTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#status_type_jstree_select'),
                initialSelected: { id: '{{ object.status.id }}', text: '{{ object.status.name }}' },
                treeJsonSrcUrl: "/arrangement/statustype/tree",
                valueSelectedLabelText: ( selected ) => {
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");

                    labelText += selected.text;
                    
                    return labelText;
                },
                noneSelectedLabelText: "Ingen status valgt ennå",
                selectFirstTimeButtonText: 'Velg status',
                changeSelectedValueButtonText: 'Endre status',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            
            {% for event in object.event_set.all %}
            new mdb.Popover(dialog.getElementById('eventsTable_event_{{event.pk}}'), {
                container: dialog.dialogElement,
                trigger: 'hover',
                html: true,
                content: `
                    <h5 class='mb-0 mt-0 fw-bold'>{{event.title}}</h5>

                    {{event.start|date:"d.m.Y H:i:s"}} - {{event.end|date:"d.m.Y H:i:s"}}

                    <small class='d-block'><strong><i class='fas fa-star'></i> {{event.responsible}}</strong></small>
                    <small class='d-block'><strong><i class='fas fa-cog'></i> {{event.arrangement_type}}</strong></small>
                    <small class='d-block'><strong><i class='fas fa-users'></i> {{event.audience}}</strong></small>
                    <small class='d-block'><strong><i class='fas fa-cog'></i> {{event.status}}</strong></small>

                `
            });
            {% endfor %}

            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                document.querySelectorAll("#jsTreeSelects button").forEach( (buttonElement) => buttonElement.remove() );
            {% endif %}
            dialog.querySelectorAll("#jsTreeSelects button").forEach( (buttonElement) => buttonElement.remove() );
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeAllDialogsInThisManagerGroup();
            },
            /* Trigger/Open the update note dialog for the note by notePk */
            triggerUpdateNoteDialog(dialog, { notePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "editNoteDialog", { note_pk: notePk, $parent: dialog.dialogElement });
            },
            triggerNewTimePlanDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newTimePlanDialog", { $parent: dialog.dialogElement });
            },
            triggerNewSimpleActivityDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newSimpleActivityDialog", { $parent: dialog.dialogElement });
            },
            triggerNewNoteDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newNoteDialog", { $parent: dialog.dialogElement });
            },
            triggerUploadFilesToArrangementDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "uploadFilesToArrangementDialog", { $parent: dialog.dialogElement });
            },
            deleteNote(dialog, { notePk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Er du sikker på at du ønsker å slette dette notatet?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Slett',
                    cancelButtonText: 'Avbryt',
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/arrangement/note/delete/' + notePk, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{csrf_token}}',
                            }
                        }).then(response => { dialog.getElementById('note_' + notePk).remove(); });
                    }
                });
            },
            uploadFilesToEventSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "uploadFilesToEventSerieDialog", { event_serie_pk: eventSeriePk, $parent: dialog.dialogElement });
            },
            deleteActivity(dialog, { activityPk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Aktiviteten kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let formData = new FormData();
                        formData.append("eventIds", activityPk);
                        formData.append("csrfmiddlewaretoken", "{{CSRF_TOKEN}}")
                        fetch('/arrangement/planner/delete_events/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                "X-CSRFToken": "{{csrf_token}}",
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded"));
                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.reload", { "detail": {
                                    dialog: "mainDialog"
                                }}
                            ))
                        });
                    }
                });
            },
            triggerInspectEvent(dialog, { eventId } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("eventInspector", "inspectEventDialog", { pk: eventId });
            },
            submit(dialog, {} = {}, triggeredByElement) {
                if (!dialog.data.audienceJsTreeSelect.isValid()) {
                    dialog.data.audienceJsTreeSelect.showInvalidFeedback();
                    return false;
                }
                if (!dialog.data.arrangementTypeJsTreeSelect.isValid()) {
                    dialog.data.arrangementTypeJsTreeSelect.showInvalidFeedback();
                    return false;
                }

                let formData = new FormData();
                var $dialog = $('#mainDialog');
                formData.append("name",                 dialog.interior.id_name.value);
                formData.append("name_en",              dialog.interior.id_name_en.value);
                formData.append("audience",             dialog.data.audienceJsTreeSelect.getSelectedValue());
                formData.append("location",             dialog.interior.id_location.value);
                formData.append("arrangement_type",     dialog.data.arrangementTypeJsTreeSelect.getSelectedValue());
                formData.append("ticket_code",          dialog.interior.id_ticket_code.value);
                formData.append("meeting_place",        dialog.interior.id_meeting_place.value);
                formData.append("meeting_place_en",     dialog.interior.id_meeting_place_en.value);
                formData.append("expected_visitors",    dialog.interior.id_expected_visitors.value);
                formData.append("actual_visitors",      dialog.interior.id_actual_visitors.value);
                formData.append("display_text",         dialog.plugins.showIfSelected.isInShowState() ? dialog.interior.id_display_text.value : '');
                formData.append("csrfmiddlewaretoken",  "{{ csrf_token }}");
                formData.append("status",               dialog.data.statusTypeJsTreeSelect.getSelectedValue());

                dialog.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked").forEach(element => {
                    formData.append("display_layouts", element.value);
                });

                dialog.raiseSubmitEvent({
                    dialog: dialog.dialogId,
                    formData: formData,
                });
            },
            triggerEditSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "editEventSerieDialog", { event_serie_pk: eventSeriePk, $parent: dialog.dialogElement });
            },
            triggerCascadeTree(dialog, { eventId } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "cascadeTreeDialog", { $parent: dialog.dialogElement, pk: {{object.pk}} })
            },
            triggerAddPlannersDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "selectPlannersDialog", { $parent: dialog.dialogElement, sendTo: '{{dialogId}}', multiple: true, data: { whenEventName: "addPlanners", arrangementSlug: "{{object.slug}}" } });
            },
            triggerAddPlannerDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "addPlannerDialog", { $parent: dialog.dialogElement });
            },
            openEditEvent(dialog, { eventPk } = {}, triggeredByElement) {
                document.dispatchEvent(
                    new CustomEvent("plannerCalendar.inspectEvent", { "detail": {
                        event_pk: eventPk, $parent: dialog.dialogElement
                    }}
                ))
            },
            deleteEvent(dialog, { eventPk } = {}, triggeredByElement) {
                throw Error("Not implemented");
            },
            deleteEventSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Serien og hendelsene i serien kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch("/arrangement/eventSerie/delete/" + eventSeriePk, {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": "{{csrf_token}}"
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.reload", { "detail": {
                                    dialog: "mainDialog"
                                }}
                            ))
                        });
                    }
                });
            },
            delete(dialog, {} = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Arrangementet og underliggende aktiviteter vil bli fjernet, og kan ikke hentes tilbake.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/arrangement/arrangement/delete/{{ object.slug }}', {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": '{{ csrf_token }}'
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("arrangementInspector.close"));    // Close all dialogs on mainPlannerDialog
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                        });
                    }
                });
            },
            deleteFile(dialog, { fileId, typeDiscriminator } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Filen kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let urlToDelete = "/arrangement/arrangement/files/delete/";
                        if (typeDiscriminator !== undefined && typeDiscriminator == "event_serie") {
                            urlToDelete = "/arrangement/eventSerie/files/delete/"
                        }

                        fetch(urlToDelete + fileId, {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": '{{ csrf_token }}'
                            }
                        })
                        .then(_ => {
                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.hasBeenUpdated", {"detail": {
                                    dialog: "mainDialog",
                                }})
                            )
                        })
                    }
                });
            },
            removeRoomFromEvent(dialog, { eventPk, roomPk } = {}, triggeredByElement) {
                let formData = new FormData();
                formData.set("event_pk", eventPk);
                formData.set("room_pk", roomPk)

                fetch('/arrangement/planner/remove_room_from_event', {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}"
                    }
                })
                .then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                });
            },
            removePersonFromEvent(dialog, {eventPk, personPk} = {}, triggeredByElement) {
                let formData = new FormData();
                formData.set("event_pk", event_pk);
                formData.set("person_pk", person_pk)

                fetch('/arrangement/planner/remove_person_from_event', {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}"
                    }
                })
                .then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                });
            },
            removePlanners(dialog, {} = {}, triggeredByElement) {
                let planners = dialog.$('#mainPlannerDialog_plannersSelect').val().join(",");
                let formData = new FormData()
                formData.append("planner_ids", planners);
                formData.append("arrangement_slug", "{{arrangement.slug}}")

                fetch('{% url "arrangement:arrangement_remove_planners_form" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": '{{csrf_token}}'
                    }
                }).then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                })
            },
        },
        data: {
            currentlyActiveTab: "",
        },
        plugins: [
            {
                name: 'showIfSelected',
                pluginClass: DialogShowIfSelectedPlugin,
                args: {
                    checkboxesSelector: "[name='display_layouts']",
                    elementToShowOrHide: ( dialog ) => { return dialog.getElementById('display-layout-text-group'); },
                    showIfAnyOfTheseValuesMap: new Map([
                        {% for display_layout in DISPLAY_LAYOUTS_WITH_REQUISITE_TEXT %}
                            [ "{{ display_layout.id }}", true],
                        {% endfor %}
                    ]),
                },
            },
            {
                name: "syncDataToManager",
                pluginClass: SyncDialogDataToManagerContextPlugin,
            }
        ],
    })
</script>
