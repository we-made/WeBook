{% load static i18n %}


<div id="mainDialog" title="{{object.name}}">

    <button class="btn btn-danger mb-3" onclick="mainPlannerDialog_deleteArrangement()"><i class="fas fa-trash"></i>&nbsp; Slett</button>

    <div id="tabs" class="light-tabs">
        <ul>
            <li>
                <a href="#tabs-1">
                    <i class="fas fa-info-circle"></i>&nbsp; 
                    Informasjon
                </a>
            </li>
            <li>
                <a href="#tabs-2">
                    <i class="fas fa-calendar"></i>&nbsp; 
                    Tidspunkter
                </a>
            </li>
            <li>
                <a href="#tabs-3">
                    <i class="fas fa-comment"></i>&nbsp; 
                    Notater
                </a>
            </li>
            <li>
                <a href="#tabs-4">
                    <i class="fas fa-receipt"></i>&nbsp; 
                    Kvitteringer
                </a>
            </li>
            <li>
                <a href="#tabs-5">
                    <i class="fas fa-file"></i>&nbsp; 
                    Filer
                </a>
            </li>
        </ul>
        <div id="tabs-1">
            <table class='table table-sm'>
                <tbody>
                    <tr>
                        <td colspan='2'>
                            <strong>Navn:</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.name.id_for_label }}" 
                                value="{{ form.name.value|default:'' }}"
                                name="{{ form.name.name }}"
                                placeholder="{% trans 'Name of the arrangement' %}..."/>
                            <br>
                            <strong class="mt-3">Navn (<em class="small">Engelsk</em>):</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.name_en.id_for_label }}" 
                                value="{{ form.name_en.value|default:'' }}"
                                name="{{ form.name_en.name }}"
                                placeholder="{% trans 'Name of the arrangement (in english)' %}..."/>

                            {% if form.name.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.name_en.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan='2'>
                            <strong>Målgruppe:</strong>
                            {{ form.audience }}

                            {% if form.audience.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.audience.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <strong>Lokasjon</strong>
                            {{ form.location }}

                            {% if form.location.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.location.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2'>
                            <strong>Arrangementstype:</strong>
                            {{ form.arrangement_type }}
                            
                            {% if form.arrangement_type.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.arrangement_type.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2'>
                            <strong>Billettkode:</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.ticket_code.id_for_label }}" 
                                value="{{ form.ticket_code.value|default:'' }}"
                                name="{{ form.ticket_code.name }}"
                                placeholder="{% trans 'Ticket code' %}..."/>
                            
                            {% if form.ticket_code.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.ticket_code.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2'>
                            <strong>Møtested:</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.meeting_place.id_for_label }}" 
                                value="{{ form.meeting_place.value|default:'' }}"
                                name="{{ form.meeting_place.name }}"
                                placeholder="{% trans 'Meeting place' %}..."/>
                            
                            {% if form.meeting_place.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.meeting_place.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2'>
                            <strong>Forventet antall besøkende:</strong>
                            <input type="number"
                                min="0"
                                class="form-control"
                                id="{{ form.expected_visitors.id_for_label }}" 
                                value="{{ form.expected_visitors.value|default:'' }}"
                                name="{{ form.expected_visitors.name }}"
                                placeholder="{% trans 'Forventet antall besøkende' %}..."/>
                            
                            {% if form.expected_visitors.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.expected_visitors.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2'>
                            <strong>Faktisk antall besøkende:</strong>
                            <input type="number"
                                min="0"
                                class="form-control"
                                id="{{ form.actual_visitors.id_for_label }}" 
                                value="{{ form.actual_visitors.value|default:'' }}"
                                name="{{ form.actual_visitors.name }}"
                                placeholder="{% trans 'Faktisk antall besøkende' %}..."/>
                            
                            {% if form.actual_visitors.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.actual_visitors.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan='3'>
                            <span class='fw-bolder'>Hovedplanlegger:</span> <em>{{ object.responsible.full_name }}</em> <a href='#' id="mainPlannerDialog__promotePlannerBtn" class='text-primary'>(Endre...)</a>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Planleggere:</strong><br>
                            <select multiple id="mainPlannerDialog_plannersSelect">
                                <option value="MAIN" data-toggle="tooltip" title="Hovedplanlegger" disabled>{{object.responsible}}</option>
                                {% for planner in object.planners.all %}
                                    <option value="{{planner.pk}}">{{planner}}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                        <div>
                        <a href='#' class='shadow-0 text-white btn btn-success btn-block mb-2 btn-sm' id='mainDialog__addPlannerBtn'>
                            <i class='fas fa-plus'></i>
                            Legg til planlegger
                        </a>
                    </div>
                    <div>
                        <a href='#' class='shadow-0 text-white btn btn-danger btn-block btn-sm' id='mainDialog_removePlannerBtn'
                            onclick="mainPlannerDialog__removePlanners()">
                            <i class='fas fa-trash'></i>
                            Fjern valgte
                        </a>
                    </div>
                    <div>
                    </div>
                </td>

                    </tr>
                    <tr>
                        <th colspan='2'>
                            <label for="">Display Layouts: </label>
                            {{ form.display_layouts }}
                        </th>
                    </tr>
                    <tr>
                        <td colspan='3'>
                            <button class=" btn btn-sm shadow-0 btn-success btn-block"
                                    type="button"
                                    onclick="mainPlannerDialog__updateArrangementInfo()">
                                <!-- <i class='fas fa-check'></i> -->
                                Lagre endringer
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>

        {{ form.errors }}

        </div>
        <div id="tabs-2">
            <div class="table-responsive" style="max-height: 480px;">
                <table class='table'>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <button class="playfulButton playfulButton-green" id='mainPlannerDialog__newTimePlan'>
                                <div class="icon"><i class="fas fa-plus"></i></div>
                                Ny tidsplan
                            </button>

                        </div>
                        <div class="col-6">
                            <button class="playfulButton playfulButton-green" id='mainPlannerDialog__newSimpleActivity'>
                                <div class="icon"><i class="fas fa-plus"></i></div>
                                Ny enkel aktivitet
                            </button>
                        </div>
                    </div>

                    <!-- &nbsp;|&nbsp;
                    <a href='#' class='text-primary' id='mainPlannerDialog__showInCalendarForm'><i class='fas fa-calendar'></i>&nbsp; Vis i kalenderform</a> -->
                    <thead>
                    </thead>
                    <tbody>
                        {% for event_serie in object.series.all %}
                        <tr>
                            <td>
                                <div class="shadow-4 border p-4">
                                    <h5>{{event_serie.serie_plan_manifest.title}}</h5>
                                    <div>
                                        <div>
                                            <i class="fas fa-redo"></i> {{event_serie.serie_plan_manifest.pattern}} every {{ event_serie.serie_plan_manifest.pattern_strategy }}
                                        </div>
                                        <div>
                                            <i class="fas fa-clock"></i> {{event_serie.serie_plan_manifest.start_time}} - {{event_serie.serie_plan_manifest.end_time}}
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-danger"
                                            data-mdb-toggle="tooltip"
                                            title="Delete this time plan"
                                            onclick="mainPlannerDialog_deleteEventSerie({{event_serie.pk}})">
                                            Slett
                                        </button>
                                        <button class="btn btn-sm btn-success"
                                            data-mdb-toggle="tooltip"
                                            title="Edit this time plan"
                                            onclick="mainPlannerDialog__openEditSerie({{event_serie.pk}})">
                                            Rediger
                                        </button>
                                    </div>

                                    
                                    <div class="accordion accordion-flush" id="accordion_{{event_serie.pk}}">
                                        <div class="accordion-item">
                                        <h6 class="accordion-header" id="flush-headingOne">
                                            <button
                                            class="accordion-button collapsed"
                                            type="button"
                                            data-mdb-toggle="collapse"
                                            data-mdb-target="#flush-collapseOne_{{event_serie.pk}}"
                                            aria-expanded="false"
                                            aria-controls="flush-collapseOne"
                                            >
                                            <i class="fas fa-file"></i>&nbsp; Filer
                                            </button>
                                        </h6>
                                        <div
                                            id="flush-collapseOne_{{event_serie.pk}}"
                                            class="accordion-collapse collapse"
                                            aria-labelledby="flush-headingOne"
                                            data-mdb-parent="#accordion_{{event_serie.pk}}"
                                        >
                                            <div class="accordion-body">
                                                <div id="uploadFilesToArrangementDialog" title="Last opp filer under '{{arrangement.name}}'" class="bg-white">
                                                    <button class="btn btn-sm btn-success float-end"
                                                        onclick="mainPlannerDialog__uploadFilesToEventSerie({{event_serie.pk}})">
                                                        <i class="fas fa-upload"></i>
                                                        Last opp fil(er)
                                                    </button>
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Filnavn</th>
                                                                <th>Valg</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for file in event_serie.files.all %}
                                                                <tr>
                                                                    <td>{{file.filename}}</td>
                                                                    <td>

                                                                        <button class="btn btn-danger btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                                                            data-mdb-toggle="tooltip"
                                                                            title="{% trans 'Delete this file' %}"
                                                                            onclick="mainPlannerDialog__deleteFile( {{ file.pk }}, 'event_serie' )"> 
                                                                            <i class="fas fa-trash"></i> 
                                                                        </button>
                                                                        <a class="btn btn-success btn-sm text-white" style="border-radius: 50%!important; padding: 0.7rem;"
                                                                            data-mdb-toggle="tooltip"
                                                                            title="{% trans 'Download this file' %}"
                                                                            href="/media/{{file.file}}" download>
                                                                            <i class="fas fa-download"></i> 
                                                                    </a>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                        <div class="accordion-item">
                                        <h6 class="accordion-header" id="flush-headingTwo">
                                            <button
                                            class="accordion-button collapsed"
                                            type="button"
                                            data-mdb-toggle="collapse"
                                            data-mdb-target="#flush-collapseTwo_{{event_serie.pk}}"
                                            aria-expanded="false"
                                            aria-controls="flush-collapseTwo_{{event_serie.pk}}"
                                            >
                                                <i class="fas fa-calendar"></i>&nbsp; Aktiviteter
                                            </button>
                                        </h6>
                                        <div
                                            id="flush-collapseTwo_{{event_serie.pk}}"
                                            class="accordion-collapse collapse"
                                            aria-labelledby="flush-headingTwo"
                                            data-mdb-parent="#accordion_{{event_serie.pk}}"
                                        >
                                            <div class="accordion-body">
                                                <table class="table">
                                                    <tbody>
                                                        {% for event in event_serie.events.all %}

                                                        <tr>

                                                            <td>
                                                                <div>
                
                                                                    {{event}}
                                
                                                                </div>
                                                            </td>

                                                            <td>
                                                                <div class="btn-group">
                                                                    <button class="btn btn-sm btn-danger"
                                                                        data-mdb-toggle="tooltip"
                                                                        title="{% trans 'Delete this activity' %}"
                                                                        onclick="mainPlannerDialog__deleteActivity({{event.pk}})">
                                                                        Slett
                                                                    </button>
                                                                    <button class="btn btn-sm btn-success"
                                                                        data-mdb-toggle="tooltip"
                                                                        title"{% trans 'Edit this activity' %}"
                                                                        onclick="mainPlannerDialog__openEditEvent({{event.pk}});">
                                                                        Rediger
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}

                                                    </tbody>
                                                </table>
        
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                  </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="tabs-3">
            <div class="clearfix">
                <button class="text-white btn btn-sm btn-success shadow-0 mb-2 float-end" id="mainPlannerDialog__newNoteBtn">Nytt notat</button>
            </div>

            {% for note in object.notes.all %}
                <div class="border bg-light p-2">
                    {{note.content}}

                    <div class="clearfix">
                        <em class="text-muted small float-end">{{note.author}}</em>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="tabs-4">
            Kvitteringer...
        </div>
        <div id="tabs-5">
            <div class="clearfix">
                <button class="btn btn-success btn-sm shadow-0 float-end"
                        id="mainDialog__uploadFilesBtn">
                    <i class="fas fa-upload"></i>
                    Upload file(s)
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Filename</th>
                            <!-- <th>Uploader</th> -->
                        </tr>
                    </thead>

                    <tbody>
                        {% for file in arrangement.files.all %}

                            <tr>
                                <td>

                                    <button class="btn btn-danger btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                        data-mdb-toggle="tooltip"
                                        title="{% trans 'Delete this file' %}"
                                        onclick="mainPlannerDialog__deleteFile( {{ file.pk }} )"> 
                                        <i class="fas fa-trash"></i> 
                                    </button>
                                    <a class="btn btn-success btn-sm text-white" style="border-radius: 50%!important; padding: 0.7rem;"
                                        data-mdb-toggle="tooltip"
                                        title="{% trans 'Download this file' %}"
                                        href="/media/{{file.file}}" download>
                                        <i class="fas fa-download"></i> 
                                </a>
                                </td>
                                <td>{{ file.filename }}</td>
                            </tr>

                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>


<script>
    function mainPlannerDialog__updateArrangementInfo() {
        var csrf_token="{{csrf_token}}"

        var formData = new FormData();
        formData.append("name",             $('#id_name').val());
        formData.append("name_en",          $('#id_name_en').val());
        formData.append("audience",         $('#id_audience').val());
        formData.append("location",         $('#id_location').val());
        formData.append("arrangement_type", $('#id_arrangement_type').val());
        formData.append("ticket_code",      $('#id_ticket_code').val());
        formData.append("meeting_place",    $('#id_meeting_place').val());
        formData.append("expected_visitors",$('#id_expected_visitors').val());
        formData.append("actual_visitors",  $('#id_actual_visitors').val());
        formData.append("csrfmiddlewaretoken","{{ csrf_token }}");

        let displayLayouts = [];
        document.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked").forEach(element => {
            formData.append("display_layouts", element.value);
        })

        document.dispatchEvent(
            new CustomEvent("arrangementInspector.submit", { "detail": {
                dialog: "mainDialog",
                formData: formData,
            }})
        );
    }

    function mainPlannerDialog__uploadFilesToEventSerie(event_serie_pk) {
        document.dispatchEvent(
            new CustomEvent("arrangementInspector.uploadFilesToEventSerieDialog.trigger", { "detail": {
                "event_serie_pk": event_serie_pk
            } })
        )
    }

    function mainPlannerDialog__deleteActivity(activity_pk) {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Aktiviteten kan ikke hentes tilbake etter sletting.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                var formData = new FormData();
                formData.append("eventIds", String(activity_pk));
                formData.append("csrfmiddlewaretoken", "{{CSRF_TOKEN}}")
                fetch('/arrangement/planner/delete_events/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}",
                    }
                }).then(_ => { 
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.reload", { "detail": {
                            dialog: "mainDialog"
                        }}
                    ))
                });
            }
        })
    }
    
    function mainPlannerDialog__openEditSerie(event_serie_pk) {
        console.log("hoi")
        document.dispatchEvent(
            new CustomEvent("arrangementInspector.editEventSerieDialog.trigger", { "detail": {
                event_serie_pk: event_serie_pk
            } })
        )
    }

    function mainPlannerDialog__openEditEvent(event_pk) {
        console.log(">> plannerCalendar edit event", event_pk)
        document.dispatchEvent(
            new CustomEvent("plannerCalendar.inspectEvent", { "detail": {
                event_pk: event_pk
            }}
        ))
    }

    function mainPlannerDialog_deleteEventSerie(event_serie_pk) {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Serien og hendelsene i serien kan ikke hentes tilbake etter sletting.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/arrangement/eventSerie/delete/" + event_serie_pk, {
                    method: 'DELETE',
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}"
                    }
                }).then(_ => { 
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.reload", { "detail": {
                            dialog: "mainDialog"
                        }}
                    ))
                });
            }
        })
    }

    function mainPlannerDialog_deleteArrangement() {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Arrangementet og underliggende aktiviteter vil bli fjernet, og kan ikke hentes tilbake.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/arrangement/arrangement/delete/{{ object.slug }}', {
                    method: 'DELETE',
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    }
                }).then(_ => { 
                    document.dispatchEvent(new Event("arrangementInspector.close"));    // Close all dialogs on mainPlannerDialog
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                });
            }
        })
    }

    function mainPlannerDialog__deleteFile(file_id, type_discriminator) {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Filen kan ikke hentes tilbake etter sletting.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                var urlToDelete = "/arrangement/arrangement/files/delete/";
                if (type_discriminator !== undefined && type_discriminator == "event_serie") {
                    urlToDelete = "/arrangement/eventSerie/files/delete/"
                }

                fetch(urlToDelete + file_id, {
                    method: 'DELETE',
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    }
                })
                .then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {"detail": {
                            dialog: "mainDialog",
                        }})
                    )
                })
            }
        })
    }

    function mainPlannerDialog__removeRoomFromEvent(event_pk, room_pk) {
        var formData = new FormData();
        formData.set("event_pk", event_pk);
        formData.set("room_pk", room_pk)

        fetch('/arrangement/planner/remove_room_from_event', {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{csrf_token}}"
            }
        })
        .then(_ => {
            document.dispatchEvent(
                new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                    dialog: "mainDialog",
                }})
            )
        })
    }

    function mainPlannerDialog__removePersonFromEvent(event_pk, person_pk) {
        var formData = new FormData();
        formData.set("event_pk", event_pk);
        formData.set("person_pk", person_pk)

        fetch('/arrangement/planner/remove_person_from_event', {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{csrf_token}}"
            }
        })
        .then(_ => {
            document.dispatchEvent(
                new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                    dialog: "mainDialog",
                }})
            )
        })
    }

    function mainPlannerDialog__removePlanners() {
        var planners = $('#mainPlannerDialog_plannersSelect').val().join(",");
        var formData = new FormData()
        formData.append("planner_ids", planners);
        formData.append("arrangement_slug", "{{arrangement.slug}}")

        fetch('{% url "arrangement:arrangement_remove_planners_form" %}', {
            method: 'POST',
            body: formData,
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            }
        }).then(_ => {
            document.dispatchEvent(
                new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                    dialog: "mainDialog",
                }})
            )
        })
    }
</script>