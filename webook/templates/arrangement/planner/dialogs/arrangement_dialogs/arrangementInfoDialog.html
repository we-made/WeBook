 {% load static i18n %}
{% load crispy_forms_tags %}
{% load custom_tags %}


<div id="{{dialogId}}" title="{{object.name}}" class="{{discriminator}}">
    <h3>{{object.name}}</h3>
    <h5>Fra {{object.start.start}} til {{object.end.end}}</h5>

    {% if user|has_group:"planners" or user.is_superuser %}
    <button class="btn wb-btn-secondary mb-3" d-trigger="delete"><i class="fas fa-trash"></i>&nbsp; Slett</button>
    <button class="btn wb-btn-main mb-3" 
        d-trigger="triggerCascadeTree"
        data-mdb-toggle="tooltip"
        title="Synkroniser verdier fra arrangementet ned til aktivitetene">
        <i class="fas fa-tree"></i>
        Kaskadeendringer & Synkronisitet
    </button>
    {% endif %}
    
    <input type="hidden" id="_selectedAudienceId" />
    <input type="hidden" id="_selectedArrangementTypeId" />

    <div class="row">
        <div class="col-12 col-lg-4 col-md-6">
            <div class="alert wb-bg-secondary">
                <h6 class="mb-0 d-inline fw-lighter"><i class="fas fa-star"></i> Hovedplanlegger:</h4>
                <h4 class="mb-0">{{ object.responsible }}</h4>

                <span style="text-wrap: wrap;"><i class="fas fa-envelope"></i> {{ object.responsible.personal_email }}</span>

                {% if user|has_group:"planners" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-blank float-end shadow-0" href="#"
                            type="button"
                            id="mainPlannerDialog__promotePlannerBtn">
                        Endre
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if object.next_event %}
        <div class="col-12 col-lg-4 col-md-6">
            <div class="alert wb-bg-secondary">
                <h6 class="mb-0 d-inline fw-lighter">
                    <i class="fas fa-calendar"></i>
                    Neste aktivitet
                    <h4 class="mb-0">{{object.next_event.title}}</h4>
                    <small>{{object.next_event.start|date:"d.m.Y H:i:s"}} - {{object.next_event.end|date:"d.m.Y H:i:s"}}</small>
                </h6>
            </div>
        </div>
        {% endif %}
    </div>


    <ul class="nav nav-tabs webook-tabs" id="arrangement-info-dialog-tabs">
        <!-- Information/General -->
        <li class="nav-item" role="presentation">
            <a  href="#arrangementInfoDialog_tabs_information"
                id="arrangementInfoDialog_tabs_information-link"
                class="nav-link active"
                role="tab"
                data-mdb-toggle="tab">
                Arrangementsinformasjon
            </a>
        </li>
        <!-- Timeslots -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_timeslots"
                id="arrangementInfoDialog_tabs_timeslots-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Tidsplaner & Aktiviteter
            </a>
        </li>
        <!-- Notes -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_notes"
                id="arrangementInfoDialog_tabs_notes-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Notater
            </a>
        </li>
        <!-- Files -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_files"
                id="arrangementInfoDialog_tabs_files-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Filer
            </a>
        </li>

        {% if object.is_school_related %}
        <!-- School Related -->
        <li class="nav-item" role="presentation">
            <a href="#arrangementInfoDialog_tabs_school"
                id="arrangementInfoDialog_tabs_school-link"
                class="nav-link"
                role="tab"
                data-mdb-toggle="tab">
                Skole
            </a>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content pt-4">
        <!-- Information / General Tab -->
        <div class="tab-pane fade show active" id="arrangementInfoDialog_tabs_information" role="tabpanel">

            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-12">
    
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group mb-2">
                                <label class="form-label">Navn:</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.name.id_for_label }}"
                                    value="{{ form.name.value|default:'' }}"
                                    name="{{ form.name.name }}"
                                    placeholder="{% trans 'Name of the arrangement' %}..."/>
                                
                                {% if form.name.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group mb-2">
                                <label class="form-label">Navn (<em class="small">Engelsk</em>):</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.name_en.id_for_label }}"
                                    value="{{ form.name_en.value|default:'' }}"
                                    name="{{ form.name_en.name }}"
                                    placeholder="{% trans 'Name of the arrangement (in english)' %}..."/>
            
                                {% if form.name_en.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.name_en.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Billettkode:</label>
                        <input type="text"
                            class="form-control form-control-md"
                            id="{{ form.ticket_code.id_for_label }}"
                            value="{{ form.ticket_code.value|default:'' }}"
                            name="{{ form.ticket_code.name }}"
                            placeholder="{% trans 'Ticket code' %}..."/>
        
                        {% if form.ticket_code.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.ticket_code.errors }}
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="form-group mt-4">
                        <div class="row mt-2">
                            <div class="col-lg-6 col-sm-12">
                                <h4 class="mb-0">Møtested</h4>
                                <label class="form-label">Møtested:</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.meeting_place.id_for_label }}"
                                    value="{{ form.meeting_place.value|default:'' }}"
                                    name="{{ form.meeting_place.name }}"
                                    placeholder="Møtested..."/>
                
                                {% if form.meeting_place.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.meeting_place.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <h4 class="mb-0">Besøkende</h4>
                                <label class="form-label">Forventet antall besøkende:</label>
                                <input type="number"
                                    min="0"
                                    class="form-control form-control-md"
                                    id="{{ form.expected_visitors.id_for_label }}"
                                    value="{{ form.expected_visitors.value|default:'0' }}"
                                    name="{{ form.expected_visitors.name }}"
                                    placeholder="{% trans 'Forventet antall besøkende' %}..."
                                    required/>
                
                                {% if form.expected_visitors.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.expected_visitors.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <label class="form-label">Møtested (Engelsk):</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.meeting_place_en.id_for_label }}"
                                    value="{{ form.meeting_place_en.value|default:'' }}"
                                    name="{{ form.meeting_place_en.name }}"
                                    placeholder="{% trans 'Meeting place (english)' %}..."/>
        
                                {% if form.meeting_place_en.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.meeting_place.errors }}
                                    </div>
                                {% endif %}
                            </div>
        
                            <div class="col-lg-6 col-sm-12">
                                <label class="form-label">Faktisk antall besøkende:</label>
                                <input type="number"
                                    min="0"
                                    class="form-control form-control-md"
                                    id="{{ form.actual_visitors.id_for_label }}"
                                    value="{{ form.actual_visitors.value|default:'' }}"
                                    name="{{ form.actual_visitors.name }}"
                                    placeholder="{% trans 'Faktisk antall besøkende' %}..."/>
        
                                {% if form.actual_visitors.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.actual_visitors.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <h4 class="mt-3">Planleggere</h4>
                    <div class="form-group mt-2">
                        <label class="form-label">Planleggere:</label>
                        <div class="row">
                            <div class="col-lg-6 col-sm-12">
                                <div>
                                    <select multiple id="mainPlannerDialog_plannersSelect" class="form-control">
                                        <option value="MAIN" data-toggle="tooltip" title="Hovedplanlegger" disabled>{{object.responsible}}</option>
                                        {% for planner in object.planners.all %}
                                            <option value="{{planner.pk}}">{{planner}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% if user|has_group:"planners" or user.is_superuser %}
                            <div class="col-lg-6 col-sm-12">
                                <div>
                                    <a href='#' class='shadow-0 btn wb-btn-secondary btn-block mb-2 btn-sm'
                                            d-trigger="triggerAddPlannersDialog">
                                        <i class='fas fa-plus'></i>
                                        Legg til planlegger(e)
                                    </a>
                                </div>
                                <div>
                                    <a href='#' class='shadow-0 btn wb-btn-secondary btn-block btn-sm' id='mainDialog_removePlannerBtn'
                                        d-trigger="removePlanners">
                                        <i class='fas fa-trash'></i>
                                        Fjern valgte planleggere
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-12">
                    <div class="form-group">
                        <label for="{{form.location.id_for_label}}" class="form-label">Lokasjon</label>
                        {{ form.location }}
                    </div>
                    <div id="jsTreeSelects">
                        <div class="mb-2 mt-2">
                            <label for="{{ form.audience.id_for_label }}" class="form-label">
                                <i class="fas fa-users"></i>&nbsp;
                                Målgruppe
                            </label>
                            <div id="audience_jstree_select" class="dialog-popover-left-fix"></div>
                            
                            {% if form.audience.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.audience.errors }}
                            </div>
                            {% endif %}
                        </div>            
                        <div class="mb-2">
                            <label for="{{ form.arrangement_type.id_for_label }}" class="form-label select-label">
                                <i class="fas fa-cog"></i>&nbsp;
                                Arrangementstype
                            </label>
                            <div id="arrangement_type_jstree_select" class="dialog-popover-left-fix"></div>
                            {% if form.arrangement_type.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.arrangement_type.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            <label>
                                <i class="fas fa-cog"></i>&nbsp;
                                Status
                            </label>
                            <div id="status_type_jstree_select" class="dialog-popover-left-fix"></div>
                            {% if form.status_type.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.status_type.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <h4>Skjermvisning</h4>
        
                        <div class="row">
                            <div class="col-lg-4 col-sm-12">
                                <label class="form-label">Vises på skjermen: </label>
                                {{ form.display_layouts }}
                            </div>
                            <div class="col-lg-8 col-sm-12 mt-sm-2 mt-lg-0 mb-2">
                                <div 
                                    class="form-group"
                                    id="display-layout-text-group"
                                    style="display:none;">
                                    
                                    <div>
                                        {{ form.display_text|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {{ form.errors }}

            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix  border-top pt-3">
                <div class="float-end">
                    <a href="#" class="btn wb-btn-secondary btn-lg"
                        d-trigger="close">
                        <i class="fas fa-times"></i>
                        Avbryt / Lukk
                    </a>
                    
                    <a class="btn shadow-0 wb-btn-main" href="#"
                        d-trigger="submit">
                        <i class="fas fa-check"></i>
                        Lagre endringer
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        

        <!-- Timeslots Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_timeslots" role="tabpanel">
            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix">
                <div class="float-end">
                    <a class="btn wb-btn-main"
                        d-trigger="triggerNewTimePlanDialog">
                        Ny tidsplan
                    </a>
                    <a class="btn wb-btn-main"
                        d-trigger="triggerNewSimpleActivityDialog">
                        Ny enkel aktivitet
                    </a>
                </div>
            </div>
            {% endif %}

            <ul class="nav nav-tabs webook-tabs mt-1" role="tablist">
                <li class="nav-item" role="presentation">
                    <a href="#timeslots_tabs_series" class="nav-link active" data-mdb-toggle="tab">
                        Tidsplaner
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="#timeslots_tabs_activities" class="nav-link" data-mdb-toggle="tab">
                        Aktiviteter
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Series Tab -->
                <div class="tab-pane fade show active" id="timeslots_tabs_series"role="tabpanel">
                     <div class="table-responsive">
                        <table class='table'>
                            <thead>
                            </thead>
            
                            <tbody id="seriesTbody">

                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between">
                            <div>
                                Totalt antall repeterende aktiviteter:
                                <span id="seriesTableTotalEntitiesCount">
                                </span>
                            </div>

                            <div class="d-flex justify-content-end">
                                <div class="me-3">
                                    <div style="display:none" id="seriesTableLoadSpinner">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Laster inn data...
                                    </div>

                                </div>

                                <button class="btn wb-btn-secondary" id="seriesTableGoBackOnePageButton">
                                    Forrige
                                </button>
    
                                <div class="d-flex align-content-center">
                                    <input type="number" class="form-control ms-2" min="0" style="width: 6em;" id="seriesTableCurrentPageInput">
                                    <span class="ms-2">/</span>
                                    <span class="ms-2" id="seriesTableMaxPageInput">

                                    </span>
                                </div>
    
                                <button class="ms-2 btn wb-btn-secondary" id="seriesTableGoForwardOnePageButton">
                                    Neste
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Activities/Events Tab -->
                <div class="tab-pane fade" id="timeslots_tabs_activities" role="tabpanel">
                    <div class="table-responsive"  style="max-height:32rem!important; overflow-y: scroll;">
                        <table class="table table-sm interactiveTable"  id="eventsTable">
                            <thead>
                                <tr class="wb-bg-secondary">
                                    <th>
                                        Aktivitet
                                    </th>
                                    <th>
                                        Del av serie?
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="activitiesTbody">
  
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between">
                            <div>
                                Totalt antall aktiviteter:
                                <span id="activitiesTableTotalEntitiesCount">
                                </span>
                            </div>

                            <div class="d-flex justify-content-end">
                                <div class="me-3">
                                    <div style="display:none" id="activitiesTableLoadSpinner">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Laster inn data...
                                    </div>

                                </div>

                                <button class="btn wb-btn-secondary" id="activitiesTableGoBackOnePageButton">
                                    Forrige
                                </button>
    
                                <div class="d-flex align-content-center">
                                    <input type="number" class="form-control ms-2" min="0" style="width: 6em;" id="activitesTableCurrentPageInput">
                                    <span class="ms-2">/</span>
                                    <span class="ms-2" id="activitiesTableMaxPageInput">

                                    </span>
                                </div>
    
                                <button class="ms-2 btn wb-btn-secondary" id="activitiesTableGoForwardOnePageButton">
                                    Neste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_notes" role="tabpanel">

            {% if not object.notes.exists %}
                <div class="alert wb-bg-secondary">
                    <h4 class="text-center">Ingen notater skrevet ennå!</h4>
                    {% if user|has_group:"planners" or user.is_superuser %}
                    <div class="row">
                        <div class="col text-center">
                            <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                            d-trigger="triggerNewNoteDialog">
                            <i class="fas fa-feather"></i>
                            Nytt notat
                        </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% elif user|has_group:"planners" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-main shadow-0 mb-2 float-end" 
                        d-trigger="triggerNewNoteDialog">
                        <i class="fas fa-feather"></i>
                        Nytt notat
                    </a>
                </div>
            {% endif %}

            <div style="overflow-y: scroll; max-height: 30em;">
                {% for note in object.notes.all %}
                <div class="p-3 border rounded-6 shadow-3 mt-2" id="note_{{note.pk}}">
                    {{note.content|safe}}
    
                    <hr>
    
                    <div class="clearfix">
                        <div class="float-start">
                            <div class="float-start">
                                {% if note.has_personal_information %}
                                    <i class="fas fa-shield-alt text-warning h3"></i> <strong>Inneholder <abbr class="me-3" title="Personlig identifiserende informasjon">PII</abbr></strong>
                                {% endif %}
                                <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created|date:'d.m.Y H:i' }}</em>
                            </div>
                        </div>
                        {% if user|has_group:"planners" or user.is_superuser %}
                        <div class="float-end">
                            <a href="#" class="btn wb-btn-main"
                                d-trigger="deleteNote"
                                d-arg-note_pk="{{ note.pk }}">
                                <i class="fas fa-trash"></i>
                            </a>
    
                            <a href="#" class="btn wb-btn-main"
                                d-trigger="triggerUpdateNoteDialog"
                                d-arg-note_pk="{{ note.pk }}">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Files Tab -->
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_files" role="tabpanel">
            {% if arrangement.files.exists %}
                {% if user|has_group:"planners" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-main shadow-0 float-end"
                            d-trigger="triggerUploadFilesToArrangementDialog"
                            href="#">
                        <i class="fas fa-upload"></i>
                        Upload file(s)
                    </a>
                </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Fil</th>
                            </tr>
                        </thead>
        
                        <tbody>
                            {% for file in arrangement.files.all %}
                                <tr>
                                    <td>
                                        {% if user|has_group:"planners" or user.is_superuser %}
                                        <a class="btn wb-btn-secondary btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                            data-mdb-toggle="tooltip"
                                            title="{% trans 'Delete this file' %}"
                                            d-trigger="deleteFile"
                                            d-arg-type_discriminator="arrangement"
                                            d-arg-file_id="{{file.pk}}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                        <a class="btn wb-btn-secondary btn-sm" style="border-radius: 50%!important; padding: 0.7rem;"
                                            data-mdb-toggle="tooltip"
                                            title="{% trans 'Download this file' %}"
                                            href="/media/{{file.file}}" download>
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </td>
                                    <td>{{ file.filename }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="alert wb-bg-secondary">
                        <h4 class="text-center">Ingen filer lastet opp her ennå!</h4>
                        {% if user|has_group:"planners" or user.is_superuser %}
                        <div class="row">
                            <div class="col text-center">
                                <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                                d-trigger="triggerUploadFilesToArrangementDialog"
                                href="#">
                                <i class="fas fa-upload"></i>
                                Last opp
                            </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
        </div>

        <!-- School Related Tab -->
        {% if object.is_school_related %}
        <div class="tab-pane fade" id="arrangementInfoDialog_tabs_school" role="tabpanel">
            <div class="form-group">
                <label for="countySelect">Fylke</label>
                <select name="" id="countySelect" class="form-control">
                    <option value=""
                        {% if object.county is None %}selected{% endif %}>
                        Ingen valgt
                    </option>

                    {% for county in counties %}
                        <option value="{{county.id}}"
                            {% if object.county is not None and object.county.id == county.id %}selected{% endif %}>
                            {{county.name}}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group mt-2">
                <label for="schoolSelect">Skole <em>(Målgruppe: {{ object.audience.name }})</em></label>
                <select name="" id="schoolSelect" class="form-control" style="width: 100%">
                    <option value=""
                        {% if object.school is None %}selected{% endif %}>
                        Ingen valgt
                    </option>

                    {% for school in schools %}
                        <option value="{{school.id}}"
                                {% if object.school is not None and object.school.id == school.id %}selected{% endif %}>
                            {{school.name}} {% if school.city_segment %} - {{school.city_segment.name}} {% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix  border-top pt-3">
                <div class="float-end">
                    <a href="#" class="btn wb-btn-secondary btn-lg"
                        d-trigger="close">
                        <i class="fas fa-times"></i>
                        Avbryt / Lukk
                    </a>
                    
                    <a class="btn shadow-0 wb-btn-main" href="#"
                        d-trigger="submit">
                        <i class="fas fa-check"></i>
                        Lagre endringer
                    </a>
                </div>
            </div>
            {% endif %}

        </div>
        {% endif %}
    </div>
</div>


<script type="module">
    import { JSTreeSelect } from "{% static 'js/jsTreeSelect.js' %}";

    new Dialog({
        managerName: '{{managerName}}',
        dialogId: '{{dialogId}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            console.log("Fetching event series for arrangement", {{ object.id }});

            dialog._methods.loadEventsToTable(
                dialog,
                { pageNumber: 1 }
            );

            dialog._methods.loadSeriesToTable(
                dialog,
                { pageNumber: 1 }
            );

            dialog.getElementById("activitiesTableGoForwardOnePageButton").onclick = () => {
                let currentPageInput = dialog.getElementById("activitesTableCurrentPageInput");
                let currentPage = parseInt(currentPageInput.value);
                dialog._methods.loadEventsToTable(
                    dialog,
                    { pageNumber: currentPage + 1 }
                );
            };

            dialog.getElementById("activitiesTableGoBackOnePageButton").onclick = () => {
                let currentPageInput = dialog.getElementById("activitesTableCurrentPageInput");
                let currentPage = parseInt(currentPageInput.value);
                dialog._methods.loadEventsToTable(
                    dialog,
                    { pageNumber: currentPage - 1 }
                );
            };

            dialog.getElementById("activitesTableCurrentPageInput").onchange = (e) => {
                let currentPage = parseInt(e.target.value);
                dialog._methods.loadEventsToTable(
                    dialog,
                    { pageNumber: currentPage }
                );
            };

            dialog.getElementById("seriesTableGoForwardOnePageButton").onclick = () => {
                let currentPageInput = dialog.getElementById("seriesTableCurrentPageInput");
                let currentPage = parseInt(currentPageInput.value);
                dialog._methods.loadSeriesToTable(
                    dialog,
                    { pageNumber: currentPage + 1 }
                );
            };

            dialog.getElementById("seriesTableGoBackOnePageButton").onclick = () => {
                let currentPageInput = dialog.getElementById("seriesTableCurrentPageInput");
                let currentPage = parseInt(currentPageInput.value);
                dialog._methods.loadSeriesToTable(
                    dialog,
                    { pageNumber: currentPage - 1 }
                );
            };

            dialog.getElementById("seriesTableCurrentPageInput").onchange = (e) => {
                let currentPage = parseInt(e.target.value);
                dialog._methods.loadSeriesToTable(
                    dialog,
                    { pageNumber: currentPage }
                );
            };



            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                dialog.querySelectorAll("input,select").forEach( (inputElement) => inputElement.setAttribute("disabled", "") );
            {% endif %}

            {% if object.is_school_related %}
            $('#schoolSelect').select2({
                dropdownParent: dialog.$dialogElement
            });
            dialog.getElementById("countySelect").addEventListener("change", (e) => {
                fetch("/api/onlinebooking/city_segment/list?county_id=" + e.target.value)
                    .then(a => a.json())
                    .then(a => {
                        dialog.data.citySegmentMap = new Map(
                            a.data.map( (citySegment) => [citySegment.id, citySegment] )
                        );
                    }).then( () => {
                        let audience_id = dialog.data.audienceJsTreeSelect.getSelectedValue() || 0;

                        let url = "/api/onlinebooking/school/list?county_id=" + e.target.value + "&sort_by=name&limit=1000";
                        if (parseInt(audience_id) != {{ audienceGroupId }}) {
                            url += "&audience_id=" + audience_id;
                        }

                        fetch(url)
                        .then(a => a.json())
                        .then(a => {
                            if ($("#schoolSelect").data("select2")) {   
                                $("#schoolSelect").select2("destroy");
                                $("#schoolSelect").empty();
                            }

                            let schoolOptions = [
                                {
                                    id: "",
                                    text: "Ingen valgt",
                                },
                                ...a.data.map((school) => {
                                    let segment = dialog.data.citySegmentMap.get(school.citySegmentId);
                                    return {
                                        id: school.id,
                                        text: segment ? school.name + " - " + segment.name : school.name
                                    }
                                })
                            ]; 

                            setTimeout(function (){ // Has to be delayed to ensure select2 is destroyed. Hrmmph.
                                $('#schoolSelect').select2({
                                    dropdownParent: dialog.$dialogElement,
                                    data: schoolOptions
                                });

                                let $containerEl = $($('#schoolSelect').next(".select2-container"));
                                $containerEl.css("width", "100%");
                                $containerEl.css("display", "block");
                            }, 50);
                        });
                    });
            });
            {% endif %}

            dialog.querySelectorAll("#arrangement-info-dialog-tabs a[data-mdb-toggle='tab']")
                .forEach( (element) => {
                    element.addEventListener('click', (event) => {
                        dialog.data.currentlyActiveTab = event.target.id;
                    })
                } )

            dialog.data.audienceJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#audience_jstree_select'),
                initialSelected: { id: '{{ object.audience.id }}', text: '{{ object.audience.name }}', parent: '{{object.audience.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/audience/tree",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen målgruppe valgt ennå",
                selectFirstTimeButtonText: 'Velg målgruppe',
                changeSelectedValueButtonText: 'målgruppe',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.arrangementTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#arrangement_type_jstree_select'),
                initialSelected: { id: '{{ object.arrangement_type.id }}', text: '{{ object.arrangement_type.name }}', parent: '{{object.arrangement_type.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/arrangementtype/treelist",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen arrangementstype valgt ennå",
                selectFirstTimeButtonText: 'Velg arrangementstype',
                changeSelectedValueButtonText: 'Endre arrangementstype',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.statusTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#status_type_jstree_select'),
                initialSelected: { id: '{{ object.status.id }}', text: '{{ object.status.name }}' },
                treeJsonSrcUrl: "/arrangement/statustype/tree",
                valueSelectedLabelText: ( selected ) => {
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");

                    labelText += selected.text;
                    
                    return labelText;
                },
                noneSelectedLabelText: "Ingen status valgt ennå",
                selectFirstTimeButtonText: 'Velg status',
                changeSelectedValueButtonText: 'Endre status',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            


            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                document.querySelectorAll("#jsTreeSelects button").forEach( (buttonElement) => buttonElement.remove() );
            {% endif %}
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeAllDialogsInThisManagerGroup();
            },
            /* Trigger/Open the update note dialog for the note by notePk */
            triggerUpdateNoteDialog(dialog, { notePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "editNoteDialog", { note_pk: notePk, $parent: dialog.dialogElement });
            },
            triggerNewTimePlanDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newTimePlanDialog", { $parent: dialog.dialogElement });
            },
            triggerNewSimpleActivityDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newSimpleActivityDialog", { $parent: dialog.dialogElement });
            },
            triggerNewNoteDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "newNoteDialog", { $parent: dialog.dialogElement });
            },
            triggerUploadFilesToArrangementDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "uploadFilesToArrangementDialog", { $parent: dialog.dialogElement });
            },
            loadEventsToTable(dialog, { pageNumber } = {}, triggeredByElement) {
                const spinner = dialog.getElementById("activitiesTableLoadSpinner");
                spinner.style.display = "block";

                fetch("/api/arrangement/event/list?arrangement_id={{ object.id }}&page=" + pageNumber + "&limit=10&sort_desc=true")
                    .then(a => a.json())
                    .then(a => {
                        let tbody = dialog.getElementById("activitiesTbody");
                        tbody.innerHTML = "";
                        const currentPageInput = dialog.getElementById("activitesTableCurrentPageInput");
                        currentPageInput.setAttribute("max", a.summary.total_pages);
                        currentPageInput.value = a.summary.page;
                        dialog.getElementById("activitiesTableMaxPageInput").innerHTML = a.summary.total_pages;
                        dialog.getElementById("activitiesTableTotalEntitiesCount").innerHTML = a.summary.total;

                        a.data.forEach(event => {
                            let tr = document.createElement("tr");
                            const startDate = new Date(event.start);
                            const endDate = new Date(event.end);

                            const startDateString = startDate.toLocaleDateString("nb-NO", { year: 'numeric', month: '2-digit', day: '2-digit' });
                            const endDateString = endDate.toLocaleDateString("nb-NO", { year: 'numeric', month: '2-digit', day: '2-digit' });
                            tr.innerHTML = `
                                <td>${event.title} - ${startDateString} til ${endDateString}</td>
                                <td>${event.serieId ? "Ja" : "Nei"}</td>
                            `;
                            tr.onclick = () => {
                                dialog._methods.triggerInspectEvent(dialog, { eventId: event.id });
                            };

                            tbody.appendChild(tr);
                        });

                        spinner.style.display = "none";
                    });
            },
            loadSeriesToTable(dialog, { pageNumber } = {}, triggeredByElement) {
                const spinner = dialog.getElementById("seriesTableLoadSpinner");
                spinner.style.display = "block";

                fetch("/api/arrangement/event_serie/list?arrangement_id={{ object.id }}&page=" + pageNumber + "&limit=5&sort_desc=true&sort_by=pk")
                    .then(a => a.json())
                    .then(a => {
                        let tbody = dialog.getElementById("seriesTbody");
                        tbody.innerHTML = "";
                        const currentPageInput = dialog.getElementById("seriesTableCurrentPageInput");
                        currentPageInput.setAttribute("max", a.summary.total_pages);
                        currentPageInput.value = a.summary.page;

                        dialog.getElementById("seriesTableMaxPageInput").innerHTML = a.summary.total_pages;
                        dialog.getElementById("seriesTableTotalEntitiesCount").innerHTML = a.summary.total;

                        a.data.forEach(eventSerie => {
                            let tr = document.createElement("tr");
                            tr.setAttribute("id", `${eventSerie.id}`);

                            fetch("/api/arrangement/event_serie/files/list?parent_id=" + eventSerie.id)
                                .then(fr => fr.json())
                                .then(filesList => {
                                    console.log("Files for event serie " + eventSerie.id, filesList);

                                    const roomsList = eventSerie.seriePlanManifest.rooms.map(room => room.name).join(", ");
                                    const peopleList = eventSerie.seriePlanManifest.people.map(person => person.name).join(", ");
                                    
                                    let filesBadgeListHtml = "";
                                    for (let i = 0; i < filesList.length; i++) {
                                        const fileObj = filesList[i];
                                        filesBadgeListHtml += `<a href="${fileObj.url}" target="_blank" download class="badge badge-light wb-bg-secondary border border-dark ${i > 0 ? 'ms-2' : ''}">${filesList[i].filename}</a>`;
                                    }

                                    tr.innerHTML = `
                                        <td>
                                            <div class="d-flex justify-content-between">
                                                <h5><span class='badge badge-dark'>${eventSerie.id}</span> ${eventSerie.seriePlanManifest.title} - <em>${eventSerie.seriePlanManifest.scheduleDescription}</em></h5>
                                                
                                                <div>
                                                    <button class="btn wb-btn-main" id="c_${eventSerie.id}_openButton">
                                                        <i class="fas fa-eye"></i>
                                                        Åpne
                                                    </button>

                                                    <button class="btn wb-btn-main" id="c_${eventSerie.id}_deleteButton">
                                                        <i class="fas fa-trash"></i>
                                                        Slett
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="d-flex">
                                                <div>
                                                    <i class="fas fa-star"></i> 
                                                    ${eventSerie.seriePlanManifest.responsible.first_name && eventSerie.seriePlanManifest.responsible.last_name ? 
                                                        eventSerie.seriePlanManifest.responsible.first_name + " " + eventSerie.seriePlanManifest.responsible.last_name : 
                                                        "Ingen ansvarlig"}
                                                </div>

                                                <div class="ms-3">
                                                    <i class="fas fa-users"></i>
                                                    ${eventSerie.seriePlanManifest.audience?.name || "Ingen målgruppe"}
                                                </div>

                                                <div class="ms-3">
                                                    <i class="fas fa-cogs"></i>
                                                    ${eventSerie.seriePlanManifest.arrangement_type?.name || "Ingen arrangement type"}
                                                </div>

                                                <div class="ms-3">
                                                    <i class="fas fa-cogs"></i>
                                                    ${eventSerie.seriePlanManifest.status?.name || "Ingen status"}
                                                </div>
                                            </div>

                                            <div class="d-flex mt-3">
                                                <div class=" border border-1 border-dark p-2">
                                                    <h6>Rom: </h6>
                                                    ${roomsList || "Ingen rom"}
                                                </div>

                                                <div class="ms-3 border border-1 border-dark p-2">
                                                    <h6>Personer: </h6>
                                                    ${peopleList || "Ingen personer"}
                                                </div>

                                                <div class="ms-3 border border-1 border-dark p-2">
                                                    <div class="d-flex">
                                                        <h6>
                                                            Filer
                                                        </h6>

                                                        <a href="#" class="ms-3" id="c_${eventSerie.id}_uploadFilesBtn">
                                                            (<i class='fas fa-upload'></i>&nbsp;Last opp...)
                                                        </a>
                                                    </div>
                                                    
                                                    <div>
                                                        ${filesBadgeListHtml}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3 wb-bg-secondary border border-dark p-2">
                                                <h6 id="c_${eventSerie.id}_showEventsTable" class="wb-bg-secondary mb-0 pt-2 pb-2 ps-1">
                                                    <i class="fas fa-chevron-right" id="c_${eventSerie.id}_showEventsTableButtonIcon"></i>
                                                    Forekomster <small class="text-muted ms-3"><i class='fas fa-info'></i>&nbsp; Trykk for å ekspandere/skjule</small>
                                                </h6>

                                                <div id="c_${eventSerie.id}_events_loader" style="display: none">
                                                    <div class="spinner-border" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    Laster inn data...
                                                </div>

                                                <div id="c_${eventSerie.id}_eventsBody" class="bg-white" style="display: none;">
                                                    <table class="table table-sm table-bordered table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Tittel</th>
                                                                <th>Start</th>
                                                                <th>Slutt</th>
                                                                <th>Valg</th>
                                                            </tr>
                                                        </thead>

                                                        <tbody id="c_${eventSerie.id}_eventsTbody">
                                                            
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </td>
                                    `;

                                    tbody.appendChild(tr);

                                    dialog.getElementById(`c_${eventSerie.id}_openButton`).onclick = () => {
                                        dialog._methods.triggerEditSerie(dialog, { eventSeriePk: eventSerie.id });
                                    };
                                    dialog.getElementById(`c_${eventSerie.id}_deleteButton`).onclick = () => {
                                        dialog._methods.deleteEventSerie(dialog, { eventSeriePk: eventSerie.id });
                                    };
                                    dialog.getElementById(`c_${eventSerie.id}_uploadFilesBtn`).onclick = () => {
                                        dialog._methods.uploadFilesToEventSerie(dialog, { eventSeriePk: eventSerie.id });
                                    };
                                    dialog.getElementById(`c_${eventSerie.id}_showEventsTable`).onclick = () => {
                                        let eventsBody = dialog.getElementById(`c_${eventSerie.id}_eventsBody`);
                                        let eventsTableButtonIcon = dialog.getElementById(`c_${eventSerie.id}_showEventsTableButtonIcon`);
                                        eventsTableButtonIcon.className = eventsBody.style.display === "none" ? "fas fa-chevron-down" : "fas fa-chevron-right";
                                        eventsBody.style.display = eventsBody.style.display === "none" ? "block" : "none";

                                        if (eventsBody.style.display === "none") {
                                            return;
                                        }
                                        
                                        let loader = dialog.getElementById(`c_${eventSerie.id}_events_loader`);
                                        loader.style.display = "block";

                                        fetch("/api/arrangement/event/list?serie_id=" + eventSerie.id)
                                            .then(a => a.json())
                                            .then(a => {
                                                const tbody = dialog.getElementById(`c_${eventSerie.id}_eventsTbody`);
                                                tbody.innerHTML = "";

                                                a.data.forEach(event => {
                                                    let tr = document.createElement("tr");
                                                    const startDate = new Date(event.start);
                                                    const endDate = new Date(event.end);

                                                    const startDateString = startDate.toLocaleDateString("nb-NO", { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                                                    const endDateString = endDate.toLocaleDateString("nb-NO", { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                                                    tr.innerHTML = `
                                                        <td>${event.title}</td>
                                                        <td>${startDateString}</td>
                                                        <td>${endDateString}</td>
                                                        <td>
                                                            <btn href="#" class="btn btn-sm btn-light border border-dark wb-bg-secondary box-shadow-0 shadow-0"
                                                                d-trigger="openEditEvent" d-arg-event_pk="${event.id}">
                                                                Åpne
                                                            </btn>
                                                        </td>
                                                    `;
                                                    tr.onclick = () => {
                                                        dialog._methods.triggerInspectEvent(dialog, { eventId: event.id });
                                                    };

                                                    tbody.appendChild(tr);
                                                });

                                                loader.style.display = "none";
                                            });
                                    };
                                    // ensure we sort, since asynchronous fetches can cause out of order rendering
                                    let rows = tbody.querySelectorAll("tr[id]");
                                    let rowsArray = Array.from(rows);
                                    rowsArray.sort((rowA, rowB) => {
                                        let idA = parseInt(rowA.getAttribute("id"));
                                        let idB = parseInt(rowB.getAttribute("id"));
                                        return idB - idA;
                                    });

                                    tbody.innerHTML = "";
                                    rowsArray.forEach(row => tbody.appendChild(row));
                                }); 
                            });

                            spinner.style.display = "none";
                        })
            },
            deleteNote(dialog, { notePk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Er du sikker på at du ønsker å slette dette notatet?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Slett',
                    cancelButtonText: 'Avbryt',
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/arrangement/note/delete/' + notePk, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{csrf_token}}',
                            }
                        }).then(response => { dialog.getElementById('note_' + notePk).remove(); });
                    }
                });
            },
            uploadFilesToEventSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "uploadFilesToEventSerieDialog", { event_serie_pk: eventSeriePk, $parent: dialog.dialogElement });
            },
            deleteActivity(dialog, { activityPk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Aktiviteten kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let formData = new FormData();
                        formData.append("eventIds", activityPk);
                        formData.append("csrfmiddlewaretoken", "{{CSRF_TOKEN}}")
                        fetch('/arrangement/planner/delete_events/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                "X-CSRFToken": "{{csrf_token}}",
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded"));
                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.reload", { "detail": {
                                    dialog: "mainDialog"
                                }}
                            ))
                        });
                    }
                });
            },
            triggerInspectEvent(dialog, { eventId } = {}, triggeredByElement) {
                document.dispatchEvent(
                    new CustomEvent("cel.renderInspectEventDialog", { "detail": {
                        pk: eventId
                    }}
                ))
            },
            submit(dialog, {} = {}, triggeredByElement) {
                if (!dialog.data.audienceJsTreeSelect.isValid()) {
                    dialog.data.audienceJsTreeSelect.showInvalidFeedback();
                    return false;
                }
                if (!dialog.data.arrangementTypeJsTreeSelect.isValid()) {
                    dialog.data.arrangementTypeJsTreeSelect.showInvalidFeedback();
                    return false;
                }

                let formData = new FormData();
                var $dialog = $('#mainDialog');
                formData.append("name",                 dialog.interior.id_name.value);
                formData.append("name_en",              dialog.interior.id_name_en.value);
                formData.append("audience",             dialog.data.audienceJsTreeSelect.getSelectedValue());
                formData.append("location",             dialog.interior.id_location.value);
                formData.append("arrangement_type",     dialog.data.arrangementTypeJsTreeSelect.getSelectedValue());
                formData.append("ticket_code",          dialog.interior.id_ticket_code.value);
                formData.append("meeting_place",        dialog.interior.id_meeting_place.value);
                formData.append("meeting_place_en",     dialog.interior.id_meeting_place_en.value);
                formData.append("expected_visitors",    dialog.interior.id_expected_visitors.value);
                formData.append("actual_visitors",      dialog.interior.id_actual_visitors.value);
                formData.append("display_text",         dialog.plugins.showIfSelected.isInShowState() ? dialog.interior.id_display_text.value : '');
                formData.append("csrfmiddlewaretoken",  "{{ csrf_token }}");
                formData.append("status",               dialog.data.statusTypeJsTreeSelect.getSelectedValue());

                dialog.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked").forEach(element => {
                    formData.append("display_layouts", element.value);
                });

                {% if object.is_school_related %}
                formData.append("county", dialog.getElementById("countySelect").value || "");
                formData.append("school", dialog.getElementById("schoolSelect").value || "");
                {% endif %}

                dialog.raiseSubmitEvent({
                    dialog: dialog.dialogId,
                    formData: formData,
                });
            },

            triggerEditSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "editEventSerieDialog", { event_serie_pk: eventSeriePk, $parent: dialog.dialogElement });
            },
            triggerCascadeTree(dialog, { eventId } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "cascadeTreeDialog", { $parent: dialog.dialogElement, pk: {{object.pk}} })
            },
            triggerAddPlannersDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "selectPlannersDialog", { $parent: dialog.dialogElement, sendTo: '{{dialogId}}', multiple: true, data: { whenEventName: "addPlanners", arrangementSlug: "{{object.slug}}" } });
            },
            triggerAddPlannerDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementInspector", "addPlannerDialog", { $parent: dialog.dialogElement });
            },
            openEditEvent(dialog, { eventPk } = {}, triggeredByElement) {
                document.dispatchEvent(
                    new CustomEvent("plannerCalendar.inspectEvent", { "detail": {
                        event_pk: eventPk, $parent: dialog.dialogElement
                    }}
                ))
            },
            deleteEvent(dialog, { eventPk } = {}, triggeredByElement) {
                throw Error("Not implemented");
            },
            deleteEventSerie(dialog, { eventSeriePk } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Serien og hendelsene i serien kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch("/arrangement/eventSerie/delete/" + eventSeriePk, {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": "{{csrf_token}}"
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.reload", { "detail": {
                                    dialog: "mainDialog"
                                }}
                            ))
                        });
                    }
                });
            },
            delete(dialog, {} = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Arrangementet og underliggende aktiviteter vil bli fjernet, og kan ikke hentes tilbake.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/arrangement/arrangement/delete/{{ object.slug }}', {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": '{{ csrf_token }}'
                            }
                        }).then(_ => {
                            document.dispatchEvent(new Event("arrangementInspector.close"));    // Close all dialogs on mainPlannerDialog
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                        });
                    }
                });
            },
            deleteFile(dialog, { fileId, typeDiscriminator } = {}, triggeredByElement) {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Filen kan ikke hentes tilbake etter sletting.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let urlToDelete = "/arrangement/arrangement/files/delete/";
                        if (typeDiscriminator !== undefined && typeDiscriminator == "event_serie") {
                            urlToDelete = "/arrangement/eventSerie/files/delete/"
                        }

                        fetch(urlToDelete + fileId, {
                            method: 'DELETE',
                            headers: {
                                "X-CSRFToken": '{{ csrf_token }}'
                            }
                        })
                        .then(_ => {
                            $(triggeredByElement).parent().parent().remove();

                            document.dispatchEvent(
                                new CustomEvent("arrangementInspector.hasBeenUpdated", {"detail": {
                                    dialog: "mainDialog",
                                }})
                            )
                        })
                    }
                });
            },
            removeRoomFromEvent(dialog, { eventPk, roomPk } = {}, triggeredByElement) {
                let formData = new FormData();
                formData.set("event_pk", eventPk);
                formData.set("room_pk", roomPk)

                fetch('/arrangement/planner/remove_room_from_event', {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}"
                    }
                })
                .then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                });
            },
            removePersonFromEvent(dialog, {eventPk, personPk} = {}, triggeredByElement) {
                let formData = new FormData();
                formData.set("event_pk", event_pk);
                formData.set("person_pk", person_pk)

                fetch('/arrangement/planner/remove_person_from_event', {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}"
                    }
                })
                .then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                });
            },
            removePlanners(dialog, {} = {}, triggeredByElement) {
                let planners = dialog.$('#mainPlannerDialog_plannersSelect').val().join(",");
                let formData = new FormData()
                formData.append("planner_ids", planners);
                formData.append("arrangement_slug", "{{arrangement.slug}}")

                fetch('{% url "arrangement:arrangement_remove_planners_form" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": '{{csrf_token}}'
                    }
                }).then(_ => {
                    document.dispatchEvent(
                        new CustomEvent("arrangementInspector.hasBeenUpdated", {'detail': {
                            dialog: "mainDialog",
                        }})
                    )
                })
            },
        },
        data: {
            currentlyActiveTab: "",
        },
        plugins: [
            {
                name: 'showIfSelected',
                pluginClass: DialogShowIfSelectedPlugin,
                args: {
                    checkboxesSelector: "[name='display_layouts']",
                    elementToShowOrHide: ( dialog ) => { return dialog.getElementById('display-layout-text-group'); },
                    showIfAnyOfTheseValuesMap: new Map([
                        {% for display_layout in DISPLAY_LAYOUTS_WITH_REQUISITE_TEXT %}
                            [ "{{ display_layout.id }}", true],
                        {% endfor %}
                    ]),
                },
            },
            {
                name: "syncDataToManager",
                pluginClass: SyncDialogDataToManagerContextPlugin,
            }
        ],
    })
</script>