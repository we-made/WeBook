{% load static i18n %}


<div id="{{dialogId}}" class="{{discriminator}}" title="Planlegg nytt arrangement">
    <div class="dialogBodyWrapper">
        <div class="row">
            <div class="col-6">
                <form id="arrangementInfoForm">
                    <input type="submit" style="display:none;" />

                    <fieldset>
                        <h5 class="header-fonted">
                            <i class="fas fa-clipboard"></i>
                            Informasjon om arrangementet
                        </h5>
                        <div class="form-outline mb-2">
                            <input type="text"
                                class="form-control mb-2"
                                id="{{ form.name.id_for_label }}"
                                value="{{ form.name.value|default:'' }}"
                                name="{{ form.name.name }}"
                                autocomplete="off"
                                required />
                            <label class="form-label" for="{{ form.name.id_for_label }}">🇳🇴 Tittel på norsk</label>
                        </div>
                        {% if form.name.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.name.errors }}
                            </div>
                        {% endif %}

                        <div class="form-outline mb-3">
                            <input type="text"
                                class="form-control form-control-md"
                                id="{{ form.name_en.id_for_label }}"
                                value="{{ form.name_en.value|default:'' }}"
                                name="{{ form.name_en.name }}"
                                autocomplete="off"
                                />
                            <label class="form-label" for="{{ form.name.id_for_label }}">🇬🇧 Tittel på engelsk</label>
                        </div>
                        {% if form.name_en.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.name_en.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2">
                            {{ form.audience }}
                            <label for="" class="form-label select-label"><i class="fas fa-cog"></i>&nbsp; {{ form.audience.label }}</label>
                        </div>
                        {% if form.audience.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.audience.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2">
                            {{ form.location }}
                            <label for="" class="form-label select-label"><i class="fas fa-building"></i>&nbsp; {{ form.location.label }}</label>
                        </div>
                        {% if form.location.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.location.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2">
                            {{ form.arrangement_type }}
                            <label for="" class="form-label select-label"><i class="fas fa-cog"></i>&nbsp; {{ form.arrangement_type.label }}</label>
                        </div>
                        {% if form.arrangement_type.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.arrangement_type.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            {{ form.responsible }}
                            <label for="" class="form-label select-label"><i class="fas fa-user"></i>&nbsp; {{ form.responsible.label }}</label>
                        </div>
                        {% if form.responsible.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.responsible.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2 form-outline">
                            <input type="text"
                                class="form-control"
                                id="{{ form.ticket_code.id_for_label }}"
                                value="{{ form.ticket_code.value|default:'' }}"
                                name="{{ form.ticket_code.name }}"
                                placeholder="{% trans 'Ticket code' %}..."/>
                            <label class="form-label" for="{{ form.ticket_code.id_for_label }}">
                                <i class="fas fa-receipt"></i>&nbsp; Billetkode
                            </label>
                        </div>
                        {% if form.ticket_code.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.ticket_code.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2 form-outline">
                            <input type="text"
                                class="form-control"
                                id="{{ form.meeting_place.id_for_label }}"
                                value="{{ form.meeting_place.value|default:'' }}"
                                name="{{ form.meeting_place.name }}"
                                placeholder="{% trans 'Meeting place' %}..."/>
                            <label class="form-label" for="{{ form.meeting_place.id_for_label }}">
                                <i class="fas fa-building"></i>&nbsp; 🇳🇴&nbsp; Møtested
                            </label>
                        </div>
                        {% if form.meeting_place.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.meeting_place.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2 form-outline">
                            <input type="text"
                                class="form-control"
                                id="{{ form.meeting_place_en.id_for_label }}"
                                value="{{ form.meeting_place_en.value|default:'' }}"
                                name="{{ form.meeting_place_en.name }}"
                                placeholder="{% trans 'Meeting place' %}..."/>
                            <label class="form-label" for="{{ form.meeting_place.id_for_label }}">
                                <i class="fas fa-building"></i>&nbsp; 🇬🇧&nbsp; Møtested
                            </label>
                        </div>
                        {% if form.meeting_place.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.meeting_place.errors }}
                            </div>
                        {% endif %}

                        <div class="mb-2 form-outline">
                            <input type="number"
                                min="0"
                                class="form-control"
                                id="{{ form.expected_visitors.id_for_label }}"
                                value="{{ form.expected_visitors.value|default:'' }}"
                                name="{{ form.expected_visitors.name }}"
                                required />
                            <label for="{{ form.expected_visitors.id_for_label }}" class="form-label">
                                <i class="fas fa-users"></i>&nbsp; Expected visitors
                            </label>
                        </div>
                        {% if form.expected_visitors.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.expected_visitors.errors }}
                            </div>
                        {% endif %}

                        <div class="mt-5 mb-3">
                            <h5 class="header-fonted">
                                <i class="fas fa-tv"></i>
                                Skjerm
                            </h5>
                            <label class="d-block">&nbsp; {% trans "Vises på skjermen:" %}</label>
                            {{form.display_layouts}}
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="col-6">
                <h5 class="header-fonted">
                    <i class="fas fa-clock"></i>
                    Plan
                </h5>

                <div class="alert alert-info small">
                    <h5><i class="fas fa-info-circle"></i></h5>
                    <p>Definer en plan på når og hvor arrangementet inntreffer.</p>

                    <p>Du kan opprette egne tidsplaner, dette er i praksis det samme som en repeterende hendelse i Outlook.</p>

                    Eller så kan du opprette en enkel aktivitet, dette er et frittstående tidspunkt eller hendelse som inntreffer en gang.
                </div>

                <h5 class="mt-3 mb-0">Tidsplaner: </h5>
                <a class="btn btn-md wb-btn-secondary btn-block shadow-0 mb-2" id="createArrangementDialog_createSerie">
                    Ny tidsplan
                </a>

                <div id="timeplansBody"></div>

                <h5 class="mt-3">Enkle aktiviteter: </h5>
                <a class="btn btn-md wb-btn-secondary shadow-0 btn-block mb-2" id="createArrangementDialog_createSimpleActivity">
                    Ny enkel aktivitet
                </a>

                <div id="eventsBody"></div>
            </div>
        </div>

        <div class="clearfix">
            <div class="float-end">
                <a href="#" class="btn wb-btn-secondary btn-lg"
                    d-trigger="close">
                    <i class="fas fa-times"></i>
                    Avbryt
                </a>
                <a class="btn btn-lg shadow-0 wb-btn-main"
                    d-trigger="submit">
                    <i class="fas fa-check"></i>
                    Opprett Arrangement
                </a>
            </div>
        </div>

    </div>
</div>

<script>

    new Dialog({
        managerName: '{{managerName}}',
        dialogId: '{{dialogId}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            dialog.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });
            new mdb.Select(dialog.querySelector('#{{ form.audience.id_for_label }}'), {
                container: "[id='#{{dialogId}}'][class='.{{discriminator}}']"
            });
            new mdb.Select(dialog.querySelector('#{{ form.location.id_for_label }}'), {
                container: "[id='#{{dialogId}}'][class='.{{discriminator}}']"
            });
            new mdb.Select(dialog.querySelector('#{{ form.responsible.id_for_label }}'), {
                container: "[id='#{{dialogId}}'][class='.{{discriminator}}']"
            });
            new mdb.Select(dialog.querySelector('#{{ form.arrangement_type.id_for_label }}'), {
                container: "[id='#{{dialogId}}'][class='.{{discriminator}}']"
            });

            document.addEventListener("{{managerName}}.contextUpdated", (e) => {
                if (e.detail.context.series !== undefined) {
                    dialog.setSeries( { series: e.detail.context.series });
                }
                if (e.detail.context.events !== undefined) {
                    dialog.setEvents( {events: e.detail.context.events });
                }
            });
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeMe();
            },
            validate(dialog, {} = {}, triggeredByElement) {
                let field_elements = dialog.$('#arrangementInfoForm').find("input, select");
                let isInvalid = false;

                for (let i = 0; i < field_elements.length; i++) {
                    if (field_elements[i].checkValidity() === false) {
                        isInvalid = true;
                        break;
                    }
                }

                if (isInvalid) {
                    dialog.$('#arrangementInfoForm').find(':submit').click();
                    return false;
                }

                return true;
            },
            has_plans(dialog, {} = {}, triggeredByElement) { 
                return dialog.data.seriesMap !== undefined && dialog.data.seriesMap.size > 0 || 
                    dialog.data.eventsMap !== undefined && dialog.data.eventsMap.size > 0;
            },
            submit(dialog, {} = {}, triggeredByElement) {
                if (dialog.validate() === false) {
                    return;
                }
                if (dialog.has_plans() === false) {
                    toastr.warning("Plan(er) må opprettes før vi kan opprette arragementet - du må sette tider.");
                    return;
                }

                let formData = new FormData();
                formData.append("name",             dialog.interior.id_name.value);
                formData.append("name_en",          dialog.interior.id_name_en.value);
                formData.append("audience",         dialog.interior.id_audience.value);
                formData.append("location",         dialog.interior.id_location.value);
                formData.append("arrangement_type", dialog.interior.id_arrangement_type.value);
                formData.append("responsible",      dialog.interior.id_responsible.value);
                formData.append("ticket_code",      dialog.interior.id_ticket_code.value);
                formData.append("meeting_place",    dialog.interior.id_meeting_place.value);
                formData.append("meeting_place_en", dialog.interior.id_meeting_place_en.value);
                formData.append("expected_visitors",dialog.interior.id_expected_visitors.value);

                let displayLayouts = [];
                dialog.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked").forEach(element => {
                    formData.append("display_layouts", element.value);
                })

                formData.append("csrf_token",       "{{csrf_token}}");

                let seriesArray = dialog.data.seriesMap !== undefined ? Array.from(dialog.data.seriesMap.values()) : [];
                let eventsArray = dialog.data.eventsMap !== undefined ? Array.from(dialog.data.eventsMap.values()) : [];

                document.dispatchEvent(
                    new CustomEvent("{{managerName}}.submit", { "detail": {
                        dialog: "createArrangementDialog",
                        formData: formData,
                        series: seriesArray,
                        events: eventsArray,
                    }})
                );
            },
            setEvents(dialog, { events } = {}, triggeredByElement) {
                dialog.data.eventsMap = events;
                let tbody = dialog.$('#eventsBody');
                tbody.html("");

                events.forEach(element => {
                    tbody.append(
                        $(`
                        <div class="border border rounded p-3" id='${element._uuid}'>
                            <h5 class="text-muted mb-0">
                                ${element.title}
                            </h5>
                            ${element.start.toLocaleString()} - ${element.end.toLocaleString()}
                            <div class="btn-group shadow-0">
                                <a href="#" class="btn wb-btn-secondary"
                                    data-toggle='tooltip' title='{% trans "Remove this serie from the arrangement to be" %}'
                                    d-trigger='removeSimpleActivity'
                                    d-arg-uuid='${element._uuid}'>
                                    Slett
                                </a>
                                <a href="#" class="btn wb-btn-secondary"
                                    data-toggle='tooltip' title='{% trans "Edit this serie" %}' 
                                    d-trigger='editSimpleActivity'
                                    d-arg-uuid='${element._uuid}'>
                                    Rediger
                                </a>
                            </div>
                        </div>
                        `)
                    )
                })
            },
            setSeries(dialog, { series } = {}, triggeredByElement) {
                dialog.data.seriesMap = series;
        
                let tbody = dialog.$('#timeplansBody');
                tbody.html("")

                console.log(series);

                series.forEach(element => {
                    collisions_html = "";
                    if (element.collisions !== undefined && element.collisions.length > 0) {
                        let collisionsCounter = 0;
                        element.collisions.forEach(collisionRecord => {
                            collisions_html += `
                            <div class="bg-dark border p-2 border-2 border-warning text-white p-3 shadow-3 conflict_summary_${collisionsCounter}">
                                <h5><i class="fas fa-exclamation-triangle"></i>&nbsp; Konflikt på ${collisionRecord.contested_resource_name}</h5>
                                <div class="row">
                                    <div class="col-5">
                                        <div class="">
                                            <div class="fw-bolder">${collisionRecord.event_a_title}</div>
                                            <h6>${collisionRecord.event_a_start} - ${collisionRecord.event_a_end}</h6>
                                        </div>
                                    </div>
                                    <div class="col-2">
                                        <h3 class=" text-center"><i class="fas fa-arrow-right"></i></h3>
                                    </div>
                                    <div class="col-5">
                                        <div class="">
                                            <div class="fw-bolder">${collisionRecord.event_b_title}</div>
                                            <h6>${collisionRecord.event_b_start} - ${collisionRecord.event_b_end}</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix">
                                    <a href="#" class="btn wb-btn-secondary shadow-0"
                                        onclick='createArrangementDialog__breakOutEvent("${element._uuid}", ${collisionsCounter})'><i class='fas fa-code-branch'></i>&nbsp; Løs konflikt
                                    </a>
                                </div>
                            </div>
                            `;
                            collisionsCounter++;
                        })
                    }

                    tbody.append(
                        $(`
                                <div class="rounded border p-3 ps-4 pe-4" id='${element._uuid}'>
                                    <h5 class="mb-0 text-muted">${element.time.title}</h5>
                                    <h6 class="mb-0"><i class="fas fa-clock"></i> ${element.time.start} - ${element.time.end} </h6>
                                    <h6><i class="fas fa-redo"></i> ${element.friendlyDesc}</h6>

                                    <div class="btn-group shadow-0 mb-2">
                                        <a href="#" class="btn wb-btn-secondary"
                                            data-toggle='tooltip' title='{% trans "Remove this serie from the arrangement to be" %}' 
                                            d-trigger='removeSerie'
                                            d-arg-uuid='${element._uuid}'>
                                            <i class="fas fa-trash"></i>&nbsp; Slett tidsplan
                                        </a>
                                        <a href="#" class="btn wb-btn-secondary"
                                            data-toggle='tooltip' title='{% trans "Edit this serie" %}' 
                                            d-trigger='editSerie'
                                            d-arg-uuid='"${element._uuid}"'>
                                            <i class="fas fa-edit"></i>&nbsp; Rediger tidsplan
                                        </a>
                                    </div>
                                    <div class="accordion" id="accordion_series_${element._uuid}">
                                        <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOne">
                                            <a
                                            class="accordion-button text-muted collapsed"
                                            type="button"
                                            data-mdb-toggle="collapse"
                                            data-mdb-target="#collisionsCollapse_${element._uuid}"
                                            aria-expanded="true"
                                            aria-controls="collisionsCollapse_${element._uuid}"
                                            >
                                            <span class="bg-danger rounded-pill text-white p-1" id='${element._uuid}_collisionCounter'>${element.collisions.length}</span>
                                            <i class="fas fa-exclamation-triangle ms-2"></i>&nbsp; Kollisjoner
                                        </a>
                                        </h2>
                                        <div id="collisionsCollapse_${element._uuid}" class="accordion-collapse collapse" aria-labelledby="headingOne" data-mdb-parent="#accordion_series_${element._uuid}">
                                            <div class="accordion-body">
                                                <div class="alert alert-danger small">
                                                    <strong>OBS: </strong> kollisjoner som ikke blir <abbr title="Bryt ut kollisjoner til enkle aktiviteter og løs kollisjonen">brutt ut</abbr> og løst vil ikke bli opprettet
                                                    når arrangementet opprettes.
                                                </div>
                                                ${collisions_html}
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                        `)
                    )
                });
            },
            removeSerie(dialog, { uuid } = {}, triggeredByElement) {
                dialog.$(`#${uuid}`).remove();
                dialog.data.seriesMap.delete(uuid);
            },
            removeSimpleActivity(dialog, { uuid } = {}, triggeredByElement) {
                dialog.$(`#${uuid}`).remove();
                dialog.data.eventsMap.delete(uuid);
            },
            editSimpleActivity(dialog, { uuid } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementCreator", "newSimpleActivityDialog", { event_uuid: uuid });
            },
            breakOutEvent(dialog, { serieUuid, collisionIndex } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementCreator", "breakOutActivityDialog", { 
                    serie: seriesMap.get(serieUuid), 
                    collision_index: collisionIndex,
                });
            },
            editSerie(dialog, { uuid } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("arrangementCreator", "newTimePlanDialog", { serie_uuid: uuid });
            },
        },
        data: {
            seriesMap: new Map(),
            eventsMap: new Map(),
        },
    });
</script>
