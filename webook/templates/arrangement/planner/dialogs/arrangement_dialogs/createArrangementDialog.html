{% load static i18n %}


<div id="createArrangementDialog"
     title="{% trans 'Create Arrangement' %}">

    <div class='p-2 border border-1'  style="background-color: white; color: white!important;">
        <fieldset>
            <table class="table table-sm">
                <tbody>
                    <tr>
                        <td>
                            <strong>Navn:</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.name.id_for_label }}" 
                                value="{{ form.name.value|default:'' }}"
                                name="{{ form.name.name }}"
                                autocomplete="off"
                                placeholder="{% trans 'Name of the arrangement' %}..."/>

                            {% if form.name.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.name.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <strong>MÃ¥lgruppe:</strong>
                            {{ form.audience }}
    
                            {% if form.audience.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.audience.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan="3">
                            <strong>Lokasjon</strong>
                            {{ form.location }}

                            {% if form.location.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.location.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan='2'>
                            <strong>Arrangementstype:</strong>
                            {{ form.arrangement_type }}
                            
                            {% if form.arrangement_type.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.arrangement_type.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan='2'>
                            <strong>Hovedplanlegger:</strong>

                            {{ form.responsible }}

                            {% if form.responsible.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.responsible.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <strong>Tidspunkter:</strong>
                            
                            <a href="#" class="text-primary">Nytt tidspunkt</a>
                            |
                            <a href="#" id="createArrangementDialog_createSerie" class="text-primary">Nytt repeterende tidspunkt</a>

                            <table class="table-sm table">
                                <tbody id="seriesTbody">
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan='3'>
                            <button class=" btn btn-sm shadow-0 btn-success btn-block"
                                    type="button"
                                    onclick="createArrangementDialog_submit()">
                                Opprett Arrangement
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>
</div>

<script>

    var seriesMap;

    $(document).ready(function () {
        document.addEventListener("{{managerName}}.contextUpdated", (e) => {
            setSeries(e.detail.context.series);
        })
    })

    function createArrangementDialog_submit() {
        var formData = new FormData();
        formData.append("name",             $('#id_name').val());
        formData.append("audience",         $('#id_audience').val());
        formData.append("location",         $('#id_location').val());
        formData.append("arrangement_type", $('#id_arrangement_type').val());
        formData.append("starts",           $('#id_starts').val());
        formData.append("ends",             $('#id_ends').val());
        formData.append("responsible",      $('#id_responsible').val()); // <--- TODO: CHeck this for validity
        formData.append("csrf_token",       "{{csrf_token}}");
        var seriesArray = Array.from(seriesMap.values());

        document.dispatchEvent(
            new CustomEvent("{{managerName}}.submit", { "detail": {
                dialog: "createArrangementDialog",
                formData: formData,
                series: seriesArray,
            }})
        );
    }

    function setSeries(series) {
        seriesMap = new Map();

        var tbody = $('#seriesTbody');
        tbody.html("")

        series.forEach(element => {
            var uuid = crypto.randomUUID();
            seriesMap.set(uuid, element);
            
            tbody.append(
                $(`<tr id='${uuid}'> <td> ${element.time.title} --  ${element.pattern.pattern_type} (${element.pattern.pattern_routine}) - ${element.time.start} - ${element.time.end} </td> <td> <button class='btn btn-sm btn-danger shadow-0' data-toggle='tooltip' title='{% trans "Remove this serie from the arrangement to be" %}' onclick='createArrangementDialog_removeSerie(${uuid})'><i class='fas fa-trash'></i></button> </td> </tr>`)
            )
        });
    }

    function createArrangementDialog_removeSerie(uuid) {
        $('#' + uuid).remove();
        seriesMap.delete(uuid);
    }

</script>