{% load static i18n %}


<div id="createArrangementDialog" class="uiDialog"
     title="<span class='badge badge-success'><i class='fas fa-plus'></i></span>&nbsp; Planlegg nytt arrangement">

    <div class="dialogBodyWrapper">
        <fieldset>
            <table class="table table-sm">
                <tbody>
                    <tr>
                        <td>
                            <strong>Navn:</strong>
                            <input type="text"
                                class="form-control mb-2"
                                id="{{ form.name.id_for_label }}" 
                                value="{{ form.name.value|default:'' }}"
                                name="{{ form.name.name }}"
                                autocomplete="off"
                                placeholder="{% trans 'Name of the arrangement' %}..."/>

                            {% if form.name.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.name.errors }}
                                </div>
                            {% endif %}

                            <strong>Navn <em>(engelsk)</em>:</strong>
                            <input type="text"
                                class="form-control"
                                id="{{ form.name_en.id_for_label }}" 
                                value="{{ form.name_en.value|default:'' }}"
                                name="{{ form.name_en.name }}"
                                autocomplete="off"
                                placeholder="{% trans 'Name of the arrangement in english' %}..."/>

                            {% if form.name_en.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.name_en.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <strong>Målgruppe:</strong>
                            {{ form.audience }}
    
                            {% if form.audience.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.audience.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan="3">
                            <strong>Lokasjon</strong>
                            {{ form.location }}

                            {% if form.location.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.location.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan='2'>
                            <strong>Arrangementstype:</strong>
                            {{ form.arrangement_type }}
                            
                            {% if form.arrangement_type.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.arrangement_type.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan='2'>
                            <strong>Hovedplanlegger:</strong>

                            {{ form.responsible }}

                            {% if form.responsible.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.responsible.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2">
                            <strong>Billetkode</strong>

                            <div class="input-group flex-nowrap">
                                <span class="input-group-text">
                                    <i class="fas fa-receipt"></i>
                                </span>
                                <input type="text"
                                    class="form-control"
                                    id="{{ form.ticket_code.id_for_label }}" 
                                    value="{{ form.ticket_code.value|default:'' }}"
                                    name="{{ form.ticket_code.name }}"
                                    placeholder="{% trans 'Ticket code' %}..."/>
                            </div>

                            {% if form.ticket_code.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.ticket_code.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2">
                            <strong>Møtested</strong>

                            <div class="input-group flex-nowrap">
                                <span class="input-group-text">
                                    <i class="fas fa-building"></i>
                                </span>
                                <input type="text"
                                    class="form-control"
                                    id="{{ form.meeting_place.id_for_label }}" 
                                    value="{{ form.meeting_place.value|default:'' }}"
                                    name="{{ form.meeting_place.name }}"
                                    placeholder="{% trans 'Meeting place' %}..."/>
                            </div>
                            <div id="textExample1" class="form-text">
                                <i class="fas fa-exclamation-circle"></i>&nbsp;
                                Vil overskrive sted/rom vist på skjermer.
                            </div>

                            {% if form.meeting_place.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.meeting_place.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2">
                            <strong>Expected amount of visitors</strong>

                            <div class="input-group flex-nowrap">
                                <span class="input-group-text">
                                    <i class="fas fa-users"></i>
                                </span>
                                <input type="number"
                                    min="0"
                                    class="form-control"
                                    id="{{ form.expected_visitors.id_for_label }}" 
                                    value="{{ form.expected_visitors.value|default:'' }}"
                                    name="{{ form.expected_visitors.name }}" />
                            </div>

                            {% if form.expected_visitors.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.expected_visitors.errors }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <div class="row mt-4">
                                <div class="col-6">
                                    <button class="playfulButton playfulButton-green" id="createArrangementDialog_createSimpleActivity">
                                        <div class="icon"><i class="fas fa-plus"></i></div>
                                        Ny enkel aktivitet
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="playfulButton  playfulButton-green" id="createArrangementDialog_createSerie">
                                        <div class="icon"><i class="fas fa-plus"></i></div>
                                        Nytt repeterende tidspunkt
                                    </button>
                                </div>
                            </div>

                            <table class="table-sm table">
                                <tbody id="seriesTbody">
                                </tbody>
                            </table>

                            <table class="table-sm table">
                                <tbody id="eventsTbody">
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan='3'>
                            <button class=" btn btn-sm shadow-0 btn-success btn-block"
                                    type="button"
                                    onclick="createArrangementDialog_submit()">
                                Opprett Arrangement
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>
</div>

<script>

    var seriesMap;
    var eventsMap;

    $(document).ready(function () {
        document.addEventListener("{{managerName}}.contextUpdated", (e) => {
            if (e.detail.context.series !== undefined) {
                setSeries(e.detail.context.series);
            }
            if (e.detail.context.events !== undefined) {
                setEvents(e.detail.context.events);
            }
        })
    })

    function createArrangementDialog_submit() {
        var formData = new FormData();
        formData.append("name",             $('#id_name').val());
        formData.append("audience",         $('#id_audience').val());
        formData.append("location",         $('#id_location').val());
        formData.append("arrangement_type", $('#id_arrangement_type').val());
        formData.append("starts",           $('#id_starts').val());
        formData.append("ends",             $('#id_ends').val());
        formData.append("responsible",      $('#id_responsible').val());
        formData.append("ticket_code",      $('#id_ticket_code').val());
        formData.append("meeting_place",    $('#id_meeting_place').val());
        formData.append("expected_visitors",$('#id_expected_visitors').val());
        formData.append("csrf_token",       "{{csrf_token}}");

        var seriesArray = seriesMap !== undefined ? Array.from(seriesMap.values()) : [];
        var eventsArray = eventsMap !== undefined ? Array.from(eventsMap.values()) : [];

        document.dispatchEvent(
            new CustomEvent("{{managerName}}.submit", { "detail": {
                dialog: "createArrangementDialog",
                formData: formData,
                series: seriesArray,
                events: eventsArray,
            }})
        );
    }

    function setEvents(events) {
        eventsMap = new Map();

        var tbody = $('#eventsTbody');
        tbody.html("");

        events.forEach(element => {
            var uuid = crypto.randomUUID();
            eventsMap.set(uuid, element);
            console.log(element)
            tbody.append(
                $(`<tr id='${uuid}'> <td> ${element.title} (${element.start} - ${element.end}) </td> </tr>`)
            )
        })
    } 

    function setSeries(series) {
        seriesMap = new Map();

        var tbody = $('#seriesTbody');
        tbody.html("")

        series.forEach(element => {
            var uuid = crypto.randomUUID();
            seriesMap.set(uuid, element);
            
            tbody.append(
                $(`<tr id='${uuid}'> <td> ${element.time.title} --  ${element.pattern.pattern_type} (${element.pattern.pattern_routine}) - ${element.time.start} - ${element.time.end} </td> <td> <button class='btn btn-sm btn-danger shadow-0' data-toggle='tooltip' title='{% trans "Remove this serie from the arrangement to be" %}' onclick='createArrangementDialog_removeSerie("${uuid}")'><i class='fas fa-trash'></i></button> </td> </tr>`)
            )
        });
    }

    function createArrangementDialog_removeSerie(uuid) {
        console.log("remove serie")
        $('#' + uuid).remove();
        seriesMap.delete(uuid);
    }

</script>