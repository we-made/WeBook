{% load crispy_forms_tags %}
{% load static i18n %}

<div class="{{discriminator}}" id="{{dialogId}}" title="Bestill tjeneste(r)">
    <div class="mt-4"></div>

    <div class="mt-3 shadow-0 p-3 rounded-6">
        <div class="d-flex" style="justify-content: space-between;">
            <div class="d-flex" style="align-items: center;">
                <h2>
                    <i class="fas fa-calendar text-muted"></i>
                </h2>
                <div class="ms-4">
                    <h4 class="mb-0">{{EVENT}}</h4>
                    <h6 class="text-muted">30.01.2023 09:00 - 07.02.2023 15:00</h6>
                </div>
            </div>

            <div class="d-flex" style="align-items: center;">
                <h2>
                    <!-- <i class="fas fa-flask text-muted"></i> -->
                </h2>
                <div class="ms-4">
                    <!-- <h4 class="mb-0">{{EVENT.arrangement.title}}</h4> -->
                    <h6 class="text-muted"><i class="fas fa-star"></i> Ola Nordmann</h6>
                </div>
            </div>
        </div>
    </div>

    <div class="" v-if="page == 0">
        <div class="d-flex" style="align-items: flex-end; justify-content: space-between;">
            <h5>Velg tjenester</h5>
            <input type="search" name="" id="" class="form-control w-25">
        </div>

        <table class="table">
            <tbody>
                <tr v-for="service in services">
                    <td> <input type="checkbox" :value="service" v-model="selectedServices" name="" :id="'check_' + service.id"> </td>
                    <td> <label :for="'check_' + service.id">[[ service.name ]]</label> </td>
                </tr>
            </tbody>
        </table>

        <nav aria-label="Table pagination or navigation" class="clearfix">
            <ul class="pagination float-end">
                <li class="page-item" :class="{ disabled: page == 1 }"><a class="page-link" href="javascript:void(0)" @click.stop="page--">Forrige</a></li>
                <li class="page-item" :class="{ active: thisPage == page }" v-for="thisPage in totalPages"><a class="page-link" href="#">{{thisPage}}</a></li>
                <li class="page-item" :class="{ disabled: page == totalPages }"><a class="page-link" href="javascript:void(0)" @click.stop="page++">Neste</a></li>
            </ul>
        </nav>

        <div class="clearfix mt-2">
            <div class="float-end">
                <button class="btn wb-btn-secondary">
                    Avbryt
                </button>
                <button class="btn wb-btn-main ms-2" @click="page++">
                    Neste
                </button>
            </div>
        </div> 
    </div>
    <div v-else>
        <div class="alert alert-info wb-bg-secondary text-dark d-flex" style="justify-content: space-between; align-items: center;">
            <h3 class="mb-0">
                <i class="fas fa-info"></i>
            </h3>
            <h6 class="ms-2">Fyll ut kommentarfeltene for tjenesten hvor det er nødvendig. Tjenestekoordinatorene vil kunne se innholdet i disse fritekstfeltene.
                Du kan også bruke pre-etablerte konfigurasjoner for å auto-utfylle fritekst feltet med en mal.
            </h6>
        </div>

        <table class="table">
            <tbody>
                <tr v-for="service in selectedServices">
                    <td>
                        <div class="d-flex" style="align-items:flex-end; justify-content: space-between;">
                            <h4>[[service.name]]</h4>
                            <div class="form-group w-25">
                                <label for="" class="w-100"><i class="fas fa-cog"></i>&nbsp; Benytt en prekonfigurasjoner <em cless="float-end">(Valgfritt)</em></label>
                                <select class="form-control">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="">Kommentar</label>
                            <textarea name="" id="" cols="30" rows="3" class="form-control" v-model="service.freetext"></textarea>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="clearfix mt-3">
            <div class="float-end">
                <button class="btn wb-btn-secondary">
                    Avbryt
                </button>
                <button class="btn wb-btn-secondary ms-2" @click="page--">
                    Tilbake
                </button>
                <button class="btn wb-btn-main ms-2" @click="save()">
                    Plasser bestilling
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import TableComponent from "{% static 'vue-components/table.js' %}";

    new Dialog({
        managerName: '{{managerName}}',
        dialogId: '{{dialogId}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            dialog.data.vueApp = Vue.createApp({
                components: {
                    TableComponent
                },
                data() {
                    return {
                        event: '',
                        page: 0,
                        pageSize: 20,
                        selectedServices: [],
                        services: []
                    }
                },
                computed: {
                    totalPages() {
                        if (this.services.length)
                            return Math.ceil(this.services.length / this.pageSize)
                        else return 0;
                    },
                },
                methods: {
                    async getServices() {
                        let services = await fetch('/arrangement/service/json/list', {
                            method: 'GET',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                            }
                        }).then(response => response.json());
                        return services.filter(x => x.isArchived === false);
                    },
                    async save(dialog, {} = {}, triggeredByElement) {
                        this.selectedServices.forEach((service) => {
                            let formData = new FormData();
                            formData.append("event_id", '{{EVENT.pk}}');    
                            formData.append("service_id", service.id);
                            formData.append("freetext_comment", service.freetext);

                            fetch('/arrangement/planner/dialogs/order_service/{{EVENT.pk}}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    "X-CSRFToken": "{{csrf_token}}"
                                }
                            }).then(response => response.json());
                        });

                                document.dispatchEvent(
                                    new CustomEvent(`eventInspector.submit`, {
                                        "detail": { dialog: "{{dialogId}}" }
                                    })
                                );
                    }
                },
                delimiters: ['[[',']]'],
                async mounted() {
                    this.services = await this.getServices();
                }
            });

            dialog.data.vueApp.mount('#{{ dialogId }}');
        },
        methods: {

        },
        data: {},
    })
</script>