<div id="{{dialogId}}" class="{{discriminator}}"
    title="{% if mode == 'serie' %}Bestill rom{% else %}Bestill rom for '{{event.title}}'{% endif %}">
    <div>
        {% if mode == "serie" %}
        <div class="alert alert-danger">
            <strong>Merk: </strong> du bestiller rom for hele serien.
        </div>
        {% endif %}

        <div class="mb-5">
            <h5>Aktiver presets</h5>

            {% for preset in room_presets %}
                <a href="#" class="btn wb-btn-secondary shadow-0"
                    d-arg-room_ids="{{preset.room_ids}}"
                    d-trigger="activateRoomIds">
                    {{preset.name}}
                </a>
            {% endfor %}

            <h5 class="mt-3">Eller velg rom manuelt</h5>
            <div class="row">
                <div class="col-3">
                  <div class="nav flex-column nav-tabs text-center"
                    id="tabs-tab"
                    role="tablist"
                    aria-orientation="vertical">

                    {% for location in locations %}
                        <a class="nav-link {% if forloop.counter == 1 %} active {% endif %}"
                        id="tabs-{{location.slug}}-tab"
                        data-mdb-toggle="tab"
                        href="#tabs-{{location.slug}}"
                        role="tab"
                        aria-controls="v-tabs-home"
                        aria-selected="true">
                            {{location.name}}
                        </a>
                    {% endfor %}
                  </div>
                </div>
              
                <div class="col-9">
                  <div class="tab-content" id="v-tabs-tabContent">
                      {% for location in locations %}
                        <div
                            class="tab-pane {% if forloop.counter == 1 %} show active {% endif %} fade"
                            id="tabs-{{location.slug}}"
                            role="tabpanel"
                            aria-labelledby="tabs-{{location.slug}}-tab">

                            <table class="table table-sm table-striped mt-2" id="{{location.slug}}_roomsTable">
                                <thead>
                                    <tr>
                                        <th>Rom</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for room in location.rooms.all %}
                                        <tr>
                                            <td> 
                                                {{room.is_selected}}
                                                {% if room.is_selected %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray" checked/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% else %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray"/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                      {% endfor %}
                  </div>
                </div>
            </div>
    </div>
    <div class="clearfix">
        <div class="float-end">
            <a href="#" class="btn wb-btn-secondary btn-lg"
                d-trigger="close">
                <i class="fas fa-times"></i>
                Avbryt
            </a>

            <a class="btn wb-btn-main shadow-0" type="button" d-trigger="order">
                <i class="fas fa-check"></i>&nbsp; Legg til valgte rom
            </a>
        </div>
    </div>
</div>

<script>
    new Dialog({
        dialogId: '{{dialogId}}',
        managerName: '{{managerName}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            dialog.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });

            {% for location in locations %}
            dialog.$('#{{location.slug}}_roomsTable').DataTable().destroy();
            dialog.$('#{{location.slug}}_roomsTable').DataTable();
            {% endfor %}

            /*
            Set up a listener that listens to rooms being selected and deselected by the checkboxes in the dialog.
            When selected these rooms will be added to the selectedRoomsMap, when deselected they will be removed from the map
            This is necessary due to datatables wiping its elements when you search or paginate, so we want to persist our memory 
            of these ids/rooms beyond the scope and whims of the datatable.
            */
            dialog.$("input[type=checkbox][name=orderRoomDialog__checkboxArray]").change((event) => {
                if (event.currentTarget.checked === true)
                    dialog.data.selectedRoomsMap.set(event.currentTarget.value, event.currentTarget.getAttribute("room_name"));
                else
                    dialog.data.selectedRoomsMap.delete(event.currentTarget.value);
            });
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeMe();
            },
            /* Get all rooms that have been selected by checkbox in the order room dialog */
            getSelectedRoomIds(dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.data.selectedRoomsMap, 
                    ([name, value]) => ({id: name, text: value})
                );
            },
            /* Uncheck all checkboxes in the order room dialog */
            uncheckAll(dialog, {} = {}, triggeredByElement) {
                [...dialog.$("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked")]
                    .forEach((checkboxElement) => { checkboxElement.removeAttribute("checked"); });
            },        
            /* Takes an array of room ids and checks their corresponding checkboxes in the room selector */
            activateRoomIds(dialog, {roomIds} = {}, triggeredByElement) {
                dialog.uncheckAll();
                roomIds.split(",").forEach((roomId) => {
                    dialog.$("input[type=checkbox][name=orderRoomDialog__checkboxArray][value='" + roomId + "']")
                            .attr("checked", true).change();
                });
            },
            {% if mode == 'serie' %}
            order(dialog, {} = {}, triggeredByElement) {
                let formData = new FormData();
                formData.set("room_ids", dialog.getSelectedRoomIds()
                                        .map( x => x.id )
                                        .join(","));
                formData.set("serie_guid", "{{serie_guid}}");
            
                dialog.$('#roomsTable').DataTable().destroy();

                dialog.raiseSubmitEvent({
                    mode: "serie",
                    formData: formData,
                    csrf_token: "{{csrf_token}}",
                });
            },
            {% else %}
            order(dialog, {} = {}, triggeredByElement) {
                let formData = new FormData();
                let room_ids = dialog.getSelectedRoomIds();

                formData.set("room_ids", room_ids.map( x => x.id ).join(","));
                formData.set("event_pk", "{{event.pk}}");

                let room_name_map = new Map();
                room_ids.forEach(element => {
                    room_name_map.set(element.id, element.text);
                });
                
                dialog.$('#roomsTable').DataTable().destroy();

                dialog.raiseSubmitEvent({
                    mode: "event",
                    formData: formData,
                    csrf_token: "{{csrf_token}}",
                    room_name_map: room_name_map
                });
            },
            {% endif %}
        },
        data: {
            selectedRoomsMap: new Map(),
        },
    });
</script>