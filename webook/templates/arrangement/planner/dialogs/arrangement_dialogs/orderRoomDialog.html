<div id="{{dialog}}" title="{% if mode == 'serie' %}Bestill rom{% else %}Bestill rom for '{{event.title}}'{% endif %}">
    <div class='bg-white p-2 border border-1'>
        {% if mode == "serie" %}
        <div class="alert alert-danger">
            <strong>Merk: </strong> du bestiller rom for hele serien.
        </div>
        {% endif %}

        <div class="input-group mb-2">
            <span class="input-group-text">
                <i class="fas fa-search"></i>
            </span>
            <input type="search" name="" placeholder="SÃ¸k..." class="form-control" id="datatable-search-input">
        </div>

        {% for preset in room_presets %}
        <div class="bg-success btn p-2 text-white rounded-5 mb-2"
            data-mdb-togggle="tooltip" title="Select all rooms in this preset"
            rooms="{{preset.room_ids}}"
            onclick="orderRoomDialog__activateRoomIds(this.getAttribute('rooms'))">
            {{preset.name}}
        </div>

        {% endfor %}

        <table class="table table-sm" id="roomsTable">
            <thead>
                <tr>
                    <th>Velg</th>
                </tr>
            </thead>
            <tbody>
                {% for location in locations %}
                    <tr>
                        <td> 
                            <span class="mb-0 fw-bold"> {{location.name}} </span> 

                            <table class="table-sm table-bordered table-striped">
                                {% for room in location.rooms.all %}
                                <tr>
                                    {% if room.is_selected %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                            room_name="{{room}}" name="orderRoomDialog__checkboxArray" checked/>
                                        <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                    </div>
                                    {% else %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                            room_name="{{room}}" name="orderRoomDialog__checkboxArray"/>
                                        <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                    </div>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </table>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="clearfix">
            <button class="btn btn-sm btn-success float-end shadow-0" type="button" onclick="orderRoomDialog__order()">
                Bestill valgte rom
            </button>
        </div>
    </div>
</div>

<script>
    function orderRoomDialog__getSelectedRoomIds() {
        var checkboxes = $("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked");
        var roomIds = []
        for (let i = 0; i < checkboxes.length; i++) {
            roomIds.push( {  id: checkboxes[i].value, text: checkboxes[i].getAttribute("room_name") })
        }
        return roomIds;
    }

    function orderRoomDialog__activateRoomIds(roomIds) {
        console.log(roomIds)
        var checkboxes = $("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked");
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].removeAttribute("checked");
        }

        var ids = roomIds.split(",");
        for (let i = 0; i < ids.length; i++) {
            var correspondingCheckbox = $("input[type=checkbox][name=orderRoomDialog__checkboxArray][value='" + ids[i] + "']");
            console.log("set", correspondingCheckbox)
            correspondingCheckbox.attr("checked", true);
        }
    }

    $(document).ready(function () {
        const dt = $('#roomsTable').DataTable( { 
            paging: false,
            dom: 't',
        } ); 

        document.getElementById('datatable-search-input').addEventListener('input', (e) => {
           dt.search(e.target.value).draw();
        })
    })

    {% if mode == 'serie' %}
    function orderRoomDialog__order() {
        var data = new FormData();
        data.set("room_ids", orderRoomDialog__getSelectedRoomIds()
                                .map( x => x.id )
                                .join(","));
        data.set("serie_guid", "{{serie_guid}}");
        
        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'serie',
                formData: data,
                csrf_token: '{{csrf_token}}',
            }})
        );
    }
    {% else %}
    function orderRoomDialog__order() {
        var data = new FormData();
        var room_ids = orderRoomDialog__getSelectedRoomIds();

        data.set("room_ids", room_ids.map( x => x.id ).join(","));
        data.set("event_pk", "{{event.pk}}");

        room_name_map = new Map();
        room_ids.forEach(element => {
            room_name_map.set(element.id, element.text);
        })
        
        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'event',
                formData: data,
                csrf_token: '{{csrf_token}}',
                room_name_map: room_name_map,
            }})
        );
    }
    {% endif %}
</script>