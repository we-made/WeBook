<div id="{{dialog}}" title="{% if mode == 'serie' %}Bestill rom{% else %}Bestill rom for '{{event.title}}'{% endif %}">
    <div>
        {% if mode == "serie" %}
        <div class="alert alert-danger">
            <strong>Merk: </strong> du bestiller rom for hele serien.
        </div>
        {% endif %}

        <div class="mb-5">
            <h5>Aktiver presets</h5>

            {% for preset in room_presets %}
                <a href="#" class="btn btn-info text-white shadow-0"
                    rooms="{{preset.room_ids}}"
                    onclick="orderRoomDialog__activateRoomIds(this.getAttribute('rooms'))">
                    {{preset.name}}
                </a>
            {% endfor %}

            <h5 class="mt-3">Eller velg rom manuelt</h5>
            <div class="row">
                <div class="col-3">
                  <div class="nav flex-column nav-tabs text-center"
                    id="tabs-tab"
                    role="tablist"
                    aria-orientation="vertical">

                    {% for location in locations %}
                        {% if forloop.counter == 1 %}
                        <a class="nav-link active"
                        id="tabs-{{location.slug}}-tab"
                        data-mdb-toggle="tab"
                        href="#tabs-{{location.slug}}"
                        role="tab"
                        aria-controls="v-tabs-home"
                        aria-selected="true">
                            {{location.name}}
                        </a>
                        {% else %}
                        <a class="nav-link"
                        id="tabs-{{location.slug}}-tab"
                        data-mdb-toggle="tab"
                        href="#tabs-{{location.slug}}"
                        role="tab"
                        aria-controls="v-tabs-home"
                        aria-selected="true">
                            {{location.name}}
                        </a>
                        {% endif %}
                    {% endfor %}
                  </div>
                </div>
              
                <div class="col-9">
                  <div class="tab-content" id="v-tabs-tabContent">
                      {% for location in locations %}
                        <div
                            class="tab-pane {% if forloop.counter == 1 %} show active {% endif %} fade"
                            id="tabs-{{location.slug}}"
                            role="tabpanel"
                            aria-labelledby="tabs-{{location.slug}}-tab">

                            <table class="table table-sm table-striped mt-2" id="{{location.slug}}_roomsTable">
                                <thead>
                                    <tr>
                                        <th>Rom</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for room in location.rooms.all %}
                                        <tr>
                                            <td> 

                                                {% if room.is_selected %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray" checked/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% else %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray"/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                      {% endfor %}
                  </div>
                </div>
            </div>
    </div>
    <div class="clearfix">
        <a class="btn btn-success text-white float-end shadow-0" type="button" onclick="orderRoomDialog__order()">
            Lagre seleksjon
        </a>
    </div>
</div>

<script>
    function orderRoomDialog__getSelectedRoomIds() {
        var checkboxes = $("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked");
        var roomIds = []
        for (let i = 0; i < checkboxes.length; i++) {
            roomIds.push( {  id: checkboxes[i].value, text: checkboxes[i].getAttribute("room_name") })
        }
        return roomIds;
    }

    function orderRoomDialog__activateRoomIds(roomIds) {
        var checkboxes = $("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked");
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].removeAttribute("checked");
        }

        var ids = roomIds.split(",");
        for (let i = 0; i < ids.length; i++) {
            var correspondingCheckbox = $("input[type=checkbox][name=orderRoomDialog__checkboxArray][value='" + ids[i] + "']");
            console.log("set", correspondingCheckbox)
            correspondingCheckbox.attr("checked", true);
        }
    }

    $(document).ready(function () {
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });

        {% for location in locations %}
            $('#{{location.slug}}_roomsTable').DataTable().destroy();
            $('#{{location.slug}}_roomsTable').DataTable();
        {% endfor %}
    })

    {% if mode == 'serie' %}
    function orderRoomDialog__order() {
        var data = new FormData();
        data.set("room_ids", orderRoomDialog__getSelectedRoomIds()
                                .map( x => x.id )
                                .join(","));
        data.set("serie_guid", "{{serie_guid}}");
    

        $('#roomsTable').DataTable().destroy();

        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'serie',
                formData: data,
                csrf_token: '{{csrf_token}}',
            }})
        );
    }
    {% else %}
    function orderRoomDialog__order() {
        var data = new FormData();
        var room_ids = orderRoomDialog__getSelectedRoomIds();

        data.set("room_ids", room_ids.map( x => x.id ).join(","));
        data.set("event_pk", "{{event.pk}}");

        room_name_map = new Map();
        room_ids.forEach(element => {
            room_name_map.set(element.id, element.text);
        })
        
        $('#roomsTable').DataTable().destroy();

        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'event',
                formData: data,
                csrf_token: '{{csrf_token}}',
                room_name_map: room_name_map,
            }})
        );
    }
    {% endif %}
</script>