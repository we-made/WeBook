<div id="{{dialog}}" title="{% if mode == 'serie' %}Bestill rom{% else %}Bestill rom for '{{event.title}}'{% endif %}">
    <div>
        {% if mode == "serie" %}
        <div class="alert alert-danger">
            <strong>Merk: </strong> du bestiller rom for hele serien.
        </div>
        {% endif %}

        <div class="mb-5">
            <h5>Aktiver presets</h5>

            {% for preset in room_presets %}
                <a href="#" class="btn btn-info text-white shadow-0"
                    rooms="{{preset.room_ids}}"
                    onclick="orderRoomDialog__activateRoomIds(this.getAttribute('rooms'))">
                    {{preset.name}}
                </a>
            {% endfor %}

            <h5 class="mt-3">Eller velg rom manuelt</h5>
            <div class="row">
                <div class="col-3">
                  <div class="nav flex-column nav-tabs text-center"
                    id="tabs-tab"
                    role="tablist"
                    aria-orientation="vertical">

                    {% for location in locations %}
                        <a class="nav-link {% if forloop.counter == 1 %} active {% endif %}"
                        id="tabs-{{location.slug}}-tab"
                        data-mdb-toggle="tab"
                        href="#tabs-{{location.slug}}"
                        role="tab"
                        aria-controls="v-tabs-home"
                        aria-selected="true">
                            {{location.name}}
                        </a>
                    {% endfor %}
                  </div>
                </div>
              
                <div class="col-9">
                  <div class="tab-content" id="v-tabs-tabContent">
                      {% for location in locations %}
                        <div
                            class="tab-pane {% if forloop.counter == 1 %} show active {% endif %} fade"
                            id="tabs-{{location.slug}}"
                            role="tabpanel"
                            aria-labelledby="tabs-{{location.slug}}-tab">

                            <table class="table table-sm table-striped mt-2" id="{{location.slug}}_roomsTable">
                                <thead>
                                    <tr>
                                        <th>Rom</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for room in location.rooms.all %}
                                        <tr>
                                            <td> 
                                                {{room.is_selected}}
                                                {% if room.is_selected %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray" checked/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% else %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="{{room.id}}" id="personCheck__{{room.slug}}" 
                                                        room_name="{{room}}" name="orderRoomDialog__checkboxArray"/>
                                                    <label class="form-check-label" for="personCheck__{{room.slug}}">{{room}}</label>
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                      {% endfor %}
                  </div>
                </div>
            </div>
    </div>
    <div class="clearfix">
        <a class="btn btn-success text-white float-end shadow-0" type="button" onclick="orderRoomDialog__order()">
            <i class="fas fa-check"></i>&nbsp; Legg til valgte rom
        </a>
    </div>
</div>

<script>
    $(document).ready(function () {
        listenToRoomsBeingSelectedByCheckbox();
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });

        {% for location in locations %}
            $('#{{location.slug}}_roomsTable').DataTable().destroy();
            $('#{{location.slug}}_roomsTable').DataTable();
        {% endfor %}
    })

    var selectedRoomsMap = new Map();

    /*
    Set up a listener that listens to rooms being selected and deselected by the checkboxes in the dialog.
    When selected these rooms will be added to the selectedRoomsMap, when deselected they will be removed from the map
    This is necessary due to datatables wiping its elements when you search or paginate, so we want to persist our memory 
    of these ids/rooms beyond the scope and whims of the datatable.
    */
    function listenToRoomsBeingSelectedByCheckbox() {
        $("input[type=checkbox][name=orderRoomDialog__checkboxArray]").change((event) => {
            if (event.currentTarget.checked === true)
                selectedRoomsMap.set(event.currentTarget.value, event.currentTarget.getAttribute("room_name"));
            else
                selectedRoomsMap.delete(event.currentTarget.value);
        });
    }

    /*
    Get all rooms that have been selected by checkbox in the order room dialog
    */
    function orderRoomDialog__getSelectedRoomIds() {
        return Array.from(selectedRoomsMap, 
            ([name, value]) => ({id: name, text: value})
        );
    }

    /*
    Uncheck all checkboxes in the order room dialog
    */
    function orderRoomDialog__uncheckAll() {
        [...$("input[type=checkbox][name=orderRoomDialog__checkboxArray]:checked")]
            .forEach((checkboxElement) => { checkboxElement.removeAttribute("checked"); });
    }

    /*
    Takes an array of room ids and checks their corresponding checkboxes in the room selector
    */
    function orderRoomDialog__activateRoomIds(roomIds) {
        orderRoomDialog__uncheckAll();

        roomIds.split(",").forEach((roomId) => {
            $("input[type=checkbox][name=orderRoomDialog__checkboxArray][value='" + roomId + "']")
                .attr("checked", true).change();
        });
    }

    {% if mode == 'serie' %}
    function orderRoomDialog__order() {
        var data = new FormData();
        data.set("room_ids", orderRoomDialog__getSelectedRoomIds()
                                .map( x => x.id )
                                .join(","));
        data.set("serie_guid", "{{serie_guid}}");
    

        $('#roomsTable').DataTable().destroy();

        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'serie',
                formData: data,
                csrf_token: '{{csrf_token}}',
            }})
        );
    }
    {% else %}
    function orderRoomDialog__order() {
        var data = new FormData();
        var room_ids = orderRoomDialog__getSelectedRoomIds();

        data.set("room_ids", room_ids.map( x => x.id ).join(","));
        data.set("event_pk", "{{event.pk}}");

        room_name_map = new Map();
        room_ids.forEach(element => {
            room_name_map.set(element.id, element.text);
        })
        
        $('#roomsTable').DataTable().destroy();

        document.dispatchEvent(
            new CustomEvent("{{manager}}.submit", { "detail": {
                dialog: "{{dialog}}",
                mode: 'event',
                formData: data,
                csrf_token: '{{csrf_token}}',
                room_name_map: room_name_map,
            }})
        );
    }
    {% endif %}
</script>