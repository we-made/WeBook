<div id="{{dialogId}}" class="{{discriminator}}"
    title="{% if mode == 'serie' %}Bestill person{% else %}Bestill person for '{{event.title}}'{% endif %}">
    
    <div class="clearfix">
        <div class="float-start">
            <h5 class="fw-bold">Velg personer</h5>
        </div>
        <div id="rail" class="float-end stepper-rail"></div>
    </div>
    <hr>

    <div>
        {% if mode == 'serie' %}
        <div class="alert alert-danger">
            <strong>Merk: </strong> du bestiller personer for hele serien.
        </div>
        {% endif %}

        <table class="table table-sm " id="orderPersonDialog__table">
            <thead>
                <tr>
                    <th>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for person in people %}
                    <tr>
                        <td>
                            {% if person.is_selected %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{person.pk}}" person_name="{{person.full_name}}" id="personCheck__{{person.slug}}" 
                                    name="orderPersonDialog__checkboxArray" checked/>
                                <label class="form-check-label" for="personCheck__{{person.slug}}">{{person}}</label>
                            </div>
                            {% else %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{person.pk}}"  person_name="{{person.full_name}}" id="personCheck__{{person.slug}}" 
                                    name="orderPersonDialog__checkboxArray"/>
                                <label class="form-check-label" for="personCheck__{{person.slug}}">{{person}}</label>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="small text-right">
            {{people|length}} elementer
        </div>

        <div class="clearfix">
            <div class="float-end">
                <a href="#" class="btn wb-btn-secondary btn-lg"
                    d-trigger="close">
                    <i class="fas fa-times"></i>
                    Avbryt
                </a>

                <a class="btn wb-btn-main shadow-0 float-end" d-trigger="order"><i class="fas fa-check"></i>&nbsp; Legg til valgte personer</a>
            </div>
        </div>
    </div>
</div>

<script>
    new Dialog({
        dialogId: '{{dialogId}}',
        managerName: '{{managerName}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            dialog.$("#orderPersonDialog__table").DataTable();
            dialog.$("input[type=checkbox][name=orderPersonDialog__checkboxArray]").change((event) => {
                if (event.currentTarget.checked === true) {
                    dialog.data.selectedPeopleMap.set(event.currentTarget.value, event.currentTarget.getAttribute("person_name"));
                }
                else {
                    dialog.data.selectedPeopleMap.delete(event.currentTarget.value);
                }
            })
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeMe();
            },
            getSelectedPeopleIds(dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.data.selectedPeopleMap,
                    ([name, value]) => ({id: name, text: value})
                );
            },
            {% if mode == 'serie' %}
            order(dialog, {} = {}, triggeredByElement) {
                let data = new FormData();
                data.set("people_ids", dialog.getSelectedPeopleIds()
                                    .map( x => x.id )
                                    .join(","));
                data.set("serie_guid", "{{serie_guid}}");

                dialog.raiseSubmitEvent({
                    mode: "serie",
                    formData: data,
                    csrf_token: "{{csrf_token}}",
                });
            },
            {% else %}
            order(dialog, {} = {}, triggeredByElement) {
                let formData = new FormData();
                let people_ids = dialog.getSelectedPeopleIds();

                formData.set("people_ids", people_ids.map( x => x.id ).join(","));
                formData.set("event_pk", "{{event.pk}}");

                let people_name_map = new Map();
                people_ids.forEach(element => {
                    people_name_map.set(element.id, element.text)
                });

                dialog.raiseSubmitEvent({
                    mode: "event",
                    formData: formData,
                    csrf_token: "{{csrf_token}}",
                    people_name_map: people_name_map
                });
            }
            {% endif %}
        },
        data: {
            selectedPeopleMap: new Map()
        }
    });
</script>