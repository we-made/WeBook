{% load static i18n %}

<div id="{{dialogId}}" title="Ny tidsplan" class="{{discriminator}}">

    <div class="clearfix">
        <div class="float-start">
            <h6 id="title">
                {{object}}
                {% if object.pk %}
                    Rediger {{object.title}}
                {% else %}
                    Definer tidsplan
                {% endif %}
            </h6>
            <h5 class="fw-bold">
                <i class="fas fa-calendar-plus"></i>&nbsp; Tidsplan
            </h5>
        </div>
        <div id="stepper" class="float-end stepper-rail"></div>
    </div>

    <hr>

    <div class="stepper" style="max-height: 600px; height: 500px; overflow: scroll; overflow-y: visible;">
        <div id="step-1">
            <input type="hidden" name="uuid" id="serie_uuid">
            <form id="headMockForm">
                <input type="submit" style="display:none;" />
                <div class="mb-2">
                    <div class="form-group">
                        <label class="form-label" for="serie_title">Tittel på norsk</label>
                        <input type="text" id="serie_title" class="form-control form-control-lg" 
                            required/>
                    </div>    
                    <div class="form-group">
                        <label class="form-label" for="serie_title_en">Tittel på engelsk</label>
                        <input type="text" id="serie_title_en" class="form-control form-control-lg" />
                    </div>
                </div>
    
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-group timepicker-inline-24 mb-2" id="serie_start_picker">
                            <label class="form-label" for="serie_start">Start <small>(<i>HH:mm</i>)</small></label>
                            <input type="text" class="form-control form-control-lg" id="serie_start" 
                                required/>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group timepicker-inline-24 mb-2" id="serie_end_picker">
                            <label class="form-label" for="serie_end">Slutt <small>(<i>HH:mm</i>)</small></label>
                            <input type="text" class="form-control form-control-lg" id="serie_end" 
                                required/>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-2">
                    <label class="form-label" for="serie_ticket_code">Billetkode</label>
                    <input type="text" id="serie_ticket_code" class="form-control form-control-lg" />
                </div>        
                <div class="form-group mb-2">
                    <label class="form-label" for="serie_expected_visitors">Forventet besøkende</label>
                    <input type="text" id="serie_expected_visitors" class="form-control form-control-lg" 
                        required/>
                </div>
            </form>
        </div>

        <div id="step-2">
            <fieldset>
                <h5>Mønster</h5>
                <div class="row">
                    <div class="col-3 border-end border-1">
                        <form id="patternMockForm">
                            <input type="submit" style="display:none;" />
                            <div>
                                <input type="radio" name="pattern" id="radio_pattern_daily" value="1" checked required/><label>&nbsp; Daglig</label>
                            </div>
                            <div>
                                <input type="radio" name="pattern" id="radio_pattern_weekly" value="2"/><label>&nbsp; Ukentlig</label>
                            </div>
                            <div>
                                <input type="radio" name="pattern" id="radio_pattern_monthly" value="3"/><label>&nbsp; Månedlig</label>
                            </div>
                            <div>
                                <input type="radio" name="pattern" id="radio_pattern_yearly" value="4"/><label>&nbsp; Årlig</label>
                            </div>
                        </form>
                    </div>
                    <div class="col-9">
                        <div id="patternRoute_daily">
                            <div>
                                <input type="radio" name="pattern_daily_subroute" id="radio_pattern_daily_every_x_day_subroute" value="0" required/>
                                <label>Hver <input type="number" min="1"  id="every_x_day__interval" required /> dag</label>
                            </div>
                            
                            <div>
                                <input type="radio" name="pattern_daily_subroute" id="radio_pattern_daily_every_weekday_subroute" value="1"/>
                                <label>Hver ukedag</label>
                            </div>
                        </div>
    
                        <div id="patternRoute_weekly" style="display: none;">
                            <div><label>Skjer hver <input type="number" min="1" id="week_interval" name="repeat_every_x_week" style="width: 40px" required/> uke på:</label></div>
                            <span id="day_checkbox_wrapper">
                                <input type="checkbox" id="monday"> <label>Mandag</label>
                                <input type="checkbox" id="tuesday"> <label>Tirsdag</label>
                                <input type="checkbox" id="wednesday"> <label>Onsdag</label>
                                <input type="checkbox" id="thursday"> <label>Torsdag</label>
                                <input type="checkbox" id="friday"> <label>Fredag</label>
                                <input type="checkbox" id="saturday"> <label>Lørdag</label>
                                <input type="checkbox" id="sunday"> <label>Søndag</label>
                            </span>
                        </div>
    
                        <div id="patternRoute_monthly" style="display: none;">
                            <div>
                                <input type="radio" name="pattern_monthly_subroute" id="every_x_day_every_y_month__day_of_month_radio" value="0" required /> 
                                Dag <input type="number" min="1" required id="every_x_day_every_y_month__day_of_month" style="width: 40px"> hver <input type="number" required min="1" id="every_x_day_every_y_month__month_interval" style="width: 40px;"> måned
                            </div>
                            <div>
                                <input type="radio" name="pattern_monthly_subroute" id="every_x_day_every_y_month__month_interval_radio" value="1" /> Den
                                <select id="every_dynamic_date_of_month__arbitrator" class="newTimePlanDialog_select" required>
                                </select>
                                <select id="every_dynamic_date_of_month__weekday" class="newTimePlanDialog_select" required>
                                </select>
                                hver <input type="number" required min="1" id="every_dynamic_date_of_month__month_interval" style="width:40px"> måned
                            </div>
                        </div>
    
                        <div id="patternRoute_yearly" style="display: none;">
                            <div>
                                Skjer hvert <input type="number" min="1" required id="pattern_yearly_const__year_interval" style="width: 40px" /> år
                            </div>
                            <div>
                                <input type="radio" name="pattern_yearly_subroute" id="every_x_datemonth_of_year_radio" value="0" required> Dato:
                                <input type="number" min="1" required id="every_x_of_month__date" style="width: 40px" />
                                <select id="every_x_of_month__month" class="newTimePlanDialog_select" required>
                                </select>
                            </div>
    
                            <div>
                                <input type="radio" name="pattern_yearly_subroute" id="every_x_dynamic_day_in_month_radio" value="1"> Hver:
                                <select id="every_arbitrary_weekday_in_month__arbitrator" class="newTimePlanDialog_select" required>
                                </select>
                                <select id="every_arbitrary_weekday_in_month__weekday" class="newTimePlanDialog_select" required>
                                </select>
                                i
                                <select id="every_arbitrary_weekday_in_month__month" class="newTimePlanDialog_select" required>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset class="mt-2">
                <h5>Område</h5>
                <div class="row">
                    <div class="col-3">
                        <label>Startdato</label>
                        <input type="date" id="area_start_date" required>
                    </div>
                    <div class="col-9" id="area_methods_wrapper">
                        <div>
                            <input type="radio" id="radio_timeAreaMethod_stopWithin" name="timeAreaMethod" value="1">
                            Stopp innen: <input type="date" id="area_stopWithin" required>
                        </div>
    
                        <div>
                            <input type="radio" id="radio_timeAreaMethod_stopAfterXInstances" name="timeAreaMethod" value="2">
                            <fieldset>
                                Stopp etter: <input type="number" min="1" id="area_stopAfterXInstances" required /> instanser
                            </fieldset>
                        </div>
    
                        <div>
                            <input type="radio" id="radio_timeAreaMethod_noStopDate" name="timeAreaMethod" value="3">
                            Ingen sluttdato
                            | Projiser <input type="number" min="1" required style="width:50px" id="area_noStop_projectXMonths"> måneder inn i fremtiden
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <div id="step-3">
            <div class="input-group input-group-lg">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" name="" placeholder="Søk etter personer..." class="form-control form-control-lg"></input>

                <button class="btn wb-btn-secondary border"
                        d-trigger="triggerAddPeople">
                    <i class="fas fa-folder"></i>
                </button>
            </div>

            <div id="peopleChips" class="mb-2 mt-3"></div>

            <div class="input-group input-group-lg mt-5">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" name="" placeholder="Søk etter rom..." class="form-control form-control-lg"></input>

                <button class="btn wb-btn-secondary border"
                        d-trigger="triggerAddRooms">
                    <i class="fas fa-folder"></i>
                </button>
            </div>

            <div id="roomChips" class="mb-2 mt-3"></div>
        </div>
        <div id="step-4">
            <div class="alert alert-info small">
                <h6><i class="fas fa-info-circle"></i>&nbsp; Opprigg og nedrigg blir opprettet som egne hendelser før og etter aktiviteten.</h6>
                Du trenger ikke å definere tider om du ikke ønsker å opprigg eller nedrigg aktiviteter. Du kan velge å bare definere tider for den ene eller andre, eller begge to.
                Det vil bare opprettes aktiviteter der hvor tider for rigging er definert. Så om du f.eks taster inn verdier for Fra-Til for opprigg, men lar nedrigg være blankt, så vil opprigg aktivitet opprettes med alle 
                hendelser som resulteres av denne tidsplanen men ikke nedrigg aktiviteter.
            </div>

            <table class="table table-sm">
                <thead></thead>
                <tbody>
                    <tr>
                        <th colspan="3" class="fw-bold">Opprigg:</th>
                    </tr>
                    <tr>
                        <td>
                            Fra
                            <div class="form-outline">
                                <input type="time" id="buffer_before_start" class="form-control form-control-lg" />
                            </div>
                        </td>
                        <td>
                            Til
                            <div class="form-outline">
                                <input type="time" id="buffer_before_end" class="form-control form-control-lg" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th colspan="3" class="fw-bold">Nedrigg:</th>
                    </tr>
                    <tr>
                        <td>
                            Fra
                            <div class="form-outline">
                                <input type="time" id="buffer_after_start" class="form-control form-control-lg" />
                            </div>
                        </td>
                        <td>
                            Til
                            <div class="form-outline">
                                <input type="time" id="buffer_after_end" class="form-control form-control-lg" />
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table> 
        </div>
        <div id="step-5">
            <i class="fas fa-tv"></i>&nbsp; Vises på
            {% for choice_id, choice_label in form.display_layouts_serie_planner.field.choices %}
            <div class="badge border fw-light border-body text-muted rounded-pill clickable-badge p-3 m-1">
                <input type="checkbox" value="{{choice_id}}" name="display_layouts_serie_planner" id="id_display_layouts_serie_planner_{{choice_id}}" />
                <label for="id_display_layouts_serie_planner_{{choice_id}}">&nbsp;{{choice_label}}</label>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="clearfix mt-3">
        <div class="float-start">
            <button class="btn wb-btn-blank btn-lg text-muted"
                    id="cancel"
                    d-trigger="close">
                <i class="fas fa-times"></i>&nbsp;
                Avbryt
            </button>
        </div>

        <div class="float-end">
            <a href="#" class="btn wb-btn-secondary btn-lg" id="back">
                Tilbake
            </a>

            <a href="#" class="btn wb-btn-main btn-lg" id="next">
                Neste
            </a>

            <a class="btn wb-btn-main btn-lg" d-trigger="submit" type="button" id="finish"
                    style="display: none;">
                Lagre
            </a>
        </div>

    </div>
</div>

<script type="module">
    import { SeriesUtil } from "{% static 'modules/planner/seriesutil.js' %}";
    import { SelectComponent, MonthSelectComponent, YearSelectComponent } from "{% static 'modules/planner/selectcomponent.js' %}";
    import { ExtendedTimepicker } from "{% static 'js/timepickerExtended.js' %}";

    class DayOfWeekSelectComponent extends SelectComponent {
        constructor (element_id) {
            let options = new Map([
                ["1", 'mandag'],
                ["2", 'tirsdag'],
                ["3", 'onsdag'],
                ["4", 'torsdag'],
                ["5", 'fredag'],
                ["6", 'lørdag'],
                ["7", 'søndag'],
            ]);

            super(element_id, options)

            this.insert_options();
        }
    }
    
    class ArbitratorSelectComponent extends SelectComponent {
        constructor (element_id) {

            let options = new Map([
                ["0", 'første'],
                ["1", 'andre'],
                ["2", 'tredje'],
                ["3", 'fjerde'],
                ["4", 'siste']
            ]);

            super(element_id, options);

            this.insert_options();
        }
    }

    class ValidatorFunctions {
        static __watchInputForValidityChange (element) {
            element.classList.add("border-danger");

            element.addEventListener("change", (event) => {
                if (event.target.checkValidity() === true) {
                    event.target.classList.remove("border-danger");
                    event.target.classList.add("border-success");

                    let alert = document.getElementsByClassName('form_alert')[0];
                    alert.classList.remove('text-danger');
                    alert.classList.add("text-success");
                    alert.innerHTML = "<i class='fas fa-check'></i> " + alert.innerText;

                    setTimeout(function () {
                        event.target.classList.remove("border-success");
                        alert.remove();
                    }, 1000);
                }
            })
            }

        /* Validate the "head" component of the form */
        static validate_head(dialogElement) {
            debugger; 
            let field_elements = [
                dialogElement.querySelector('#serie_title'),
                dialogElement.querySelector('#serie_start'),
                dialogElement.querySelector('#serie_end'),
                dialogElement.querySelector('#serie_expected_visitors'),
            ];

            let isInvalid = false;

            for (let i = 0; i < field_elements.length; i++) {
                if (field_elements[i].checkValidity() === false) {
                    isInvalid = true;
                    break;
                }
            }

            if (isInvalid) {
                $(dialogElement).find('#headMockForm :submit').click();
                return false;
            }

            return true;
        }

        static validate_pattern_radio(dialogElement) {
            let radio = dialogElement.querySelector('input[name="pattern"]');

            if (radio.checkValidity() === false) {
                $(dialogElement).find('#patternMockForm :submit').click();
                return false;
            }

            return true;
        }

        static validate_pattern_route(pattern, dialogElement) {
            let is_valid = true;

            let subpattern_radio = dialogElement.querySelector("input[name='" + pattern.sub_routed_by + "']")
            if (subpattern_radio !== null) {
                if (subpattern_radio.checkValidity() === false) {
                    let alert_div = document.createElement('div');
                    alert_div.innerHTML = "<div class='alert alert-danger form_alert'>Vennligst velg et mønster, ved bruk av avhukningsboksene over.</div>"
                    pattern.route_fieldset.append(alert_div)
                    ValidatorFunctions.__watchInputForValidityChange(subpattern_radio);

                    return false;
                }
            }

            let active_inputs = pattern.route_fieldset[0].querySelectorAll("input:not(:disabled):not([type='radio']):not([type='submit']), select:not(:disabled)");
            for(let i = 0; i < active_inputs.length; i++) {
                let input = active_inputs[i];
                if (input.checkValidity() === false) {
                    let alertText = document.createElement('div');
                    alertText.innerHTML = "<span class='text-danger form_alert'>" + input.validationMessage + "</span>";
                    ValidatorFunctions.__watchInputForValidityChange(input);

                    input.parentNode.parentNode.appendChild(alertText);

                    return false;
                }
            }

            if (pattern.name === "weekly") {
                let checkedBoxes = dialogElement.querySelectorAll("#day_checkbox_wrapper input[type='checkbox']:checked");
                if (checkedBoxes.length === 0) {
                    let alert_div = document.createElement('div');
                    alert_div.innerHTML = "<div class='alert alert-danger form_alert'>Vennligst huk av for en eller flere dager.</div>"
                    pattern.route_fieldset.append(alert_div);

                    return false;
                }
            }

            return true;
        }

        static validate_recurrence_area (dialogElement) {
            let area_start_date_el = dialogElement.querySelector('#area_start_date');

            if (area_start_date_el.checkValidity() === false) {
                ValidatorFunctions.__watchInputForValidityChange(area_start_date_el);
                let alertText = document.createElement('div');
                alertText.innerHTML = "<span class='text-danger form_alert'>" + area_start_date_el.validationMessage + "</span>";
                area_start_date_el.parentNode.appendChild(alertText);

                return false;
            }

            let timearea_method_radio = dialogElement.querySelector("input[name='timeAreaMethod']");
            if (timearea_method_radio !== null) {
                if (timearea_method_radio.checkValidity() === false) {
                    ValidatorFunctions.__watchInputForValidityChange(timearea_method_radio);

                    let alert_div = document.createElement('div');
                    alert_div.innerHTML = "<div class='alert alert-danger form_alert'>Vennligst velg en metode for regelmessighet</div>"
                    pattern.route_fieldset.append(alert_div);
                    timearea_method_radio.parentNode.parentNode.appendChild(alert_div)

                    return false;
                }
            }

            let activeInputs = dialogElement.querySelectorAll("#area_methods_wrapper input:not(:disabled):not([type='radio']):not([type='submit']), select:not(:disabled)");
            
            for(let i = 0; i < activeInputs.length; i++) {
                let input = activeInputs[i];
                if (input.checkValidity() === false) {
                    let alertText = document.createElement('div');
                    alertText.innerHTML = "<span class='text-danger form_alert'>" + input.validationMessage + "</span>";
                    ValidatorFunctions.__watchInputForValidityChange(input);

                    input.parentNode.parentNode.appendChild(alertText);

                    return false;
                }
            }

            return true;
        }
    }

    var _dialog = new Dialog({
        dialogId: '{{ dialogId }}',
        managerName: '{{ managerName }}',
        discriminator: '{{ discriminator }}',
        postInit: function (dialog) {

            if (dialog.interior.serie_uuid.value !== undefined) {
                dialog.getElementById('title').innerText = "Rediger " + dialog.interior.serie_title.value;
            }

            document.addEventListener("{{managerName}}.d2_peopleSelected", (e) => {
                dialog.data.peopleNameMap = e.detail.context.people_name_map;
                dialog.setPeople({ people: e.detail.context.people });
                dialog.$("#peopleCounter").text(dialog.$("#peopleChips").children().length);
            })
            document.addEventListener("{{managerName}}.d2_roomsSelected", (e) => {
                dialog.data.roomsNameMap = e.detail.context.room_name_map;
                dialog.setRooms({ rooms: e.detail.context.rooms });
                dialog.$("#roomsCounter").text(dialog.$("#roomChips").children().length);
            })
            
            new DayOfWeekSelectComponent(dialog.getElementById('every_arbitrary_weekday_in_month__weekday'));
            new MonthSelectComponent(dialog.getElementById('every_arbitrary_weekday_in_month__month'));
            new MonthSelectComponent(dialog.getElementById('every_x_of_month__month'));
            new DayOfWeekSelectComponent(dialog.getElementById('every_dynamic_date_of_month__weekday'));
            new ArbitratorSelectComponent(dialog.getElementById('every_dynamic_date_of_month__arbitrator'));
            new ArbitratorSelectComponent(dialog.getElementById('every_arbitrary_weekday_in_month__arbitrator'));

            dialog.getElementById('serie_start').addEventListener('change', (event) => {
                dialog.$('#buffer_before_end').val(event.target.value);
            });
            dialog.getElementById('serie_end').addEventListener('change', (event) => {
                dialog.$('#buffer_after_start').val(event.target.value);
            });

            dialog.data.stepper = new DialogStepper({
                allowRailBasedNavigation: true,
                railWrapperElement: dialog.getElementById('stepper'),
                steps: [
                    {
                        element: dialog.getElementById('step-1'),
                        title: 'Detaljer',
                        stepIn: () => { console.log("1. Step In") },
                        stepOut: () => {
                            return ValidatorFunctions.validate_head(dialog.dialogElement);
                        }
                    },
                    {
                        element: dialog.getElementById('step-2'),
                        title: 'Mønster & Område',
                        stepIn: () => {},
                        stepOut: () => {
                            let active_pattern_key = dialog.$('input:radio[name="pattern"]:checked').val();

                            return ValidatorFunctions.validate_pattern_radio(dialog.dialogElement) &&
                                   ValidatorFunctions.validate_pattern_route(dialog.data.patterns.get(`${active_pattern_key}`), dialog.dialogElement) &&
                                   ValidatorFunctions.validate_recurrence_area(dialog.dialogElement);
                        },
                    },
                    {
                        element: dialog.getElementById('step-3'),
                        title: 'Rom & Personer',
                        stepIn: () => { console.log("1. Step In") },
                        stepOut: () => { console.log("2. Step Out"); }
                    },
                    {
                        element: dialog.getElementById('step-4'),
                        title: 'Opp og ned-rigg',
                        stepIn: () => { console.log("1. Step In") },
                        stepOut: () => { console.log("2. Step Out"); }
                    },
                    {
                        element: dialog.getElementById('step-5'),
                        title: 'Skjermer',
                        stepIn: () => { 
                            dialog.getElementById('next').style.display = "none";
                            dialog.getElementById('finish').style.display = "inline-block";
                        },
                        stepOut: () => {
                            dialog.getElementById('finish').style.display = "none";
                            dialog.getElementById('next').style.display = "inline-block";
                        }
                    },
                ]
            });
            dialog.getElementById('next').onclick = () => dialog.data.stepper.next();
            dialog.getElementById('back').onclick = () => dialog.data.stepper.back();

            /* Pattern: Daily*/
            dialog.data.patterns.set(
                "1",
                {
                    route_fieldset: dialog.$("#patternRoute_daily"),
                    name: "daily",
                    sub_routed_by: 'pattern_daily_subroute',
                    constant_fields: [],
                    sub_routes: [
                        {
                            strategy_name: "daily__every_x_day",
                            route: "pattern_daily_sub__every_x_day",
                            fields: [
                                { element_id: 'every_x_day__interval', out_prop_name: "interval" },
                            ]
                        },
                        {
                            strategy_name: "daily__every_weekday",
                            route: "pattern_daily_sub__every_weekday",
                            fields: []
                        }
                    ]
                }
            );
            /* Pattern: Weekly*/
            dialog.data.patterns.set(
                "2",
                {
                    strategy_name: "weekly__standard",
                    route_fieldset: dialog.$("#patternRoute_weekly"),
                    name: "weekly",
                }
            );
            /* Pattern: Monthly*/
            dialog.data.patterns.set(
                "3",
                {
                    route_fieldset: dialog.$("#patternRoute_monthly"),
                    name: "monthly",
                    sub_routed_by: 'pattern_monthly_subroute',
                    constant_fields: [],
                    sub_routes: [
                        {
                            strategy_name:"month__every_x_day_every_y_month",
                            route: "pattern_monthly_sub__every_x_day_every_y_month",
                            fields: [
                                { element_id: 'every_x_day_every_y_month__day_of_month', out_prop_name: "day_of_month" },
                                { element_id: 'every_x_day_every_y_month__month_interval', out_prop_name: "interval" },
                            ],
                        },
                        {
                            strategy_name: "month__every_arbitrary_date_of_month",
                            route: "pattern_monthly_sub__every_arbitrary_date_of_month",
                            fields: [
                                { element_id: 'every_dynamic_date_of_month__arbitrator', out_prop_name: "arbitrator" },
                                { element_id: 'every_dynamic_date_of_month__weekday', out_prop_name: "weekday" },
                                { element_id: 'every_dynamic_date_of_month__month_interval', out_prop_name: "interval" },
                            ]
                        }
                    ]
                }
            );
            /* Pattern: Yearly*/
            dialog.data.patterns.set(
                "4",
                {
                    route_fieldset: dialog.$("#patternRoute_yearly"),
                    name: "yearly",
                    sub_routed_by: 'pattern_yearly_subroute',
                    constant_fields: [
                        { element_id: 'pattern_yearly_const__year_interval', out_prop_name: "interval" },
                    ],
                    sub_routes: [
                        {
                            strategy_name:"yearly__every_x_of_month",
                            route:"pattern_yearly_sub__every_x_of_month",
                            fields: [
                                { element_id: 'every_x_of_month__date', out_prop_name: "day_index" },
                                { element_id: 'every_x_of_month__month', out_prop_name: "month" },
                            ]
                        },
                        {
                            strategy_name: "yearly__every_arbitrary_weekday_in_month",
                            route: "pattern_yearly_sub__every_arbitrary_weekday_in_month",
                            fields: [
                                { element_id: 'every_arbitrary_weekday_in_month__arbitrator', out_prop_name: "arbitrator" },
                                { element_id: 'every_arbitrary_weekday_in_month__weekday', out_prop_name: "weekday" },
                                { element_id: 'every_arbitrary_weekday_in_month__month', out_prop_name: "month" },
                            ]
                        }
                    ]
                }
            );

            let selects = dialog.$(".newTimePlanDialog_select");
            selects.each(function (index, select) {
                if (select.hasAttribute("init_value")) {
                    select.value = select.getAttribute("init_value");
                }
            });

            const startTimePicker = new ExtendedTimepicker({
                timepickerWrapperElement: dialog.getElementById('serie_start_picker'),
                timepickerInputElement: dialog.getElementById('serie_start'),
                mdbOptions: {
                    format24:true,
                    inline: true,
                }
            });
            const endTimePicker = new ExtendedTimepicker({
                timepickerWrapperElement: dialog.getElementById('serie_end_picker'),
                timepickerInputElement: dialog.getElementById('serie_end'),
                mdbOptions: {
                    format24:true,
                    inline: true,
                }
            });

            /* Handle user changing active time area method */
            dialog.$('input:radio[name="timeAreaMethod"]').change(
                function() {
                    if ($(this).is(':checked')) {
                        let method = $(this).val()
                        dialog.handleTimeAreaRadio({ activeVal: method });
                    }
                }
            );

            /* Handle user changing active pattern */
            dialog.$('input:radio[name="pattern"]').change(
                function() {
                    if ($(this).is(':checked')) {
                        let pattern = dialog.data.patterns.get($(this).val());
                        dialog.data.patterns.forEach(function (item) {
                            $(item.route_fieldset).hide()
                        });
                        $(pattern.route_fieldset).show();
                    }
                }
            );

            /* Handle user changing active pattern */
            dialog.$('input:radio[name="pattern"]').click(
                function() {
                    if ($(this).is(':checked')) {
                        let pattern = dialog.data.patterns.get($(this).val());
                        dialog.data.patterns.forEach(function (item) {
                            $(item.route_fieldset).hide()
                        });
                        $(pattern.route_fieldset).show();
                    }
                }
            );
            
            dialog.matchPatternStateToRadio();
            dialog.matchAreaStateToRadio();

            /* Handle user changing active pattern */
            dialog.$('#area_stopWithin').attr("disabled", "");
            dialog.$('#area_stopAfterXInstances').attr("disabled", "");
            dialog.$('#area_noStop_projectXMonths').attr("disabled", "");

            /* Initialization of state */
            dialog.data.patterns.forEach(function (pattern) {
                dialog.$('input:radio[name="' + pattern.sub_routed_by + '"]').change(
                    function () {
                        dialog.resetPattern({ pattern: pattern });
                        let sub = pattern.sub_routes[$(this).val()];
                        dialog.activatePatternSubroute({ subroute: sub });
                    }
                );

                if (pattern.sub_routes !== undefined) {
                    pattern.sub_routes.forEach(function (sub_route) {
                        dialog.deactivatePatternSubroute({ subroute: sub_route });
                    })
                }

                let already_active_radio = dialog.$('input:radio[name="' + pattern.sub_routed_by + '"]:checked').val();
                if (already_active_radio !== undefined && already_active_radio !== "") {
                    dialog.activatePatternSubroute({ subroute: pattern.sub_routes[already_active_radio]} )
                }
            });
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeMe();
            },
            submit(dialog, {} = {}, triggeredByElement) {
                let old_alerts = dialog.querySelectorAll('.form_alert');
                old_alerts.forEach(function (elem) {
                    $(elem).remove();
                });

                let time = {
                    title: dialog.interior.serie_title.value,
                    title_en: dialog.interior.serie_title_en.value,
                    start: dialog.interior.serie_start.value,
                    end: dialog.interior.serie_end.value,
                    ticket_code: dialog.interior.serie_ticket_code.value,
                    expected_visitors: dialog.interior.serie_expected_visitors.value,
                }

                let pattern = {}
                let active_pattern_key = dialog.$('input:radio[name="pattern"]:checked').val();
                let pattern_obj = dialog.data.patterns.get(`${active_pattern_key}`);

                let headResult = ValidatorFunctions.validate_head( dialog.dialogElement );
                let patternResult = ValidatorFunctions.validate_pattern_radio( dialog.dialogElement );
                let patternRouteResult = ValidatorFunctions.validate_pattern_route( pattern_obj, dialog.dialogElement );
                let areaRecurrenceResult = ValidatorFunctions.validate_recurrence_area( dialog.dialogElement );

                if (headResult === false || patternResult === false || patternRouteResult === false || areaRecurrenceResult === false) {
                    return;
                }

                // since weekly doesnt have any subroutings (only one option) we cant use the normal method
                if (active_pattern_key !== "2") {
                    if (active_pattern_key == "4") {
                        pattern["year_interval"] = dialog.$('#pattern_yearly_const__year_interval').val();
                    }

                    let active_sub_route_key = dialog.$('input:radio[name="' + pattern_obj.sub_routed_by +'"]:checked').val();
                    let sub_route = pattern_obj.sub_routes[active_sub_route_key];
                    pattern.pattern_type = pattern_obj.name;
                    pattern.pattern_routine = sub_route.strategy_name;

                    for (let i = 0; i < sub_route.fields.length; i++) {
                        let field = sub_route.fields[i];
                        pattern[field.out_prop_name] = dialog.$("#" + field.element_id).val();
                    }
                }
                else {
                    pattern["week_interval"] = dialog.$('#week_interval').val();
                    pattern.pattern_type = pattern_obj.name;

                    let days = new Map([
                        [0, dialog.$('#sunday').is(':checked')],
                        [1, dialog.$('#monday').is(':checked')],
                        [2, dialog.$('#tuesday').is(':checked')],
                        [3, dialog.$('#wednesday').is(':checked')],
                        [4, dialog.$('#thursday').is(':checked')],
                        [5, dialog.$('#friday').is(':checked')],
                        [6, dialog.$('#saturday').is(':checked')],
                    ]);
                    pattern["days"] = days;
                    pattern["pattern_routine"] = "weekly__standard";
                }

                let area = {}

                let area_methods = new Map();
                area_methods.set(
                    "1",
                    {
                        name: "StopWithin",
                        set: function () {
                            area.stop_within = dialog.$('#area_stopWithin').val();
                        }
                    }
                );
                area_methods.set("2",
                {
                    name: "StopAfterXInstances",
                    set: function () {
                        area.instances = dialog.$('#area_stopAfterXInstances').val()
                    }
                });
                area_methods.set("3",
                {
                    name: "NoStopDate",
                    set: function () {
                        area.projectionDistanceInMonths = dialog.$('#area_noStop_projectXMonths').val()
                    }
                });

                let active_area_method = area_methods.get(dialog.$('input:radio[name="timeAreaMethod"]:checked').val());
                active_area_method.set();
                area.method_name = active_area_method.name;
                area.start_date = dialog.$('#area_start_date').val();

                let serie = {
                    time: time,
                    pattern: pattern,
                    time_area: area,
                }

                let display_layouts = [];
                dialog.querySelectorAll("input[name='display_layouts_serie_planner'][type='checkbox']:checked").forEach(element => {
                    display_layouts.push(element.value)
                })

                serie.buffer = {}
                if ( dialog.$('#buffer_before_start').val() && dialog.$('#buffer_before_end').val() ) {
                    serie.buffer.before = {
                        start: dialog.$('#buffer_before_start').val(),
                        end: dialog.$('#buffer_before_end').val(),
                    }
                }
                if ( dialog.$('#buffer_after_start').val() && dialog.$('#buffer_after_end').val() ) {
                    serie.buffer.after = {
                        start: dialog.$('#buffer_after_start').val(),
                        end: dialog.$('#buffer_after_end').val(),
                    }
                }

                serie._uuid = dialog.$('#serie_uuid').val();
                serie.rooms = dialog.getSelectedRoomIds();
                serie.people = dialog.getSelectedPeopleIds();
                serie.room_name_map = dialog.data.roomsNameMap;
                serie.people_name_map = dialog.data.peopleNameMap;
                serie.display_layouts = display_layouts.join(",");

                dialog.raiseSubmitEvent({
                    serie: serie,
                    csrf_token: '{{csrf_token}}',
                });
            },
            /* Ensure that the shown pattern matches the selected pattern in the radio menu. This will correct any such mismatches. */
            matchPatternStateToRadio(dialog, {} = {}, triggeredByElement) {
                let active_pattern_key = dialog.$('input:radio[name="pattern"]:checked').val();

                // Ensure that if the user closes the modal while working with it, they will
                // come right back to the same pattern fieldset when re-opening it.
                if (active_pattern_key !== undefined && active_pattern_key !== "") {
                    for (let i = 0; i < dialog.data.patterns.length; i++) {
                        $(patterns[i].route_fieldset).hide();
                    }
                    $(dialog.data.patterns.get(active_pattern_key).route_fieldset).show();
                }
            },
            matchAreaStateToRadio(dialog, {} = {}, triggeredByElement) {
                let activeAreaMethod = dialog.$('input:radio[name="timeAreaMethod"]:checked').val();

                if (activeAreaMethod !== undefined && activeAreaMethod !== "") {
                    dialog.handleTimeAreaRadio({ activeVal: activeAreaMethod });
                }
            },
            /* Resets a patterns field values, and disables it. This affects all sub-routes of the pattern. */
            resetPattern(dialog, { pattern } = {}, triggeredByElement) {
                if (pattern.sub_routes !== undefined) {
                    pattern.sub_routes.forEach(function (sub_route) {
                        dialog.deactivatePatternSubroute( { subroute: sub_route });
                        sub_route.fields.forEach(function (field_obj) {
                            let field = dialog.$("#" + field_obj.element_id);
                        })
                    })
                }
            },
            /* Activate a sub route of a pattern. In practice removes the disabled attribute from the fields of this sub route. */
            activatePatternSubroute(dialog, { subroute } = {}, triggeredByElement) {
                for (let i = 0; i < subroute.fields.length; i++) {
                    let field = dialog.querySelector("#" + subroute.fields[i].element_id);
                    field.removeAttribute("disabled");
                }
            },
            deactivatePatternSubroute(dialog, { subroute } = {}, triggeredByElement) {
                for (let i = 0; i < subroute.fields.length; i++) {
                    let field = dialog.querySelector("#" + subroute.fields[i].element_id);
                    field.setAttribute("disabled", "true");
                }
            },
            handleTimeAreaRadio(dialog, {activeVal} = {}, triggeredByElement) {
                dialog.$('#area_stopWithin').attr("disabled", "");
                dialog.$('#area_stopAfterXInstances').attr("disabled", "");
                dialog.$('#area_noStop_projectXMonths').attr("disabled", "");

                if (activeVal === "1") {
                    dialog.$('#area_stopWithin').removeAttr("disabled");
                }
                if (activeVal === "2"){
                    dialog.$('#area_stopAfterXInstances').removeAttr("disabled");
                }
                if (activeVal === "3") {
                    dialog.$('#area_noStop_projectXMonths').removeAttr("disabled");
                }
            },
            triggerAddRooms(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("{{managerName}}", "{{orderRoomDialog}}", { $parent: dialog.dialogElement });
            },
            triggerAddPeople(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("{{managerName}}", "{{orderPersonDialog}}", { $parent: dialog.dialogElement });
            },
            setPeople(dialog, { people } = {}, triggeredByElement) {
                let wrapper = dialog.$('#peopleChips');
                wrapper.empty();

                people.split(",").forEach(id => {
                    wrapper.append(
                        $(`<selected-pill name='${dialog.data.peopleNameMap.get(id)}'
                                          id='${id}'
                                          d-trigger='removeAssociation'>
                           </selected-pill>`)
                    );
                });
            },
            setRooms(dialog, { rooms } = {}, triggeredByElement) {
                let wrapper = dialog.$('#roomChips');
                wrapper.empty();

                rooms.split(",").forEach(id => {
                    wrapper.append(
                        $(`<selected-pill name='${dialog.data.roomsNameMap.get(id)}'
                                          id='${id}'
                                          d-trigger='removeAssociation'>
                           </selected-pill>`)    
                    );
                });
            },
            removeAssociation(dialog, {} = {}, triggeredByElement) {
                $(triggeredByElement).parent().remove();
            },
            getSelectedRoomIds(dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.$("#roomChips")[0].children).map(row => row.getAttribute("rowid"));
            },
            getSelectedPeopleIds(dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.$("#peopleChips")[0].children).map(row => row.getAttribute("rowid"));
            },
        },
        data: {
            peopleNameMap: new Map(),
            roomsNameMap: new Map(),
            patterns: new Map(),
            stepper: null,
        }
    });
</script>
