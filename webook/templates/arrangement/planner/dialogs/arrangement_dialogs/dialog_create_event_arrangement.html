{% load static i18n %}


<div id="{{dialogId}}" class="{{discriminator}}" title="">
    <div class="row">
        <div class="col-6">
            <form id="newSimpleActivityForm">
                <input type="submit" name="submit" style="display:none;" />
    
                <input type="hidden" name="uuid" id="event_uuid">
                
                <h5>
                    Informasjon
                </h5>
                <div class="row">
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <input type="text" id="title" name="title" class="form-control" />
                            <label class="form-label" for="title">ðŸ‡³ðŸ‡´ Tittel pÃ¥ norsk</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <input type="text" id="title_en" name="title_en" class="form-control" />
                            <label class="form-label" for="title_en">ðŸ‡¬ðŸ‡§ Tittel pÃ¥ engelsk</label>
                        </div>
                    </div>
                </div>
    
                <div class="form-outline mb-2">
                    <input type="text" id="ticket_code" name="ticket_code" class="form-control" />
                    <label class="form-label" for="ticket_code"><i class="fas fa-receipt text-info"></i>&nbsp; Billetkode</label>
                </div>
    
                <div class="form-outline mb-2">
                    <input type="text" id="expected_visitors" name="expected_visitors" class="form-control" />
                    <label class="form-label" for="expected_visitors"><i class="fas fa-users text-info"></i>&nbsp; Forventet antall besÃ¸kende</label>
                </div>
    
                <h5 class="mt-3">
                    Tider
                </h5>
                <div class="form-group mt-2">
                    <label for=""><i class="fas fa-calendar text-muted"></i>&nbsp; Fra</label>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-outline">
                                <input type="date" id="fromDate" name="fromDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline">
                                <input type="time" id="fromTime" name="fromTime" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="form-group mt-2">
                    <label for=""><i class="fas fa-calendar text-muted"></i>&nbsp; Til</label>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-outline">
                                <input type="date" id="toDate" name="toDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline">
                                <input type="time" id="toTime" name="toTime" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
    
                <h5 class="mt-3">
                    Skjermvisning
                </h5>
                <div class="form-group mt-3">
                    <label class="d-block"><i class='fas fa-desktop text-muted'></i>&nbsp; {% trans "Show on:" %}</label>
                    <ul>
                        {% for choice_id, choice_label in form.display_layouts.field.choices %}
                            <li class='your class'> <input type="checkbox" value="{{choice_id}}" name="display_layouts_create_event" id="{{choice_id}}_dlcheck" />
                            <label for="{{choice_id}}_dlcheck">{{choice_label}}</label></li>
                        {% endfor %}
                    </ul>
                </div>

            </form>
        </div>
        <div class="col-6">
            <div class="accordion accordion-flush" id="accordionFlushExample">
                <div class="accordion-item">
                    <h5 class="accordion-header">
                        <button
                          class="accordion-button collapsed"
                          type="button"
                          data-mdb-toggle="collapse"
                          data-mdb-target="#activityAccordions-people"
                          aria-expanded="false"
                          aria-controls="activityAccordions-people">
                          <div class="badge badge-secondary" id="peopleCounter">0</div>
                          &nbsp;<i class="fas fa-users"></i>&nbsp;
                          Personer
                        </button>
                    </h5>
                    <div
                      id="activityAccordions-people"
                      class="accordion-collapse collapse"
                      aria-labelledby="activityAccordions-people"
                      data-mdb-parent="#accordionFlushExample">
  
                      <div class="accordion-body">
                          <a class="btn btn-block wb-btn-secondary shadow-0"
                          d-trigger="triggerAddPeople"
                          type="button">
                              Legg til personer
                          </a>
  
                          <div class="mt-2 table-responsive">
                              <table class="table-sm table">
                                  <tbody id="peopleTbody__d1">
                                  </tbody>
                              </table>
                          </div>
                      </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h5 class="accordion-header">
                        <button
                          class="accordion-button collapsed"
                          type="button"
                          data-mdb-toggle="collapse"
                          data-mdb-target="#activityAccordions-rooms"
                          aria-expanded="false"
                          aria-controls="activityAccordions-rooms">
                          <div class="badge badge-secondary" id="roomsCounter">0</div>
                          &nbsp;<i class="fas fa-building"></i>&nbsp;
                          Rom
                        </button>
                    </h5>
                    <div
                      id="activityAccordions-rooms"
                      class="accordion-collapse collapse"
                      aria-labelledby="activityAccordions-rooms"
                      data-mdb-parent="#accordionFlushExample">
  
                      <div class="accordion-body">
                        <a class="btn btn-block wb-btn-secondary shadow-0"
                        d-trigger="triggerAddRooms"
                        type="button">
                            Legg til rom
                        </a>

                        <div class="mt-2 table-responsive">
                            <table class="table-sm table">
                                <tbody id="roomsTbody__d1">
                                </tbody>
                            </table>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h5 class="accordion-header" id="flush-headingOne">
                      <button
                        class="accordion-button collapsed"
                        type="button"
                        data-mdb-toggle="collapse"
                        data-mdb-target="#flush-collapseOne"
                        aria-expanded="false"
                        aria-controls="flush-collapseOne"
                      >
                        <i class="fas fa-clock"></i>&nbsp; Buffere
                      </button>
                    </h5>
                    <div
                      id="flush-collapseOne"
                      class="accordion-collapse collapse"
                      aria-labelledby="flush-headingOne"
                      data-mdb-parent="#accordionFlushExample"
                    >
                      <div class="accordion-body">
                          <div class="alert alert-info small">
                              <i class="fas fa-info-circle"></i>
                              Buffere blir opprettet som egne hendelser fÃ¸r og etter aktiviteten.
                          </div>
              
                          <table class="table">
                              <thead></thead>
                              <tbody>
                                  <tr>
                                      <th colspan="3" class="fw-bold">Buffer fÃ¸r aktiviteten:</th>
                                  </tr>
                                  <tr>
                                      <td>
                                          Fra
                                          <div class="form-outline">
                                              <input type="time" id="buffer_before_start" name="buffer_before_start" class="form-control" />
                                          </div>
                                      </td>
                                      <td>
                                          Til
                                          <div class="form-outline">
                                              <input type="time" id="buffer_before_end" name="buffer_before_end" class="form-control" />
                                          </div>
                                      </td>
                                  </tr>
                                  <tr>
                                      <th colspan="3" class="fw-bold">Buffer etter aktiviteten:</th>
                                  </tr>
                                  <tr>
                                      <td>
                                          Fra
                                          <div class="form-outline">
                                              <input type="time" id="buffer_after_start" name="buffer_after_start" class="form-control" />
                                          </div>
                                      </td>
                                      <td>
                                          Til
                                          <div class="form-outline">
                                              <input type="time" id="buffer_after_end" name="buffer_after_end" class="form-control" />
                                          </div>
                                      </td>
                                  </tr>
                              </tbody>
                          </table>            
                      </div>
                    </div>
                  </div>
              </div>
        </div>

        <div class="clearfix">
            <div class="float-end">
                <a href="#" class="btn wb-btn-secondary btn-lg"
                    d-trigger="close">
                    <i class="fas fa-times"></i>
                    Avbryt
                </a>

                <a class="mt-2 btn wb-btn-main" d-trigger="submit" href="#">
                    <i class="fas fa-check"></i>&nbsp; Lagre
                </a>
            </div>
        </div>
    </div>
</div>


<script>
    new Dialog({
        dialogId: '{{ dialogId }}',
        managerName: '{{ managerName }}',
        discriminator: '{{ discriminator }}',
        postInit: function (dialog) {
            dialog.$("#fromTime").on("change", (event) => {
                dialog.$("#buffer_before_end").val(event.target.value);
            });
            dialog.$("#toTime").on("change", (event) => {
                dialog.$("#buffer_after_start").val(event.target.value);
            });

            document.addEventListener("{{managerName}}.d1_peopleSelected", (e) => {
                dialog.data.peopleNameMap = e.detail.context.people_name_map;
                dialog.setPeople({ people: e.detail.context.people });

                dialog.$("#peopleCounter").text(dialog.$("#peopleTbody__d1").children().length);
            });
            document.addEventListener("{{managerName}}.d1_roomsSelected", (e) => {
                dialog.data.roomsNameMap = e.detail.context.room_name_map;
                dialog.setRooms({ rooms: e.detail.context.rooms });

                dialog.$("#roomsCounter").text(dialog.$("#roomsTbody__d1").children().length);
            });
        },
        methods: {
            close(dialog, {} = {}, triggeredByElement) {
                dialog.closeMe();
            },
            setRooms(dialog, { rooms } = {}, triggeredByElement) {
                let tbody = dialog.$('#roomsTbody__d1');
                tbody.empty();

                let ids = rooms.split(",");
                ids.forEach(id => {
                    tbody.append(
                        $(`<tr rowid='${id}'>
                            <td> <input type='checkbox' /> </td>
                            <td>${dialog.data.roomsNameMap.get(id)}</td>
                            <td> <a href='#' class='text-danger'
                                    data-mdb-toggle='tooltip'
                                    title='{% trans "Remove this room from the activity" %}'
                                    d-trigger='removeAssociation'>
                                        <i class='fas fa-trash'></i>
                                    </a>
                            </td>
                        </tr>`)
                    )
                });
            },
            setPeople(dialog, { people } = {}, triggeredByElement) {
                let tbody = dialog.$('#peopleTbody__d1');
                tbody.empty();

                let ids = people.split(",");
                ids.forEach(id => {
                    tbody.append(
                        $(`<tr rowid='${id}'>
                            <td>${dialog.data.peopleNameMap.get(id)}</td>
                            <td> <a href='#' class='text-danger'
                                    data-mdb-toggle='tooltip'
                                    title='{% trans "Remove this person from the activity" %}'
                                    d-trigger="removeAssociation">
                                        <i class='fas fa-trash'></i>
                                    </a>
                            </td>
                        </tr>`)
                    )
                });
            },
            submit(dialog, {} = {}, triggeredByElement) {
                if (dialog.validate() === false) {
                    console.warn("Validation failed.")
                    return;
                }

                let qualifiedEvent = {
                    _uuid:                      dialog.interior.event_uuid.value,
                    title:                      dialog.interior.title.value,
                    title_en:                   dialog.interior.title_en.value,
                    ticket_code:                dialog.interior.ticket_code.value,
                    expected_visitors:          dialog.interior.expected_visitors.value,
                    start:                      new Date( dialog.interior.fromDate.value   + "T" + dialog.interior.fromTime.value ),
                    end:                        new Date( dialog.interior.toDate.value     + "T" + dialog.interior.toTime.value ),
                    arrangement:                0,
                    rooms:                      dialog.getSelectedRoomIds(),
                    people:                     dialog.getSelectedPeopleIds(),
                    people_name_map:            dialog.data.peopleNameMap,      // Kept due to edit - not pertinent for save
                    room_name_map:              dialog.data.roomsNameMap,       // Kept due to edit - not pertinent for save
                    before_buffer_start:        dialog.interior.buffer_before_start.value ?? "",
                    before_buffer_end:          dialog.interior.buffer_before_end.value ?? "",
                    after_buffer_start:         dialog.interior.buffer_after_start.value ?? "",
                    after_buffer_end:           dialog.interior.buffer_after_end.value ?? "",
                };

                qualifiedEvent.display_layouts = 
                    [...dialog.querySelectorAll("input[name='display_layouts_create_event'][type='checkbox']:checked")]
                        .map(element => element.value);

                dialog.raiseSubmitEvent({
                    event: qualifiedEvent,
                    csrf_token: '{{csrf_token}}',
                });
            },
            validate(dialog, {} = {}, triggeredByElement) {
                let field_elements = dialog.$('#newSimpleActivityForm').find("input, select");
                let isInvalid = false;

                for (let i = 0; i < field_elements.length; i++) {
                    if (field_elements[i].checkValidity() === false) {
                        isInvalid = true;
                        break;
                    }
                }

                if (isInvalid) {
                    dialog.$('#newSimpleActivityForm').find(':submit').click();
                    return false;
                }

                return true;
            },
            removeAssociation(dialog, {} = {}, triggeredByElement) {
                let row = $(triggeredByElement).closest("tr")[0];
                let rowid = row.getAttribute("rowid");
                row.remove();
            },
            triggerAddRooms(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("{{managerName}}", "{{orderRoomDialog}}", {});
            },
            triggerAddPeople(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("{{managerName}}", "{{orderPersonDialog}}", {});
            },
            getSelectedRoomIds (dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.$("#roomsTbody__d1")[0].children).map(row => row.getAttribute("rowid"));
            },
            getSelectedPeopleIds(dialog, {} = {}, triggeredByElement) {
                return Array.from(dialog.$("#peopleTbody__d1")[0].children).map(row => row.getAttribute("rowid"));
            },
        },
        data: {
            peopleNameMap: new Map(),
            roomsNameMap: new Map(),
        }
    });
</script>
