{% load static i18n %}


<div id="inspectEventDialog" title="<span class='badge badge-success'><i class='fas fa-edit'></i></span>&nbsp; Rediger aktivitet {{ form.title.value }}">
    <button class="btn btn-danger mb-3" onclick="inspectEventDialog__delete()"><i class="fas fa-trash"></i>&nbsp; Slett</button>

    <!-- <div class="alert alert-light border col-auto border border-success shadow-3 mb-4">
        <div class="row">
            <div class="col-6">
                <h5 class="mb-0 d-inline fw-bolder">En del av</h5>
                <h6 class="mb-0  fw-bolder">{{ object.arrangement.name }}</h6>
            </div>
            <div class="col-6">
                <button class="btn btn-link"> <i class="fas fa-hand-pointer"></i> Ã…pne arrangement</button>
            </div>
        </div>
    </div> -->

    <div class="row">
        <div class="col-12">
            <form id="inspectEventForm" class="mt-3">
                <input type="submit" style="display:none;" />
                <div style="max-height: 300px;">
                    <div>
                        <div>
                            <div class="form-outline">
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.title.id_for_label }}" 
                                    value="{{ form.title.value|default:'' }}"
                                    name="{{ form.title.name }}"
                                    autocomplete="off"
                                    />
                                <label class="form-label" for="{{ form.title.id_for_label }}">ðŸ‡³ðŸ‡´ Tittel pÃ¥ norsk</label>
                            </div>
                            {% if form.title.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mt-2">
                            <div class="form-outline mb-3">
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.title_en.id_for_label }}" 
                                    value="{{ form.title_en.value|default:'' }}"
                                    name="{{ form.title_en.name }}"
                                    autocomplete="off"
                                    />
                                <label class="form-label" for="{{ form.title_en.id_for_label }}">ðŸ‡¬ðŸ‡§ Tittel pÃ¥ engelsk</label>
                            </div>
                            {% if form.title_en.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.title_en.errors }}
                                </div>
                            {% endif %}
                        </div>
        
                        <div class="mt-2">
        
                            <div class="row">
                                <div class="col-6">
                                    <div >
                                        <div class="form-outline mb-3">
                                            <input type="text"
                                                class="form-control form-control-md"
                                                id="{{ form.expected_visitors.id_for_label }}" 
                                                value="{{ form.expected_visitors.value|default:'0' }}"
                                                name="{{ form.expected_visitors.name }}"
                                                autocomplete="off"
                                                />
                                            <label class="form-label" for="{{ form.expected_visitors.id_for_label }}"><i class="fas fa-users"></i>&nbsp; Expected visitors</label>
                                        </div>
                                        {% if form.expected_visitors.errors|length > 0 %}
                                            <div class="alert alert-danger">
                                                {{ form.expected_visitors.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div>
                                        <div class="form-outline mb-3">
                                            <input type="text"
                                                class="form-control form-control-md"
                                                id="{{ form.actual_visitors.id_for_label }}" 
                                                value="{{ form.actual_visitors.value|default:'0' }}"
                                                name="{{ form.actual_visitors.name }}"
                                                autocomplete="off"
                                                />
                                            <label class="form-label" for="{{ form.actual_visitors.id_for_label }}"><i class="fas fa-users"></i>&nbsp; Actual visitors</label>
                                        </div>
                                        {% if form.actual_visitors.errors|length > 0 %}
                                            <div class="alert alert-danger">
                                                {{ form.actual_visitors.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
        
                            <div class="form-outline mb-3">
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.ticket_code.id_for_label }}" 
                                    value="{{ form.ticket_code.value|default:'' }}"
                                    name="{{ form.ticket_code.name }}"
                                    autocomplete="off"
                                    />
                                <label class="form-label" for="{{ form.ticket_code.id_for_label }}"><i class="fas fa-receipt"></i>&nbsp; Billetkode</label>
                            </div>
                            {% if form.ticket_code.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.ticket_code.errors }}
                                </div>
                            {% endif %}
                        </div>
        
                        <div class="mt-2">
                            <h6><i class="fas fa-calendar text-muted"></i>&nbsp; Fra</h6>
                            <div class="row">
                                <div class="col-8">
                                    <input type="date" class="form-control"
                                            name="{{form.start.name}}_date" id="{{form.start.id_for_label}}_date"
                                            value="{{ start_t|date:'Y-m-d' }}">
                                </div>
                                <div class="col-4">
                                    <input type="time" class="form-control"
                                            name="{{ form.start.name }}_time" id="{{ form.start.name }}_time"
                                            value="{{ start_t|date:'H:i' }}">
                                </div>
                            </div>
                        </div>
        
                        <div class="mt-2">
                            <h6><i class="fas fa-calendar text-muted"></i>&nbsp; Til</h6>
                            <div class="row">
                                <div class="col-8">
                                    <input type="date" class="form-control"
                                            name="{{ form.end.name }}_date" id="{{ form.end.id_for_label }}_date"
                                            value="{{ end_t|date:'Y-m-d' }}">
                                </div>
                                <div class="col-4">
                                    <input type="time" class="form-control"
                                            name="{{form.end.name}}_time" id="{{ form.end.name }}_time"
                                            value="{{ end_t|date:'H:i' }}" >
                                </div>
                            </div>
                        </div>
        
                        <div class="mt-2">
                            <label class="d-block"><i class='fas fa-desktop'></i>&nbsp; {% trans "Vises pÃ¥ skjermen:" %}</label>
                            {{form.display_layouts}}
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <div class=" mb-2 mt-4">
                                    <h5> <i class="fas fa-building text-muted"></i> Rom</h5>
                                    <a class="btn btn-sm btn-success text-white"
                                        id="inspectEventDialog_addRoomsBtn"
                                        type="button">
                                        + Legg til nye rom
                                    </a>
                                </div>
                                <hr>
                    
                                <div class="table-responsive">
                                    <table class="table table-sm table-borderless">
                                        <tbody id="roomsTableBody">
                                            {% for room in object.rooms.all %}
                                            <tr rowid="{{room.pk}}">
                                                <td>{{room}}</td>
                                                <td>
                                                    <a href="#" class="text-danger"
                                                        data-mdb-toggle="tooltip"
                                                        onclick="inspectEventDialog__removeAssociation(this)"
                                                        title="{% trans 'Remove this room from the activity' %}">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="cmb-2 mt-4">
                                    <h5> <i class="fas fa-user text-muted"></i> People</h5>
                                    <a class="btn btn-sm btn-success text-white"
                                        id="inspectEventDialog_addPeopleBtn"
                                        type="button">
                                        + Legg til nye personer
                                    </a>
                                </div>
                    
                                <hr>
                                <div class="table-responsive">
                                    <table class="table table-sm table-borderless">
                                        <tbody id="peopleTableBody">
                                            {% for person in object.people.all %}
                                                <tr rowid="{{person.pk}}">
                                                    <td>{{person}}</td>
                                                    <td>
                                                        <a href="#" class="text-danger"
                                                            data-mdb-toggle="tooltip"
                                                            onclick="inspectEventDialog__removeAssociation(this)"
                                                            title="{% trans 'Remove this person from the activity' %}">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-12">



        <div class="col-12">
            <div>
                <div>
                    <button class="btn btn-sm btn-dark">Avbryt</button>
                    <button class="btn btn-sm btn-success" type="button" onclick="inspectEventDialog__save()">Lagre</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    var peopleMap = new Map();
    var roomsMap = new Map();

    function inspectEventDialog__evaluateEnTitleObligatory() {
        var $enTitleElement = $('#id_title_en');
        var countSeletedDisplayLayouts = $("input[name='display_layouts'][type='checkbox']:checked").length;

        if (countSeletedDisplayLayouts === 0) {
            $enTitleElement.removeAttr("required");
        }
        else {
            $enTitleElement.attr("required", true);
        }
    }

    function inspectEventDialog__validate() {
        let field_elements = $('#inspectEventForm').find("input, select");

        let isInvalid = false;

        for (let i = 0; i < field_elements.length; i++) {
            if (field_elements[i].checkValidity() === false) {
                isInvalid = true;
                break;
            }
        }

        if (isInvalid) {
            $('#inspectEventForm').find(':submit').click();
            return false;
        }

        return true;
    }

    $(document).ready(function () {
        inspectEventDialog__evaluateEnTitleObligatory();

        $("input[name='display_layouts'][type='checkbox']").on("change", (e) => {
            inspectEventDialog__evaluateEnTitleObligatory();
        });

        document.addEventListener("eventInspector.roomsUpdated", (e) => {
            roomsMap = e.detail.context.room_name_map;
            inspectEventDialog__setRooms(e.detail.context.rooms);
        })
        document.addEventListener("eventInspector.peopleUpdated", (e) => {
            peopleMap = e.detail.context.people_name_map;
            inspectEventDialog__setPeople(e.detail.context.people);
        });
    })

    function inspectEventDialog__removeAssociation(a) {
        var row = $(a).closest("tr");
        row.remove();
    }

    function inspectEventDialog__setRooms(rooms) {
        console.log("rooms", rooms)

        var tbody = $('#roomsTableBody');
        tbody.empty(); // remove child elements

        var ids = rooms.split(",");

        ids.forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${roomsMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this room from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__setPeople(people) {
        var tbody = $('#peopleTableBody');
        tbody.empty(); // remove child elements

        var ids = people.split(",");

        ids.forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${peopleMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this person from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__getSelectedRoomIds() {
        var room_ids = Array.from($("#roomsTableBody")[0].children).map(row => row.getAttribute("rowid"));
        console.log("Rooms", room_ids);
        return room_ids;
    }

    function inspectEventDialog__getSelectedPeopleIds() {
        var people_ids = Array.from($("#peopleTableBody")[0].children).map(row => row.getAttribute("rowid"));
        console.log("People", people_ids)
        return people_ids;
    }

    function inspectEventDialog__delete() {

        Swal.fire({
            title: 'Er du sikker?',
            text: "Hendelsen kan ikke hentes tilbake.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                let formData = new FormData();
                formData.append("eventIds", "{{object.pk}}");

                fetch('/arrangement/planner/delete_events/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}',
                    }
                }).then(_ => {
                    document.dispatchEvent(new Event("eventInspector.close"));
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                });
            }
        })
    }

    function inspectEventDialog__save() {
        if (inspectEventDialog__validate() === false) {
            return;
        }

        let formData = new FormData();
        var start = new Date( $('#id_start_date').val() + "T" + $('#start_time').val() ).toISOString();
        var end = new Date( $('#id_end_date').val() + "T" + $('#end_time').val() ).toISOString();

        formData.append("id",           '{{object.pk}}');
        formData.append("title",        $('#id_title').val());
        formData.append("title_en",     $('#id_title_en').val());
        formData.append("ticket_code",  $('#id_ticket_code').val())
        formData.append("start",        start);
        formData.append("end",          end);
        formData.append("expected_visitors", $('#id_expected_visitors').val());
        formData.append("actual_visitors", $('#id_actual_visitors').val())
        formData.append("arrangement", '{{object.arrangement.pk}}');
        formData.append("people",       inspectEventDialog__getSelectedPeopleIds());
        formData.append("rooms",        inspectEventDialog__getSelectedRoomIds());
        formData.append("csrf_token",   "{{ csrf_token }}");

        let displayLayouts = [];
        document.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked").forEach(element => {
            formData.append("display_layouts", element.value);
        })

        document.dispatchEvent(
            new CustomEvent("eventInspector.submit", { "detail": {
                dialog: "inspectEventDialog",
                formData: formData,
                event_pk: '{{ object.pk }}',
                csrf_token: '{{ csrf_token }}',
            }})
        );
    }

    function triggerFocusTo(slug, event_pk) {
        document.dispatchEvent(
            new CustomEvent(
                "plannerCalendar.inspectThisArrangement",
                { detail: { slug: slug, event_pk: event_pk } }
            )
        )
    }

    function removePerson(el) {
      let key = $(el).attr("person-key");
      peopleMap.delete(parseInt(key));
      el.remove();
    }

    function removeRoom(el) {
      let key = $(el).attr("room-key");
      roomsMap.delete(parseInt(key));
      el.remove();
    }

    $(document).ready(function () {
        const personAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_people_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let people = []
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (peopleMap.has(entry.fields.id) !== true) {
            people.push(entry.fields)
          }
        }

        return people;
      };

      const roomAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_room_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let rooms = [];
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (roomsMap.has(entry.fields.id) !== true) {
            rooms.push(entry.fields);
          }
        }

        return rooms;
      };
    })
</script>
