{% load static i18n %}
{% load crispy_forms_tags %}
{% load custom_tags %}

<div id="{{dialogId}}"
    class="{{discriminator}}">

    <div class="clearfix">
        <div class="float-start">
            <h3 class="fw-bold">
                {{ form.title.value }} {% if event.serie %}<small class="fw-light"><em>(repeterende)</em></small>{% endif %}
            </h3>
            <h5 id="title">
                {{form.start.value}} <strong> until </strong> {{form.end.value}}
            </h5>
        </div>
        <div id="stepper" class="float-end stepper-rail"></div>
    </div>

    <hr>

    <div class="clearfix">
        <small class="float-end">Opprettet {{event.created}} <strong>|</strong> Sist oppdatert {{event.modified}}</small>
    </div>

    <div class="row">
        <div class="col-4">
            <div class="alert col-auto mb-4 mt-2 wb-bg-secondary">
                <div class="clearfix">
                    <div class="float-start">
                        <h6 class="mb-0 d-inline fw-lighter">Tilhører arrangement:</h4>
                        <h4 class="mb-0">{{ object.arrangement.name }}</h6>
                        
                        <small>
                            <div><strong><i class="fas fa-building"></i></strong> {{object.arrangement.location.name}}</div>
                            <div><strong><i class="fas fa-star"></i></strong> {{object.arrangement.responsible}}</div>
                            <div><strong><i class="fas fa-calendar"></i></strong> {{object.arrangement.created}}</div>
                        </small>
                    </div>
                    <button class="btn wb-btn-blank float-end shadow-0"
                            type="button"
                            d-trigger="openInspectArrangementDialog"
                            d-arg-slug="{{ object.arrangement.slug }}"
                            d-arg-event_pk="{{ object.pk }}">
                        Gå til arrangement
                    </button>
                </div>
            </div>
        </div>

        <div class="col-8">
            {% if event.serie %}
            <div class="alert mb-4 mt-2" style="background-color:  #f6f6f0 !important;">
                    <div>
                        <h4 class="mb-0"><span class="h3"><i class="fas fa-sync"></i></span>&nbsp;&nbsp; {{event.serie.serie_plan_manifest.schedule_description }}</h4>
                        <small><i class="fas fa-info-circle"></i>&nbsp; Ved redigering vil denne aktiviteten brytes ut av serien, og vil ikke lenger bli ansett som en del av denne serien</small>
                        <small class="d-block">Du kan redigere selve serien fra arrangementsvisningen, gå til tidspunkter og rediger der</small>
                    </div>
            </div>
            {% endif %}
        </div>
    </div>

    <ul class="nav nav-tabs webook-tabs mb-3" id="ex1" role="tablist">
        <li class="nav-item" role="presentation">
            <a
                class="nav-link active"
                id="ex1-tab-1"
                data-mdb-toggle="tab"
                href="#ex1-tabs-1"
                role="tab"
                aria-controls="ex1-tabs-1"
                aria-selected="true">
            Aktivitet
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a href="#tab-resources" role="tab" data-mdb-toggle="tab" class="nav-link" id="tab-resource">
                Rom
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="files-tab-link"
                data-mdb-toggle="tab"
                href="#files-tab"
                role="tab"
                aria-controls="ex1-tabs-2"
                aria-selected="false">
                Filer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="notes-tab-link"
                data-mdb-toggle="tab"
                href="#notes-tab"
                role="tab"
                aria-controls="ex1-tabs-3"
                aria-selected="false">
                Notater
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a href="#tab-details" role="tab" data-mdb-toggle="tab" class="nav-link" id="tab-detailss">
                Detaljer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-4"
                data-mdb-toggle="tab"
                href="#ex1-tabs-4"
                role="tab"
                aria-controls="ex1-tabs-4"
                aria-selected="false"
                >Opprigg & Nedrigg
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a 
                href="#service-orders-tab"
                id="service-orders-tab-link" 
                role="tab"
                data-mdb-toggle="tab"
                aria-controls="service-orders-tab"
                aria-selected="false"
                class="nav-link">
                Tjenester
                <!-- <i class="fas fa-envelope fa-1x"></i>
                <span class="badge rounded-pill badge-notification bg-danger">99</span> -->
            </a>
        </li>
    </ul>

    <div class="tab-content" id="ex1-content">
        <div
            class="tab-pane fade show active"
            id="ex1-tabs-1"
            role="tabpanel"
            aria-labelledby="ex1-tab-1">
        <form id="inspectEventForm" class="mt-3">
            <input type="submit" style="display:none;" />
            <div>
                <div>
                    <div class="row mb-2">
                        {% comment %} <div class="col-12">
                            <label for="{{form.responsible.id_for_label}}" class="form-label">
                                <i class="fas fa-star"></i>&nbsp;
                                Ansvarlig
                            </label>
                            {{form.responsible}}
                        </div> {% endcomment %}
                        <div class="col-7">
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        {{ form.title|as_crispy_field }}
                                    </div>
                                    {% if form.title.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.title.errors }}
                                        </div>  
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        {{ form.title_en|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="form-outline form-control-md" id="startDateTime"
                                        data-mdb-default-date="{{object.start|date:'d.m.Y' }}" 
                                        data-mdb-default-time="{{object.start|date:'G:i' }}">
                                        <input type="text" class="form-control form-control-lg" id="startDateTimeInput" 
                                            value="{{ object.start|date:'d.m.Y G:i' }}"/>
                                        <label for="datetimepickerExample" class="form-label h5">Startdato og tidspunkt</label>
                                    </div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="form-outline form-control-md" id="endDateTime"
                                        data-mdb-default-date="{{object.end|date:'d.m.Y' }}" 
                                        data-mdb-default-time="{{object.end|date:'G:i' }}">
                                        <input type="text" class="form-control form-control-lg" id="endDateTimeInput" 
                                            value="{{ object.end|date:'d.m.Y G:i' }}" />
                                        <label for="datetimepickerExample" class="form-label h5">Sluttdato og tidspunkt</label>
                                    </div>
                                </div>
                                <div class="col-6 mt-2">
                                    <div class="form-group mb-3">
                                        {{ form.expected_visitors|as_crispy_field }}
                                    </div>
                                    {% if form.expected_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.expected_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-6 mt-2">
                                    <div class="form-group mb-3">
                                        {{ form.actual_visitors|as_crispy_field }}
                                    </div>
                                    {% if form.actual_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.actual_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <h4>Skjermvisning</h4>
                            <div class="mt-2">
                                <div class="row">
                                    <div class="col-lg-4 col-sm-12">
                                        <label class="d-block form-label">Vises på skjerm:</label>
                                        {{form.display_layouts}}
                                    </div>
                                    <div class="col-lg-8 col-sm-12">
                                        <div 
                                            class="form-group"
                                            id="display-layout-text-group"
                                            style="display:none;">
        
                                            <div>
                                                {{ form.display_text|as_crispy_field }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
        
                            </div> 
                            
                            <div class="row">
                                <div class="col-6">
                                    {{form.meeting_place|as_crispy_field}}
                                </div>
        
                                <div class="col-6">
                                    {{form.meeting_place_en|as_crispy_field}}
                                </div>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="rounded box-shadow-2 wb-bg-secondary p-4 mb-4">
                                <input type="hidden" name="{{ form.responsible.name }}" id="{{ form.responsible.id_for_label }}"
                                    value="{{form.responsible.value|default:''}}">
    
                                <label for="" class="d-block form-label">
                                    <i class="fas fa-star"></i>
                                    Hovedplanlegger
                                </label>
                                <h5 class="mb-2" id="mainPlannerName">
                                    {{ object.responsible }}
                                </h5>
                                {% if user|has_group:"planners" or user.is_superuser %}
                                <button class="wb-btn-main"
                                    id="setMainPlannerButton"
                                    type="button"
                                    d-trigger="triggerSetPlanner">
                                    Endre hovedplanlegger
                                </button>
                                {% endif %}
                            </div>

                            <div id="jsTreeSelects">
                                <div class="mt-3">
                                    <label for="{{ form.audience.id_for_label }}" class="form-label">
                                        <i class="fas fa-users"></i>&nbsp;
                                        Målgruppe
                                    </label>
                                    <div id="audience_jstree_select" class="dialog-popover-left-fix"></div>
                                    
                                    {% if form.audience.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.audience.errors }}
                                    </div>
                                    {% endif %}
                                </div>
    
                                <div class="mt-3">
                                    <label for="{{ form.arrangement_type.id_for_label }}" class="form-label select-label">
                                        <i class="fas fa-cog"></i>&nbsp;
                                        Arrangementstype
                                    </label>
                                    <div id="arrangement_type_jstree_select" class="dialog-popover-left-fix"></div>
                                    {% if form.arrangement_type.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.arrangement_type.errors }}
                                    </div>
                                    {% endif %}
                                </div>
    
                                <div class="form-group mt-3">
                                    <label>
                                        <i class="fas fa-cog"></i>&nbsp;
                                        Status
                                    </label>
                                    <div id="status_type_jstree_select" class="dialog-popover-left-fix"></div>
                                    {% if form.status_type.errors|length > 0 %}
                                    <div class="alert alert-danger">
                                        {{ form.status_type.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>                
                </div>
            </div>
        </form>
        </div>
        <div class="tab-pane fade" id="files-tab" role="tabpanel" aria-labelledby="ex1-tab-2">
            {% if object.arrangement.files.exists or object.files.exists %}
            
            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix">
                <div class="float-end">
                    <a class="btn wb-btn-main" d-trigger="triggerUploadFilesDialog"><i class="fas fa-upload"></i>&nbsp; Last opp fil(er)</a>
                </div>
            </div>
            {% endif %}

            <div data-mdb-perfect-scrollbar="true" data-mdb-handlers="click-rail" style="position: relative; max-height: 30em; overflow-y: scroll;">
                {% for file in object.arrangement.files.all %}
                    <div class="wb-bg-extra p-3 mt-2 rounded-pill" id="fileRow_{{file.pk}}">
                        <span><i class="fas fa-arrow-down"></i> <small class="me-2 fw-bold">Hentet fra arrangementet</small>&nbsp; {{file.filename}}</span>
                        <span class="float-end">
                            {% if user|has_group:"planners" or user.is_superuser %}
                            <a href="#" class="text-muted"
                                data-mdb-toggle="tooltip"
                                title="Denne filen kommer fra arrangementet og kan dermed bare slettes der">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                            
                            <a data-mdb-toggle="tooltip"
                                    class="ms-2 me-3"
                                    title="{% trans 'Download this file' %}"
                                    href="/media/{{file.file}}"
                                    download>
                                <i class="fas fa-download"></i>
                            </a>
                        </span>
                    </div>
                {% endfor %}


                <div class="mb-2">
                    {% for file in object.files.all %}
                        <div class="wb-bg-extra p-3 mt-2 rounded-pill" id="fileRow_{{file.pk}}">
                            <span>{{file.filename}}</span>
                            <span class="float-end">
                                <a href="#"
                                        d-trigger="deleteFile"
                                        d-arg-type_discriminator="event_serie"
                                        d-arg-file_id="{{file.pk}}">
                                    <i class="fas fa-trash"></i>
                                </a>

                                <a data-mdb-toggle="tooltip"
                                        class="ms-2 me-3"
                                        title="{% trans 'Download this file' %}"
                                        href="/media/{{file.file}}"
                                        download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert wb-bg-secondary">
                <h4 class="text-center">Ingen filer lastet opp her ennå!</h4>
                {% if user|has_group:"planners" or user.is_superuser %}
                <div class="row">
                    <div class="col text-center">
                        <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                        d-trigger="triggerUploadFilesDialog"
                        href="#">
                        <i class="fas fa-upload"></i>
                        Last opp
                    </a>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="tab-resources" role="tabpanel">
            <div class="row">
                <div class="col-lg-12 col-sm-12">
                    <div class=" mb-2 mt-4">
                        <label class="form-label">Rom</label>
                        {% if user|has_group:"planners" or user.is_superuser %}
                        <a class="btn btn-sm wb-btn-secondary wb-bg-secondary float-end"
                            d-trigger="triggerAddRooms"
                            type="button">
                            Legg til nye rom
                        </a>
                        {% endif %}
                    </div>
                    <hr>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                            <tbody id="roomsTableBody">
                                {% for room in object.rooms.all %}
                                <tr rowid="{{room.pk}}">
                                    <td>{{room}}</td>
                                    {% if user|has_group:"planners" or user.is_superuser %}
                                    <td>
                                        <a href="#" class="text-danger"
                                            data-mdb-toggle="tooltip"
                                            d-trigger="removeAssociation"
                                            title="{% trans 'Remove this room from the activity' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-details" role="tabpanel">
            <div class="form-group mb-3">
                <label class="form-label" for="{{ form.ticket_code.id_for_label }}">Billetkode</label>
                <input type="text"
                    class="form-control form-control-lg"
                    id="{{ form.ticket_code.id_for_label }}" 
                    value="{{ form.ticket_code.value|default:'' }}"
                    name="{{ form.ticket_code.name }}"
                    autocomplete="off"
                    />
            </div>
            {% if form.ticket_code.errors|length > 0 %}
                <div class="alert alert-danger">
                    {{ form.ticket_code.errors }}
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="notes-tab" role="tabpanel" aria-labelledby="notes-tab">
            {% if object.arrangement.notes.exists or object.notes.exists %}
                {% if user|has_group:"planners" or user.is_superuser %}
                <div class="clearfix">
                    <a class="btn wb-btn-main shadow-0 mb-2 float-end"
                        d-trigger="triggerNewNoteDialog">
                        <i class="fas fa-feather"></i>
                        Nytt notat
                    </a>
                </div>
                {% endif %}

                <div style="overflow-y: scroll; max-height: 30em;">
                    {% for note in object.arrangement.notes.all %}
                    <div class="p-3 border rounded-6 shadow-3 mt-2 wb-bg-secondary " id="note_{{note.pk}}">
                        {{note.content|safe}}

                        <hr>

                        <div class="clearfix">
                            <div class="float-start">
                                <i class="fas fa-arrow-down me-3 h3"></i>
                                {% if note.has_personal_information %}
                                    <i class="fas fa-shield-alt text-warning h3"></i> <strong>Inneholder <abbr class="me-3" title="Personlig identifiserende informasjon">PII</abbr></strong>
                                {% endif %}
                                <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created|date:'d.m.Y H:i' }}</em>
                            </div>
                            <div class="float-end">
                                <em><small> <i class="far fa-question-circle"></i> Notatet kommer fra arrangementet og kan bare redigeres/slettes der</small></em>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for note in object.notes.all %}
                    <div class="p-3 border rounded-6 shadow-3 mt-2" id="note_{{note.pk}}">
                        {{note.content|safe}}

                        <hr>

                        <div class="clearfix">
                            <div class="float-start">
                                {% if note.has_personal_information %}
                                    <i class="fas fa-shield-alt text-warning h3"></i> <strong>Inneholder <abbr class="me-3" title="Personlig identifiserende informasjon">PII</abbr></strong>
                                {% endif %}
                                <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created|date:'d.m.Y H:i' }}</em>
                            </div>
                            {% if user|has_group:"planners" or user.is_superuser %}
                            <div class="float-end">
                                <a href="#" class="btn wb-btn-secondary"
                                    d-trigger="deleteNote"
                                    d-arg-note_pk="{{ note.pk }}">
                                    <i class="fas fa-trash"></i>
                                </a>

                                <a href="#" class="btn wb-btn-secondary"
                                    d-trigger="updateNoteDialog"
                                    d-arg-note_pk="{{note.pk}}">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

            {% else %}
                <div class="alert wb-bg-secondary">
                    <h4 class="text-center">Ingen notater skrevet ennå!</h4>
                    {% if user|has_group:"planners" or user.is_superuser %}
                    <div class="row">
                        <div class="col text-center">
                            <a class="btn wb-btn-main text-center shadow-0 mb-2 center" style="margin:auto"
                            d-trigger="triggerNewNoteDialog">
                            <i class="fas fa-feather"></i>
                            Nytt notat
                        </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="ex1-tabs-4" role="tabpanel" aria-labelledby="ex1-tabs-4">
            {% if not object.is_buffer_event %}
                <div class="alert alert-info small">
                    Opprigg og nedrigg blir opprettet som egne hendelser før og etter aktiviteten.
                    <div>
                        Det betyr at om du endrer tidene på aktivitetene så vil denne forandringen også reflekteres her.
                        Vice versa så kan du også endre tidene her, og det vil endre tidene på rigging aktivitetene.
                    </div>
                </div>

                <table class="table table-bordered table-sm">
                    <thead></thead>
                    <tbody>
                        <tr>
                            <th colspan="3" class="fw-bold">
                                {% if object.buffer_before_event %}
                                <div class="clearfix">
                                    <h4 class="float-start mb-0">Opprigg</h4>

                                    <a href="#" 
                                        d-trigger="inspectOtherEvent"
                                        d-arg-event_id="{{ object.buffer_before_event.pk }}"
                                        class="btn btn-sm wb-btn-main float-end">
                                        Åpne aktivitet
                                    </a>
                                </div>
                                {% endif %}
                            </th>
                        </tr>

                        <tr>
                            <td colspan="2">
                                <div class="form-group">
                                    <label for="" class="form-label">Tittel</label>
                                    <input type="text" id="buffer_before_title" class="form-control form-control-lg" value="{{ form.before_buffer_title.value|default:'' }}" />
                                </div>
                                
                                <div class="form-group mt-2">
                                    <label for="" class="form-label">Dato</label>
                                    <input type="date" name="" id="buffer_before_date" class="form-control form-control-lg" value="{{ form.before_buffer_date.value|date:'Y-m-d' }}">
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <label for="" class="form-label">Fra</label>
                                <div class="form-outline">
                                    <input type="time" id="buffer_before_start" value="{{ form.before_buffer_start.value|date:'H:i' }}" class="form-control form-control-lg" />
                                </div>
                            </td>
                            <td>
                                <label for="" class="form-label">Til</label>
                                <div class="form-outline">
                                    <input type="time" id="buffer_before_end" value="{{ form.before_buffer_end.value|date:'H:i' }}" class="form-control form-control-lg" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th colspan="3" class="fw-bold" 
                            style="justify-content: center; align-items:center;">
                                {% if object.buffer_after_event %}
                                <h4 class="float-start mb-0">Nedrigg</h4>
                                <a href="#" class="btn btn-sm wb-btn-main float-end" 
                                    d-trigger="inspectOtherEvent"
                                    d-arg-event_id="{{ object.buffer_before_event.pk }}">
                                    Åpne aktivitet
                                </a>
                                {% endif %}
                            </th>
                        </tr>

                        <tr>
                            <td colspan="2">
                                <div class="form-group">
                                    <label for="" class="form-label">Tittel</label>
                                    <input type="text" id="buffer_after_title" class="form-control form-control-lg" value="{{ form.after_buffer_title.value|default:'' }}" />
                                </div>
                                
                                <div class="form-group mt-2">
                                    <label for="" class="form-label">Dato</label>
                                    <input type="date" name="" id="buffer_after_date" class="form-control form-control-lg"  value="{{ form.after_buffer_date.value|date:'Y-m-d' }}">
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <label for="" class="form-label">Fra</label>
                                <div class="form-outline">
                                    <input type="time" id="buffer_after_start" value="{{ form.after_buffer_start.value|date:'H:i' }}" class="form-control form-control-lg" />
                                </div>
                            </td>
                            <td>
                                <label for="" class="form-label">Til</label>
                                <div class="form-outline">
                                    <input type="time" id="buffer_after_end" value="{{ form.after_buffer_end.value|date:'H:i' }}" class="form-control form-control-lg" />
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            {% else %}
            <div class="p-3">
                <h3 class="text-center text-muted"><i class="fas fa-info-circle"></i></h3>
                <hr>
                <h6 class="text-center">Denne hendelsen er en opprigg/nedrigg hendelse for en annen hendelse og du kan dermed ikke definere opprigg/nedrigg tider på denne hendelsen.</h6>
                
                <h6 class="mt-4 text-center">
                    Om du ønsker å endre tider på opprigg/nedrigg så kan du redigere tiden på denne aktiviteten. Denne forandringen vil speiles 
                    til opprigg/nedrigg tidene definert på "hoved-aktiviteten" som disse rigg aktivitetene omhandler.
                </h6>

                <div class="d-flex justify-content-center">
                    <button class="btn wb-btn-secondary"
                            type="button"
                            d-trigger="inspectOtherEvent"
                            d-arg-event_id="{{ object.buffer_for.pk }}">
                        Åpne hovedaktivitet
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="tab-pane fade" id="service-orders-tab" role="tabpanel" aria-labelledby="service-orders-tab">
            {% if user|has_group:"planners" or user.is_superuser %}
            <div class="clearfix mb-2">
                <button class="btn wb-btn-main float-end" d-trigger="triggerOrderServiceDialog">
                    Bestill tjeneste(r)
                </button>
            </div>
            {% endif %}

            {% for provision in event.provisions.all %}
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex">
                                <div class="mb-0 wb-bg-secondary p-3 border">
                                    <h5 class="mb-0">Ordre #{{provision.related_to_order.id}}</h5>
                                    <div>{{provision.related_to_order.service.name}}</div>
                                    <div>
                                        {% if provision.related_to_order.state == "awaiting" %}
                                        <div class="badge badge-warning">
                                            <h5 class="mb-0">
                                                Venter behandling
                                            </h5>
                                        </div>
                                        {% elif provision.related_to_order.state == "cancelled" %}
                                            <div class="badge badge-dark">
                                                <h5 class="mb-0">
                                                    Kansellert
                                                </h5>
                                            </div>
                                        {% elif provision.related_to_order.state == "denied" %}
                                            <div class="badge badge-danger">
                                                <h5 class="mb-0">
                                                    Avvist
                                                </h5>
                                            </div>
                                        {% elif provision.related_to_order.state == "in_revision" %}
                                            <div class="badge badge-warning">
                                                <h5 class="mb-0">
                                                Revideres
                                                </h5>
                                            </div>
                                        {% elif provision.related_to_order.state == "changed" %}
                                            <div class="badge badge-warning">
                                                <h5 class="mb-0">
                                                Basis endret, venter bekreftelse
                                                </h5>
                                            </div>
                                        {% elif provision.related_to_order.state == "confirmed" %}
                                            <div class="badge badge-success">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-check"></i>
                                                    Bekreftet
                                                </h5>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                </div>
                                <div class="p-2 ms-2 me-2">
                                    <h5>Kommentar:</h5>
                                    <hr>
                                    <div class="text-muted">
                                        {{ provision.related_to_order.freetext_comment }}
                                    </div>
                                </div>
                            </div>


    
                            <div class="clearfix">
                                <button class="btn wb-btn-main btn-lg float-end me-2" d-trigger="triggerInspectServiceOrderDialog" d-arg-order_id="{{ provision.related_to_order.pk }}">
                                    Vis ordre
                                </button>
                            </div>
                        </div>

                        {% if provision.selected_personell.exists and provision.related_to_order.state == "confirmed" %}
                            <h5>Personell assignert til denne aktiviteten:</h5>
                            <ul>
                                {% for person in provision.selected_personell.all %}
                                    <li>{{person}}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    {% if user|has_group:"planners" or user.is_superuser %}
    <div class="clearfix border-top pt-3">
        <div class="float-start">
            <a href="#" class="btn wb-btn-blank"
                d-trigger="delete">
                <i class="fas fa-trash"></i>&nbsp; Slett denne aktiviteten
            </a>
        </div>
        <div class="float-end">
            <a href="#" class="btn wb-btn-secondary btn-lg"
                d-trigger="close">
                <i class="fas fa-times"></i>
                Avbryt
            </a>
            <a class="btn btn-lg wb-btn-main" type="button" d-trigger="save">
                <i class="fas fa-save"></i>&nbsp; Lagre
            </a>
        </div>
    </div>
    {% endif %}
</div>


<script type="module">
    import { JSTreeSelect } from "{% static 'js/jsTreeSelect.js' %}";

    new Dialog({
        managerName: '{{managerName}}',
        dialogId: '{{dialogId}}',
        discriminator: '{{discriminator}}',
        postInit: function (dialog) {
            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                dialog.querySelectorAll("input,select").forEach( (inputElement) => inputElement.setAttribute("disabled", "") );
            {% endif %}

            dialog.querySelectorAll("a[data-mdb-toggle='tab']")
                .forEach( (element) => {
                    element.addEventListener('click', (event) => {
                        dialog.data.currentlyActiveTab = event.target.id;
                    })
                } );

            let startDateTimePicker = new mdb.Datetimepicker(dialog.getElementById('startDateTime'), {
                timepicker: { format24: true },
                datepicker: { format: 'dd.mm.yyyy' },
                timepicker: { "format24": true }

            }); 
            let endDateTimePicker = new mdb.Datetimepicker(dialog.getElementById('endDateTime'), {
                timepicker: { format24: true },
                datepicker: { format: 'dd.mm.yyyy' },
                timepicker: { "format24": true }
            });

            dialog.data.audienceJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#audience_jstree_select'),
                initialSelected: { id: '{{ object.audience.id }}', text: '{{ object.audience.name }}', parent: '{{object.audience.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/audience/tree",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen målgruppe valgt ennå",
                selectFirstTimeButtonText: 'Velg målgruppe',
                changeSelectedValueButtonText: 'Endre målgruppe',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.arrangementTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#arrangement_type_jstree_select'),
                initialSelected: { id: '{{ object.arrangement_type.id }}', text: '{{ object.arrangement_type.name }}', parent: '{{object.arrangement_type.parent_id}}' },
                treeJsonSrcUrl: "/arrangement/arrangementtype/treelist",
                valueSelectedLabelText: ( selected) => { 
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");
                    
                    labelText += selected.text;

                    return labelText;
                },
                noneSelectedLabelText: "Ingen arrangementstype valgt ennå",
                selectFirstTimeButtonText: 'Velg arrangementstype',
                changeSelectedValueButtonText: 'Endre arrangementstype',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });
            dialog.data.statusTypeJsTreeSelect = new JSTreeSelect({
                element: dialog.querySelector('#status_type_jstree_select'),
                initialSelected: { id: '{{ object.status.id }}', text: '{{ object.status.name }}' },
                treeJsonSrcUrl: "/arrangement/statustype/tree",
                valueSelectedLabelText: ( selected ) => {
                    let labelText = '';

                    if (selected.parent && selected.parent.text)
                        labelText += (selected.parent.text + " | ");

                    labelText += selected.text;
                    
                    return labelText;
                },
                noneSelectedLabelText: "Ingen status valgt ennå",
                selectFirstTimeButtonText: 'Velg status',
                changeSelectedValueButtonText: 'Endre status',
                popoverSaveChoicesButtonText: 'Lagre valg',
            });

            {% if user|has_group:"readonly_level_2" and user.is_superuser == False %}
                document.querySelectorAll("#jsTreeSelects button").forEach( (buttonElement) => buttonElement.remove() );
            {% endif %}

            document.addEventListener("eventInspector.roomsUpdated", (e) => {
                dialog.data.roomsMap = e.detail.context.room_name_map;
                dialog.setRooms(e.detail.context.rooms);
            });
        },
        methods: {
            close: function (dialog, {} = {}, triggeredByElement) {
                dialog.closeAllDialogsInThisManagerGroup();
            },
            /* Open an event inspection dialog for another event */
            inspectOtherEvent: function (dialog, { eventId } = {}) {
                dialog.raiseTriggerEvent(dialog.managerName, "{{dialogId}}", { pk: eventId });
            },
            /* Delete a file, identified by the given fileId */
            deleteFile: (dialog, { fileId } = {}) => {
                fetch(`/arrangement/event/{{object.pk}}/files/${fileId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(a => a.text())
                  .then(a => dialog.$('#fileRow_' + fileId).remove());
            },
            /* Open dialog for editing a note, identified by note_pk */
            updateNoteDialog: (dialog, { notePk } = {}) => {
                dialog.raiseTriggerEvent("eventInspector", "editNoteDialog", { "note_pk": notePk, $parent: dialog.dialogElement });
            },
            triggerNewNoteDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("eventInspector", "newNoteDialog", { $parent: dialog.dialogElement });
            },
            triggerOrderServiceDialog(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("eventInspector", "orderServiceDialog", { entity_type: "event" });
            },
            triggerInspectServiceOrderDialog(dialog, { orderId } = {}, triggeredByElement) {
                dialog.raiseTriggerEvent("eventInspector", "inspectServiceOrderDialog", { "order_id": orderId });
            },
            /* Delete a note, identified by note_pk */
            deleteNote: (dialog, { notePk } = {}) => {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Er du sikker på at du ønsker å slette dette notatet?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Slett',
                    cancelButtonText: 'Avbryt',
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/arrangement/note/delete/' + notePk, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{csrf_token}}',
                            }
                        }).then(response => { dialog.$('#note_' + notePk).remove(); });     
                    }
                });
            },
            /* Check if the form is valid, the resulting bool is True if yes, False if not */
            validate: (dialog) => {
                let field_elements = dialog.$("input, select");

                let isInvalid = false;

                for (let i = 0; i < field_elements.length; i++) {
                    if (field_elements[i].checkValidity() === false) {
                        isInvalid = true;
                        break;
                    }
                }

                if (isInvalid) {
                    dialog.$('#inspectEventForm').find(':submit').click();
                    return false;
                }

                return true;
            },
            /* Set rooms */
            setRooms: (dialog, rooms) => {
                let tbody = dialog.$('#roomsTableBody');
                tbody.empty();

                rooms.split(",").forEach(id => {
                    tbody.append(
                        $(`<tr rowid='${id}'>
                            <td>${dialog.data.roomsMap.get(id)}</td>
                            {% if user|has_group:"planners" or user.is_superuser %}
                            <td>
                                <a href="#" class="text-danger"
                                            data-mdb-toggle="tooltip"
                                            d-trigger="removeAssociation"
                                            title="{% trans 'Remove this room from the activity' %}">
                                            <i class="fas fa-trash"></i>
                            </td>
                            {% endif %}
                        </tr>`));
                });
            },
            /* Remove association from DOM */
            removeAssociation: (dialog, {}, triggeredByElement) => {
                let row = $(triggeredByElement).closest("tr");
                row.remove();
            },
            /* Gets and returns an array containing the IDs of all selected rooms */
            getSelectedRoomIds: (dialog) => {
                return Array.from(dialog.$("#roomsTableBody")[0].children)
                                    .map(row => row.getAttribute("rowid"))
            },
            /* Open dialog for inspecting an arrangement */
            openInspectArrangementDialog: (dialog, { slug, eventPk } = {}) => {
                document.dispatchEvent(
                    new CustomEvent(
                        "plannerCalendar.inspectThisArrangement",
                        { detail: { slug: slug, event_pk: eventPk } }
                    )
                )
            },
            /* Delete this current event */
            delete: (dialog) => {
                Swal.fire({
                    title: 'Er du sikker?',
                    text: "Hendelsen kan ikke hentes tilbake.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ja',
                    cancelButtonText: 'Avbryt'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let formData = new FormData();
                        formData.append("eventIds", "{{object.pk}}");

                        fetch('/arrangement/planner/delete_events/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                "X-CSRFToken": '{{ csrf_token }}',
                            }
                        }).then(_ => {
                            dialog.closeMe();
                            document.dispatchEvent(new Event("plannerCalendar.refreshNeeded"));
                        });
                    }
                })
            },
            /* Save the changes made to this event */
            save: (dialog) => {
                if (dialog.validate() === false) {
                    return;
                }

                const getDateISOStringFromMdbDateTimePickerInstance = function (mdbDatetimePicker) {
                    let [ day, month, year ] = mdbDatetimePicker._dateValue.split(".");
                    let isoStrCandidate = new Date(`${month}/${day}/${year} ` + mdbDatetimePicker._timeValue);

                    return isoStrCandidate.toISOString();
                }
                let dateTimeStartMdbInstance = mdb.Datetimepicker.getInstance(dialog.getElementById("startDateTime"));
                let dateTimeEndMdbInstance = mdb.Datetimepicker.getInstance(dialog.getElementById("endDateTime"));

                let qualifiedEvent = {
                    id:                 '{{object.pk}}',
                    title:              dialog.interior.id_title.value,
                    title_en:           dialog.interior.id_title_en.value,
                    ticket_code:        dialog.interior.id_ticket_code.value,
                    start:              getDateISOStringFromMdbDateTimePickerInstance(dateTimeStartMdbInstance),
                    end:                getDateISOStringFromMdbDateTimePickerInstance(dateTimeEndMdbInstance),
                    audience:           dialog.data.audienceJsTreeSelect.getSelectedValue(),
                    arrangement_type:   dialog.data.arrangementTypeJsTreeSelect.getSelectedValue(),
                    expected_visitors:  dialog.interior.id_expected_visitors.value,
                    actual_visitors:    dialog.interior.id_actual_visitors.value,
                    arrangement:        '{{object.arrangement.pk}}',
                    rooms:              dialog.getSelectedRoomIds(),    
                    status:             dialog.data.statusTypeJsTreeSelect.getSelectedValue(),
                    display_layouts:    [...dialog.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked")]
                                            .map(element => element.value),
                                            
                    before_buffer_title:    dialog.interior.buffer_before_title != undefined ? dialog.interior.buffer_before_title.value : "",
                    before_buffer_date:     dialog.interior.buffer_before_date != undefined ? dialog.interior.buffer_before_date.value : "",
                    before_buffer_start:    dialog.interior.buffer_before_start != undefined ? dialog.interior.buffer_before_start.value : "", 
                    before_buffer_end:      dialog.interior.buffer_before_end != undefined ? dialog.interior.buffer_before_end.value : "",
                    
                    after_buffer_title:     dialog.interior.buffer_after_title != undefined ? dialog.interior.buffer_after_title.value : "",
                    after_buffer_date:      dialog.interior.buffer_after_date != undefined ? dialog.interior.buffer_after_date.value : "",
                    after_buffer_start:     dialog.interior.buffer_after_start != undefined ? dialog.interior.buffer_after_start.value : "",
                    after_buffer_end:       dialog.interior.buffer_after_end != undefined ? dialog.interior.buffer_after_end.value : "",

                    responsible:            dialog.interior.id_responsible.value,
                    meeting_place:          dialog.interior.id_meeting_place.value,
                    meeting_place_en:       dialog.interior.id_meeting_place_en.value,
                    display_text:           dialog.plugins.showIfSelected.isInShowState() ? dialog.interior.id_display_text.value : '',
                };

                dialog.raiseSubmitEvent({
                    event: qualifiedEvent,
                    csrf_token: '{{ csrf_token }}',
                });
            },
            triggerUploadFilesDialog(dialog, {}={}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "uploadFilesDialog", { $parent: dialog.dialogElement });
            },
            triggerAddRooms(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "orderRoomDialog", { $parent: dialog.dialogElement, sendTo: '{{ dialogId }}' });
            },
            triggerSetPlanner(dialog, {} = {}, triggeredByElement) {
                dialog.raiseTriggerEvent(dialog.managerName, "orderPersonDialog", { $parent: dialog.dialogElement, sendTo: '{{dialogId}}', multiple: false, data: { whenEventName: "setPlanner" } })
            },
        },
        data: {
            roomsMap: new Map(),
        },
        when: [
            { eventKnownAs: "setPlanner", do: (dialog, payload) => {
                if (payload.allSelectedEntityIds.length == 0)
                    return;

                const person = payload.viewables[0];
                
                dialog.getElementById('{{ form.responsible.id_for_label }}').value = person.id;
                dialog.getElementById('mainPlannerName').innerText = person.text;
            } },
            { eventKnownAs: "roomsSelected", do: (dialog, payload) => {
                dialog.data.roomsMap = new Map(
                    payload.allSelectedEntityIds.map(x => [x.id, x.text])
                );
                dialog.setRooms(payload.allSelectedEntityIds.map(x => x.id).join(","));
            } },
        ],
        plugins: [
            {
                name: 'showIfSelected',
                pluginClass: DialogShowIfSelectedPlugin,
                args: {
                    checkboxesSelector: "[name='display_layouts']",
                    elementToShowOrHide: ( dialog ) => { return dialog.getElementById('display-layout-text-group'); },
                    showIfAnyOfTheseValuesMap: new Map([
                        {% for display_layout in DISPLAY_LAYOUTS_WITH_REQUISITE_TEXT %}
                            [ "{{ display_layout.id }}", true],
                        {% endfor %}
                    ]),
                },
            },
            {
                name: "syncDataToManager",
                pluginClass: SyncDialogDataToManagerContextPlugin,
            }
        ]
    })

    $(document).ready(function () {
        const roomAsyncFilter = async (query) => {
            const url = `{% url "arrangement:search_room_ajax_view" %}?term=${encodeURI(query)}`;
            const response = await fetch(url);
            const data = JSON.parse(await response.json());

            let rooms = [];
            for (let i = 0; i < data.length; i++) {
                let entry = data[i]
                entry.fields.id = entry.pk;
                if (roomsMap.has(entry.fields.id) !== true) {
                    rooms.push(entry.fields);
                }
            }

            return rooms;
        };
    })
</script>
