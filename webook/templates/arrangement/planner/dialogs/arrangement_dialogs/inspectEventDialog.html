{% load static i18n %}


<div id="inspectEventDialog" title="Rediger aktivitet {{ form.title.value }}">
    
    <div class="clearfix">
        <!-- <div class="float-end">
            {% if event.serie %}
            <span class="badge badge-secondary shadow-2"
                data-mdb-toggle="tooltip"
                title="Aktiviteten er en del av en serie">
                <h4 class="mb-0"><i class="fas fa-redo"></i></h4>
            </span>
            {% elif event.associated_serie and event.association_type == "degraded_from_serie" %}
            <span class="badge badge-warning shadow-2"
                data-mdb-toggle="tooltip"
                title="Aktiviteten er brutt ut av en serie">
                <h4 class="mb-0"><i class="fas fa-redo"></i> <i class="fas fa-times"></i></h4>
            </span>
            {% else %}
            <span class="badge badge-success shadow-2"
                data-mdb-toggle="tooltip"
                title="Aktiviteten er enkeltstående, det vil si ikke del av en serie">
                <h4 class="mb-0"><i class="fas fa-calendar"></i></h4>
            </span>
            {% endif %}
            
            {% if object.is_buffer_event %}
            <span class="badge badge-warning shadow-2"
                data-mdb-toggle="tooltip"
                title="Denne aktiviteten er en opprigg/nedrigg hendelse">
                <h4 class="mb-0"><i class="fas fa-tools"></i></h4>
            </span>
            {% endif %}
        </div> -->
    </div>

    <ul class="nav nav-tabs mb-3" id="ex1" role="tablist">
<div id="inspectEventDialog" title="{{ form.title.value }}">
    <ul class="nav nav-tabs webook-tabs mb-3" id="ex1" role="tablist">
        <li class="nav-item" role="presentation">
            <a
            class="nav-link active"
            id="ex1-tab-1"
            data-mdb-toggle="tab"
            href="#ex1-tabs-1"
            role="tab"
            aria-controls="ex1-tabs-1"
            aria-selected="true">
            Aktivitet
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a href="#tab-resources" role="tab" data-mdb-toggle="tab" class="nav-link" id="tab-resource">
                Rom & Personer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-2"
                data-mdb-toggle="tab"
                href="#ex1-tabs-2"
                role="tab"
                aria-controls="ex1-tabs-2"
                aria-selected="false">
                Filer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-3"
                data-mdb-toggle="tab"
                href="#ex1-tabs-3"
                role="tab"
                aria-controls="ex1-tabs-3"
                aria-selected="false">
                Notater
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a href="#tab-details" role="tab" data-mdb-toggle="tab" class="nav-link" id="tab-detailss">
                Detaljer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-4"
                data-mdb-toggle="tab"
                href="#ex1-tabs-4"
                role="tab"
                aria-controls="ex1-tabs-3"
                aria-selected="false"
                >Opprigg & Nedrigg
            </a>
        </li>
    </ul>

    <div class="tab-content" id="ex1-content">
        <div
            class="tab-pane fade show active"
            id="ex1-tabs-1"
            role="tabpanel"
            aria-labelledby="ex1-tab-1">
        <form id="inspectEventForm" class="mt-3">
            <input type="submit" style="display:none;" />
            <div>
                <div>

                    <div class="row">
                        <div class="col-lg-6 col-sm-12">
                            <div class="form-group">
                                <label class="form-label" for="{{ form.title.id_for_label }}">Tittel på norsk</label>
                                <input type="text"
                                    class="form-control form-control-md"
                                    id="{{ form.title.id_for_label }}" 
                                    value="{{ form.title.value|default:'' }}"
                                    name="{{ form.title.name }}"
                                    autocomplete="off"
                                    />
                            </div>
                            {% if form.title.errors|length > 0 %}
                                <div class="alert alert-danger">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <div class="">
                                <div class="form-group">
                                    <label class="form-label" for="{{ form.title_en.id_for_label }}">Tittel på engelsk</label>
                                    <input type="text"
                                        class="form-control form-control-md"
                                        id="{{ form.title_en.id_for_label }}" 
                                        value="{{ form.title_en.value|default:'' }}"
                                        name="{{ form.title_en.name }}"
                                        autocomplete="off"
                                        />
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <div >
                                    <div class="form-group mb-3">
                                        <label class="form-label" for="{{ form.expected_visitors.id_for_label }}">Forventet besøk</label>
                                        <input type="text"
                                            class="form-control form-control-md"
                                            id="{{ form.expected_visitors.id_for_label }}" 
                                            value="{{ form.expected_visitors.value|default:'0' }}"
                                            name="{{ form.expected_visitors.name }}"
                                            autocomplete="off"
                                            />
                                    </div>
                                    {% if form.expected_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.expected_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <div>
                                    <div class="form-group mb-3">
                                        <label class="form-label" for="{{ form.actual_visitors.id_for_label }}">Faktisk besøk</label>
                                        <input type="text"
                                            class="form-control form-control-md"
                                            id="{{ form.actual_visitors.id_for_label }}" 
                                            value="{{ form.actual_visitors.value|default:'0' }}"
                                            name="{{ form.actual_visitors.name }}"
                                            autocomplete="off"
                                            />
                                    </div>
                                    {% if form.actual_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.actual_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-6">
                                <div class="form-outline datetimepicker" id="startDateTime"
                                    data-mdb-default-date="{{object.start|date:'m/d//Y' }}" 
                                    data-mdb-default-time="{{object.start|date:'G:i:s' }}">
                                    <input type="text" class="form-control" id="startDateTimeInput" 
                                        value="{{ object.start|date:'d.m.Y G:i' }}"/>
                                    <label for="datetimepickerExample" class="form-label h5">Startdato og tidspunkt</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-outline datetimepicker" id="endDateTime"
                                    data-mdb-default-date="{{object.end|date:'m/d/Y' }}" 
                                    data-mdb-default-time="{{object.end|date:'G:i:s' }}">
                                    <input type="text" class="form-control" id="endDateTimeInput" 
                                        value="{{ object.end|date:'d.m.Y G:i' }}" />
                                    <label for="datetimepickerExample" class="form-label h5">Sluttdato og tidspunkt</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="d-block form-label">{% trans "Vises på skjerm:" %}</label>
                        {{form.display_layouts}}
                    </div>  
    
                    <div class="alert col-auto mb-4 mt-2 wb-bg-secondary">
                        <div class="clearfix">
                            <div class="float-start">
                                <h6 class="mb-0 d-inline fw-lighter">Tilhører arrangement:</h4>
                                <h4 class="mb-0">{{ object.arrangement.name }}</h6>
                            </div>
                            <button class="btn wb-btn-main float-end shadow-0"
                                    type="button"
                                    onclick="triggerFocusTo('{{object.arrangement.slug}}', '{{object.pk}}')">
                                Gå til arrangement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        </div>
        <div class="tab-pane fade" id="ex1-tabs-2" role="tabpanel" aria-labelledby="ex1-tab-2">
            <div class="clearfix">
                <div class="float-end">
                    <a class="btn wb-btn-main" id="eventDialog_uploadFilesBtn"><i class="fas fa-upload"></i>&nbsp; Last opp fil(er)</a>
                </div>
            </div>
            <div>
                <table class="table w-100" id="inspectEventDialog__filesTable">
                    <thead>
                        <tr>
                            <th>Filnavn</th>
                            <th>Lastet opp</th>
                            <th>Valg</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in object.files.all %}
                            <tr id="fileRow_{{file.pk}}">
                                <td>{{file.filename}}</td>
                                <td><i class="text-muted">Av {{file.uploader.full_name}} den {{file.created}}</i></td>
                                <td>
                                    <a class="btn wb-btn-secondary rounded-pill" href="/media/{{file.file}}" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <a class="btn wb-btn-secondary rounded-pill"
                                        onclick="inspectEventDialog__deleteFile( {{file.pk}} )">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-resources" role="tabpanel">
            <div class="row">
                <div class="col-lg-6 col-sm-12">
                    <div class=" mb-2 mt-4">
                        <label class="form-label">Rom</label>
                        <a class="btn btn-sm btn-link wb-bg-secondary float-end"
                            id="inspectEventDialog_addRoomsBtn"
                            type="button">
                            Legg til nye rom
                        </a>
                    </div>
                    <hr>
        
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                            <tbody id="roomsTableBody">
                                {% for room in object.rooms.all %}
                                <tr rowid="{{room.pk}}">
                                    <td>{{room}}</td>
                                    <td>
                                        <a href="#" class="text-danger"
                                            data-mdb-toggle="tooltip"
                                            onclick="inspectEventDialog__removeAssociation(this)"
                                            title="{% trans 'Remove this room from the activity' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-6 col-sm-12">
                    <div class="cmb-2 mt-4">
                        <label class="form-label">Personer</label>
                        <a class="btn btn-sm btn-link wb-bg-secondary float-end"
                            id="inspectEventDialog_addPeopleBtn"
                            type="button">
                            Legg til nye personer
                        </a>
                    </div>
        
                    <hr>
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                            <tbody id="peopleTableBody">
                                {% for person in object.people.all %}
                                    <tr rowid="{{person.pk}}">
                                        <td>{{person}}</td>
                                        <td>
                                            <a href="#" class="text-danger"
                                                data-mdb-toggle="tooltip"
                                                onclick="inspectEventDialog__removeAssociation(this)"
                                                title="{% trans 'Remove this person from the activity' %}">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-details" role="tabpanel">
            <div class="form-group mb-3">
                <label class="form-label" for="{{ form.ticket_code.id_for_label }}">Billetkode</label>
                <input type="text"
                    class="form-control form-control-md"
                    id="{{ form.ticket_code.id_for_label }}" 
                    value="{{ form.ticket_code.value|default:'' }}"
                    name="{{ form.ticket_code.name }}"
                    autocomplete="off"
                    />
            </div>
            {% if form.ticket_code.errors|length > 0 %}
                <div class="alert alert-danger">
                    {{ form.ticket_code.errors }}
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="ex1-tabs-3" role="tabpanel" aria-labelledby="ex1-tabs-3">
            <div class="clearfix">
                <a class="btn wb-btn-main shadow-0 mb-2 float-end" id="inspectEventDialog__newNoteBtn">
                    <i class="fas fa-feather"></i>
                    Nytt notat
                </a>
            </div>

            {% for note in object.notes.all %}
            <div class="shadow-3 p-3 border-bottom {% if note.has_personal_information %}border-warning{% else %}border-success{% endif %}" id="note_{{note.pk}}">
                {{note.content|safe}}

                <div class="clearfix">
                    <em class="text-muted small float-start"></em>
                    <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created }}</em>
                </div>
                
                <hr>

                <div class="clearfix">
                    <div class="float-end">
                        <a href="#" class="btn wb-btn-secondary"
                            onclick="deleteNote( {{note.pk}} )">
                            <i class="fas fa-trash"></i>
                        </a>

                        <a href="#" class="btn wb-btn-secondary"
                            onclick="updateNoteDialog( {{note.pk}} )">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>

                    {% if note.has_personal_information %}
                        <i class="fas fa-shield-alt text-warning h3 float-start"></i> 
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="tab-pane fade" id="ex1-tabs-4" role="tabpanel" aria-labelledby="ex1-tabs-4">
            {% if not object.is_buffer_event %}
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle"></i>
                    Rigg "buffere" blir opprettet som egne hendelser før og etter aktiviteten.
                    <div>
                        Det betyr at om du endrer tidene på aktivitetene så vil denne forandringen også reflekteres her.
                        Vis versa så kan du også endre tidene her, og det vil endre tidene på rigging aktivitetene.
                    </div>
                </div>

                <table class="table table-bordered table-sm">
                    <thead></thead>
                    <tbody>
                        <tr style="background-color: whitesmoke;">
                            <th colspan="3" class="fw-bold">
                                {% if object.buffer_before_event %}
                                <div class="clearfix">
                                    <h5 class="float-start mb-0">Opprigg</h6>

                                    <div class="float-end">
                                        <a href="#" onclick="inspectEventDialog__inspectOtherEvent({{object.buffer_before_event.pk}})" class="btn btn-sm btn-white">Åpne aktivitet</a>
                                    </div>
                                </div>
                                {% endif %}
                            </th>
                        </tr>

                        <tr>
                            <td>
                                Fra
                                <div class="form-outline">
                                    <input type="time" id="buffer_before_start" value="{{ form.before_buffer_start.value|date:'H:i' }}" class="form-control" />
                                </div>
                            </td>
                            <td>
                                Til
                                <div class="form-outline">
                                    <input type="time" id="buffer_before_end" value="{{ form.before_buffer_end.value|date:'H:i' }}" class="form-control" />
                                </div>
                            </td>
                        </tr>
                        <tr style="background-color: whitesmoke;">
                            <th colspan="3" class="fw-bold" 
                            style="justify-content: center; align-items:center;">
                                {% if object.buffer_after_event %}
                                <h5 class="float-start mb-0">Nedrigg</h5>
                                <a href="#" class="btn btn-sm btn-white float-end" onclick="inspectEventDialog__inspectOtherEvent({{object.buffer_after_event.pk}})">Åpne aktivitet</a>
                                {% endif %}
                            </th>
                        </tr>

                        <tr>
                            <td>
                                Fra
                                <div class="form-outline">
                                    <input type="time" id="buffer_after_start" value="{{ form.after_buffer_start.value|date:'H:i' }}" class="form-control" />
                                </div>
                            </td>
                            <td>
                                Til
                                <div class="form-outline">
                                    <input type="time" id="buffer_after_end" value="{{ form.after_buffer_end.value|date:'H:i' }}" class="form-control" />
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            {% else %}
            <div class="p-3">
                <h3 class="text-center text-muted"><i class="fas fa-info-circle"></i></h3>
                <hr>
                <h6 class="text-center">Denne hendelsen er en opprigg/nedrigg hendelse for en annen hendelse og du kan dermed ikke definere opprigg/nedrigg tider på denne hendelsen.</h6>
                
                <h6 class="mt-4 text-center">
                    Om du ønsker å endre tider på opprigg/nedrigg så kan du redigere tiden på denne aktiviteten. Denne forandringen vil speiles 
                    til opprigg/nedrigg tidene definert på "hoved-aktiviteten" som disse rigg aktivitetene omhandler.
                </h6>

                <div class="d-flex justify-content-center">
                    <button class="btn wb-btn-secondary"
                        onclick="inspectEventDialog__inspectOtherEvent({{ object.buffer_for.pk }})">
                        Åpne hovedaktivitet
                    </button>
                </div>

            </div>
            {% endif %}
        </div>
    </div>

    <div class="clearfix border-top pt-3">
        <div class="float-start">
            <a href="#" class="btn btn-link" onclick="inspectEventDialog__delete()">
                <i class="fas fa-trash"></i>&nbsp; Slett denne aktiviteten
            </a>
        </div>
        <div class="float-end">
            <a href="#" class="btn wb-btn-secondary btn-lg"
                onclick="window.dialogApi.close('eventInspector', 'inspectEventDialog')">
                <i class="fas fa-times"></i>
                Avbryt
            </a>
            <a class="btn btn-md wb-btn-main" type="button" onclick="inspectEventDialog__save()"><i class="fas fa-save"></i>&nbsp; Lagre</a>
        </div>
    </div>
</div>

<script>
    var peopleMap = new Map();
    var roomsMap = new Map();

    function inspectEventDialog__inspectOtherEvent(eventId) {
        document.dispatchEvent(
            new CustomEvent("eventInspector.inspectEventDialog.trigger", { "detail": {
                pk: eventId
            }})
        )
    }

    function inspectEventDialog__deleteFile(fileId) {
        fetch(`/arrangement/event/{{object.pk}}/files/${fileId}/delete`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(a => a.text()).then(a =>  document.getElementById('fileRow_' + fileId).remove() );
    }

    function updateNoteDialog(note_pk) {
        document.dispatchEvent(
            new CustomEvent("eventInspector.editNoteDialog.trigger", { "detail": {
                "note_pk": note_pk
            }})
        )
    }

    function deleteNote(note_pk) {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Er du sikker på at du ønsker å slette dette notatet?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Slett',
            cancelButtonText: 'Avbryt',
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/arrangement/note/delete/' + note_pk, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{csrf_token}}',
                    }
                }).then(response => { document.getElementById('note_' + note_pk).remove(); });     
            }
        });
    }

    function inspectEventDialog__evaluateEnTitleObligatory() {
        let $enTitleElement = $('#id_title_en');
        let countSeletedDisplayLayouts = $("input[name='display_layouts'][type='checkbox']:checked").length;

        if (countSeletedDisplayLayouts === 0) {
            $enTitleElement.removeAttr("required");
        }
        else {
            $enTitleElement.attr("required", true);
        }
    }

    function inspectEventDialog__validate() {
        let field_elements = $('#inspectEventForm').find("input, select");

        let isInvalid = false;

        for (let i = 0; i < field_elements.length; i++) {
            if (field_elements[i].checkValidity() === false) {
                isInvalid = true;
                break;
            }
        }

        if (isInvalid) {
            $('#inspectEventForm').find(':submit').click();
            return false;
        }

        return true;
    }

    $(document).ready(function () {
        new mdb.Datetimepicker(document.getElementById('startDateTime', {
            container: '#inspectEventDialog',
            format: 'dd-mm-yyyy',
        }));
        new mdb.Datetimepicker(document.getElementById('endDateTime', {
            container: '#inspectEventDialog',
            format: 'dd-mm-yyyy',
        }));

        document.addEventListener("eventInspector.roomsUpdated", (e) => {
            roomsMap = e.detail.context.room_name_map;
            inspectEventDialog__setRooms(e.detail.context.rooms);
        })
        document.addEventListener("eventInspector.peopleUpdated", (e) => {
            peopleMap = e.detail.context.people_name_map;
            inspectEventDialog__setPeople(e.detail.context.people);
        });
    })

    function inspectEventDialog__removeAssociation(a) {
        let row = $(a).closest("tr");
        row.remove();
    }

    function inspectEventDialog__setRooms(rooms) {
        let tbody = $('#roomsTableBody');
        tbody.empty();

        rooms.split(",").forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${roomsMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this room from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__setPeople(people) {
        let tbody = $('#peopleTableBody');
        tbody.empty();

        people.split(",").forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${peopleMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this person from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__getSelectedRoomIds() {
        let room_ids = Array.from($("#roomsTableBody")[0].children).map(row => row.getAttribute("rowid"));
        return room_ids;
    }

    function inspectEventDialog__getSelectedPeopleIds() {
        let people_ids = Array.from($("#peopleTableBody")[0].children).map(row => row.getAttribute("rowid"));
        return people_ids;
    }

    function inspectEventDialog__delete() {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Hendelsen kan ikke hentes tilbake.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                let formData = new FormData();
                formData.append("eventIds", "{{object.pk}}");

                fetch('/arrangement/planner/delete_events/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}',
                    }
                }).then(_ => {
                    document.dispatchEvent(new Event("eventInspector.close"));
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded"));
                });
            }
        })
    }

    function inspectEventDialog__save() {
        if (inspectEventDialog__validate() === false) {
            return;
        }

        const getDateISOStringFromMdbDateTimePickerInstance = function (mdbDatetimePicker) {
            let isoStr = (mdbDatetimePicker._datepicker._selectedDate ??
                            new Date(mdbDatetimePicker._dateValue + " " + mdbDatetimePicker._timeValue)).toISOString();
            return isoStr;
        }

        let dateTimeStartMdbInstance = mdb.Datetimepicker.getInstance(document.getElementById('startDateTime'));
        let dateTimeEndMdbInstance = mdb.Datetimepicker.getInstance(document.getElementById('endDateTime'));

        let $dialog = $('#inspectEventDialog');
        let qualifiedEvent = {
            id:                 '{{object.pk}}',
            title:              $dialog.find('#id_title').val(),
            title_en:           $dialog.find('#id_title_en').val(),
            ticket_code:        $dialog.find('#id_ticket_code').val(),
            start:              getDateISOStringFromMdbDateTimePickerInstance(dateTimeStartMdbInstance),
            end:                getDateISOStringFromMdbDateTimePickerInstance(dateTimeEndMdbInstance),
            expected_visitors:  $dialog.find('#id_expected_visitors').val(),
            actual_visitors:    $dialog.find('#id_actual_visitors').val(),
            arrangement:        '{{object.arrangement.pk}}',
            people:             inspectEventDialog__getSelectedPeopleIds(),
            rooms:              inspectEventDialog__getSelectedRoomIds(),
            display_layouts:    [...document.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked")]
                                    .map(element => element.value),
            before_buffer_start:$dialog.find('#buffer_before_start').val() != undefined ? $('#buffer_before_start').val() : "",
            before_buffer_end:  $dialog.find('#buffer_before_end').val() != undefined ? $('#buffer_before_end').val() : "",
            after_buffer_start: $dialog.find('#buffer_after_start').val() != undefined ? $('#buffer_after_start').val() : "",
            after_buffer_end:   $dialog.find('#buffer_after_end').val() != undefined ? $('#buffer_after_end').val() : "",
        };

        document.dispatchEvent(
            new CustomEvent("eventInspector.submit", { "detail": {
                dialog: "inspectEventDialog",
                event: qualifiedEvent,
                csrf_token: '{{ csrf_token }}',
            }})
        );
    }

    function triggerFocusTo(slug, event_pk) {
        document.dispatchEvent(
            new CustomEvent(
                "plannerCalendar.inspectThisArrangement",
                { detail: { slug: slug, event_pk: event_pk } }
            )
        )
    }

    function removePerson(el) {
      let key = $(el).attr("person-key");
      peopleMap.delete(parseInt(key));
      el.remove();
    }

    function removeRoom(el) {
      let key = $(el).attr("room-key");
      roomsMap.delete(parseInt(key));
      el.remove();
    }

    $(document).ready(function () {
        const personAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_people_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let people = []
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (peopleMap.has(entry.fields.id) !== true) {
            people.push(entry.fields)
          }
        }

        return people;
      };

      const roomAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_room_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let rooms = [];
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (roomsMap.has(entry.fields.id) !== true) {
            rooms.push(entry.fields);
          }
        }

        return rooms;
      };
    })
</script>
