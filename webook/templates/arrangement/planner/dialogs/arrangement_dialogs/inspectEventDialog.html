{% load static i18n %}


<div id="inspectEventDialog" title="<span class='badge badge-success'><i class='fas fa-edit'></i></span>&nbsp; Rediger aktivitet {{ form.title.value }}">
    <button class="btn btn-danger mb-3" onclick="inspectEventDialog__delete()"><i class="fas fa-trash"></i>&nbsp; Slett</button>

    <div class="alert border col-auto  mb-4">
        <div class="row">
            <div class="col-6">
                <h4 class="mb-0 d-inline fw-lighter">Aktivitet i:</h4>
                <h6 class="mb-0  fw-bolder">{{ object.arrangement.name }}</h6>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-dark"
                        onclick="triggerFocusTo('{{object.arrangement.slug}}', '{{object.pk}}')">
                    칀pne arrangement
                </button>
            </div>
        </div>
    </div>

    <div class="mb-3">
        {% if event.serie %}
        <span class="badge badge-secondary shadow-2"
            data-mdb-toggle="tooltip"
            title="Aktiviteten er en del av en serie">
            <h4 class="mb-0"><i class="fas fa-redo"></i></h4>
        </span>
        {% elif event.associated_serie and event.association_type == "degraded_from_serie" %}
        <span class="badge badge-warning shadow-2"
            data-mdb-toggle="tooltip"
            title="Aktiviteten er brutt ut av en serie">
            <h4 class="mb-0"><i class="fas fa-redo"></i> <i class="fas fa-times"></i></h4>
        </span>
        {% else %}
        <span class="badge badge-success shadow-2"
            data-mdb-toggle="tooltip"
            title="Aktiviteten er enkeltst친ende, det vil si ikke del av en serie">
            <h4 class="mb-0"><i class="fas fa-calendar"></i></h4>
        </span>
        {% endif %}
    </div>

    <ul class="nav nav-tabs mb-3" id="ex1" role="tablist">
        <li class="nav-item" role="presentation">
            <a
            class="nav-link active"
            id="ex1-tab-1"
            data-mdb-toggle="tab"
            href="#ex1-tabs-1"
            role="tab"
            aria-controls="ex1-tabs-1"
            aria-selected="true"
            >
            <i class="fas fa-info-circle"></i>&nbsp; Aktivitet
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-2"
                data-mdb-toggle="tab"
                href="#ex1-tabs-2"
                role="tab"
                aria-controls="ex1-tabs-2"
                aria-selected="false"
                ><i class="fas fa-folder"></i>&nbsp; Filer
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a
                class="nav-link"
                id="ex1-tab-3"
                data-mdb-toggle="tab"
                href="#ex1-tabs-3"
                role="tab"
                aria-controls="ex1-tabs-3"
                aria-selected="false"
                ><i class="fas fa-comment"></i>&nbsp; Notater
            </a>
        </li>
    </ul>

    <div class="tab-content" id="ex1-content">
        <div
            class="tab-pane fade show active"
            id="ex1-tabs-1"
            role="tabpanel"
            aria-labelledby="ex1-tab-1"
        >
        <form id="inspectEventForm" class="mt-3">
            <input type="submit" style="display:none;" />
            <div>
                <div>
                    <div>
                        <div class="form-outline">
                            <input type="text"
                                class="form-control form-control-md"
                                id="{{ form.title.id_for_label }}" 
                                value="{{ form.title.value|default:'' }}"
                                name="{{ form.title.name }}"
                                autocomplete="off"
                                />
                            <label class="form-label" for="{{ form.title.id_for_label }}">游游 Tittel p친 norsk</label>
                        </div>
                        {% if form.title.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.title.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mt-2">
                        <div class="form-outline mb-3">
                            <input type="text"
                                class="form-control form-control-md"
                                id="{{ form.title_en.id_for_label }}" 
                                value="{{ form.title_en.value|default:'' }}"
                                name="{{ form.title_en.name }}"
                                autocomplete="off"
                                />
                            <label class="form-label" for="{{ form.title_en.id_for_label }}">游섫릖 Tittel p친 engelsk</label>
                        </div>
                        {% if form.title_en.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.title_en.errors }}
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <div >
                                    <div class="form-outline mb-3">
                                        <input type="text"
                                            class="form-control form-control-md"
                                            id="{{ form.expected_visitors.id_for_label }}" 
                                            value="{{ form.expected_visitors.value|default:'0' }}"
                                            name="{{ form.expected_visitors.name }}"
                                            autocomplete="off"
                                            />
                                        <label class="form-label" for="{{ form.expected_visitors.id_for_label }}"><i class="fas fa-users"></i>&nbsp; Expected visitors</label>
                                    </div>
                                    {% if form.expected_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.expected_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <div>
                                    <div class="form-outline mb-3">
                                        <input type="text"
                                            class="form-control form-control-md"
                                            id="{{ form.actual_visitors.id_for_label }}" 
                                            value="{{ form.actual_visitors.value|default:'0' }}"
                                            name="{{ form.actual_visitors.name }}"
                                            autocomplete="off"
                                            />
                                        <label class="form-label" for="{{ form.actual_visitors.id_for_label }}"><i class="fas fa-users"></i>&nbsp; Actual visitors</label>
                                    </div>
                                    {% if form.actual_visitors.errors|length > 0 %}
                                        <div class="alert alert-danger">
                                            {{ form.actual_visitors.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
    
                        <div class="form-outline mb-3">
                            <input type="text"
                                class="form-control form-control-md"
                                id="{{ form.ticket_code.id_for_label }}" 
                                value="{{ form.ticket_code.value|default:'' }}"
                                name="{{ form.ticket_code.name }}"
                                autocomplete="off"
                                />
                            <label class="form-label" for="{{ form.ticket_code.id_for_label }}"><i class="fas fa-receipt"></i>&nbsp; Billetkode</label>
                        </div>
                        {% if form.ticket_code.errors|length > 0 %}
                            <div class="alert alert-danger">
                                {{ form.ticket_code.errors }}
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="mt-2">
                        <h6><i class="fas fa-calendar text-muted"></i>&nbsp; Fra</h6>
                        <div class="row">
                            <div class="col-8">
                                <input type="date" class="form-control"
                                        name="{{form.start.name}}_date" id="{{form.start.id_for_label}}_date"
                                        value="{{ start_t|date:'Y-m-d' }}">
                            </div>
                            <div class="col-4">
                                <input type="time" class="form-control"
                                        name="{{ form.start.name }}_time" id="{{ form.start.name }}_time"
                                        value="{{ start_t|date:'H:i' }}">
                            </div>
                        </div>
                    </div>
    
                    <div class="mt-2">
                        <h6><i class="fas fa-calendar text-muted"></i>&nbsp; Til</h6>
                        <div class="row">
                            <div class="col-8">
                                <input type="date" class="form-control"
                                        name="{{ form.end.name }}_date" id="{{ form.end.id_for_label }}_date"
                                        value="{{ end_t|date:'Y-m-d' }}">
                            </div>
                            <div class="col-4">
                                <input type="time" class="form-control"
                                        name="{{form.end.name}}_time" id="{{ form.end.name }}_time"
                                        value="{{ end_t|date:'H:i' }}" >
                            </div>
                        </div>
                    </div>
    
                    <div class="mt-2">
                        <label class="d-block"><i class='fas fa-desktop'></i>&nbsp; {% trans "Vises p친 skjermen:" %}</label>
                        {{form.display_layouts}}
                        
                    </div>
    
                    <div class="row">
                        <div class="col-6">
                            <div class=" mb-2 mt-4">
                                <h5> <i class="fas fa-building text-muted"></i> Rom</h5>
                                <a class="btn btn-sm btn-success text-white"
                                    id="inspectEventDialog_addRoomsBtn"
                                    type="button">
                                    + Legg til nye rom
                                </a>
                            </div>
                            <hr>
                
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tbody id="roomsTableBody">
                                        {% for room in object.rooms.all %}
                                        <tr rowid="{{room.pk}}">
                                            <td>{{room}}</td>
                                            <td>
                                                <a href="#" class="text-danger"
                                                    data-mdb-toggle="tooltip"
                                                    onclick="inspectEventDialog__removeAssociation(this)"
                                                    title="{% trans 'Remove this room from the activity' %}">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cmb-2 mt-4">
                                <h5> <i class="fas fa-user text-muted"></i> People</h5>
                                <a class="btn btn-sm btn-success text-white"
                                    id="inspectEventDialog_addPeopleBtn"
                                    type="button">
                                    + Legg til nye personer
                                </a>
                            </div>
                
                            <hr>
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tbody id="peopleTableBody">
                                        {% for person in object.people.all %}
                                            <tr rowid="{{person.pk}}">
                                                <td>{{person}}</td>
                                                <td>
                                                    <a href="#" class="text-danger"
                                                        data-mdb-toggle="tooltip"
                                                        onclick="inspectEventDialog__removeAssociation(this)"
                                                        title="{% trans 'Remove this person from the activity' %}">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="clearfix">
            <div class="float-end">
                <a class="btn btn-md btn-dark text-white"><i class="fas fa-times"></i>&nbsp; Avbryt</a>
                <a class="btn btn-md btn-success text-white" type="button" onclick="inspectEventDialog__save()"><i class="fas fa-save"></i>&nbsp; Lagre</a>
            </div>
        </div>
        </div>
        <div class="tab-pane fade" id="ex1-tabs-2" role="tabpanel" aria-labelledby="ex1-tab-2">
            <div class="clearfix">
                <div class="float-start">
                    <h5><i class="fas fa-folder"></i>&nbsp; Filer</h5>
                </div>
                <div class="float-end">
                    <button class="btn btn-success" id="eventDialog_uploadFilesBtn"><i class="fas fa-upload"></i>&nbsp; Last opp fil(er)</button>
                </div>
            </div>
            <div>
                <table class="table w-100" id="inspectEventDialog__filesTable">
                    <thead>
                        <tr>
                            <th>Filnavn</th>
                            <th>Lastet opp</th>
                            <th>Valg</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in object.files.all %}
                            <tr id="fileRow_{{file.pk}}">
                                <td>{{file.filename}}</td>
                                <td><i class="text-muted">Av {{file.uploader.full_name}} den {{file.created}}</i></td>
                                <td>
                                    <a class="btn btn-success rounded-pill text-white" href="/media/{{file.file}}" download><i class="fas fa-download"></i></a>
                                    <a class="btn btn-danger rounded-pill text-white"
                                        onclick="inspectEventDialog__deleteFile( {{file.pk}} )">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="ex1-tabs-3" role="tabpanel" aria-labelledby="ex1-tabs-3">
            <div class="clearfix">
                <a class="text-white btn btn-success shadow-0 mb-2 float-end" id="inspectEventDialog__newNoteBtn">
                    <i class="fas fa-feather"></i>
                    Nytt notat
                </a>
            </div>

            {% for note in object.notes.all %}
            <div class="shadow-3 p-3 border-bottom {% if note.has_personal_information %}border-warning{% else %}border-success{% endif %}" id="note_{{note.pk}}">
                {{note.content|safe}}

                <div class="clearfix">
                    <em class="text-muted small float-start"></em>
                    <em class="text-muted small float-end">Opprettet av {{note.author}} den {{ note.created }}</em>
                </div>
                
                <hr>

                <div class="clearfix">
                    <div class="btn-group float-end">
                        <a href="#" class="btn btn-danger text-white"
                            onclick="deleteNote( {{note.pk}} )">
                            <i class="fas fa-trash"></i>
                        </a>

                        <a href="#" class="btn btn-success text-white"
                            onclick="updateNoteDialog( {{note.pk}} )">
                        <i class="fas fa-edit"></i>
                    </a>
                    </div>

                    {% if note.has_personal_information %}
                        <i class="fas fa-shield-alt text-warning h3 float-start"></i> 
                    {% endif %}

                </div>
            </div>
            {% endfor %}
        </div>
    </div>


</div>


<script>
    var peopleMap = new Map();
    var roomsMap = new Map();

    function inspectEventDialog__deleteFile(fileId) {
        fetch(`/arrangement/event/{{object.pk}}/files/${fileId}/delete`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(a => a.text()).then(a =>  document.getElementById('fileRow_' + fileId).remove() );
    }

    function updateNoteDialog(note_pk) {
        document.dispatchEvent(
            new CustomEvent("eventInspector.editNoteDialog.trigger", { "detail": {
                "note_pk": note_pk
            }})
        )
    }

    function deleteNote(note_pk) {
        Swal.fire({
            title: 'Er du sikker?',
            text: "Er du sikker p친 at du 칮nsker 친 slette dette notatet?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Slett',
            cancelButtonText: 'Avbryt',
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/arrangement/note/delete/' + note_pk, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{csrf_token}}',
                    }
                }).then(response => { document.getElementById('note_' + note_pk).remove(); });     
            }
        });
    }

    function inspectEventDialog__evaluateEnTitleObligatory() {
        var $enTitleElement = $('#id_title_en');
        var countSeletedDisplayLayouts = $("input[name='display_layouts'][type='checkbox']:checked").length;

        if (countSeletedDisplayLayouts === 0) {
            $enTitleElement.removeAttr("required");
        }
        else {
            $enTitleElement.attr("required", true);
        }
    }

    function inspectEventDialog__validate() {
        let field_elements = $('#inspectEventForm').find("input, select");

        let isInvalid = false;

        for (let i = 0; i < field_elements.length; i++) {
            if (field_elements[i].checkValidity() === false) {
                isInvalid = true;
                break;
            }
        }

        if (isInvalid) {
            $('#inspectEventForm').find(':submit').click();
            return false;
        }

        return true;
    }

    $(document).ready(function () {
        // NOT USED This ensures that english title is only obligatory IF a display layout has been selected.
        //inspectEventDialog__evaluateEnTitleObligatory();
        /*
        $("input[name='display_layouts'][type='checkbox']").on("change", (e) => {
            inspectEventDialog__evaluateEnTitleObligatory();
        });
        */
        document.addEventListener("eventInspector.roomsUpdated", (e) => {
            roomsMap = e.detail.context.room_name_map;
            inspectEventDialog__setRooms(e.detail.context.rooms);
        })
        document.addEventListener("eventInspector.peopleUpdated", (e) => {
            peopleMap = e.detail.context.people_name_map;
            inspectEventDialog__setPeople(e.detail.context.people);
        });
    })

    function inspectEventDialog__removeAssociation(a) {
        var row = $(a).closest("tr");
        row.remove();
    }

    function inspectEventDialog__setRooms(rooms) {
        console.log("rooms", rooms)

        var tbody = $('#roomsTableBody');
        tbody.empty(); // remove child elements

        var ids = rooms.split(",");

        ids.forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${roomsMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this room from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__setPeople(people) {
        var tbody = $('#peopleTableBody');
        tbody.empty(); // remove child elements

        var ids = people.split(",");

        ids.forEach(id => {
            tbody.append(
                $(`<tr rowid='${id}'>
                    <td>${peopleMap.get(id)}</td>
                    <td>
                        <a href="#" class="text-danger"
                                    data-mdb-toggle="tooltip"
                                    onclick="inspectEventDialog__removeAssociation(this)"
                                    title="{% trans 'Remove this person from the activity' %}">
                                    <i class="fas fa-trash"></i>
                    </td>
                   </tr>`) );
        });
    }

    function inspectEventDialog__getSelectedRoomIds() {
        var room_ids = Array.from($("#roomsTableBody")[0].children).map(row => row.getAttribute("rowid"));
        console.log("Rooms", room_ids);
        return room_ids;
    }

    function inspectEventDialog__getSelectedPeopleIds() {
        var people_ids = Array.from($("#peopleTableBody")[0].children).map(row => row.getAttribute("rowid"));
        console.log("People", people_ids)
        return people_ids;
    }

    function inspectEventDialog__delete() {

        Swal.fire({
            title: 'Er du sikker?',
            text: "Hendelsen kan ikke hentes tilbake.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ja',
            cancelButtonText: 'Avbryt'
        }).then((result) => {
            if (result.isConfirmed) {
                let formData = new FormData();
                formData.append("eventIds", "{{object.pk}}");

                fetch('/arrangement/planner/delete_events/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}',
                    }
                }).then(_ => {
                    document.dispatchEvent(new Event("eventInspector.close"));
                    document.dispatchEvent(new Event("plannerCalendar.refreshNeeded")); // Tell the planner calendar that it needs to refresh the event set
                });
            }
        })
    }

    function inspectEventDialog__save() {
        if (inspectEventDialog__validate() === false) {
            return;
        }

        var qualifiedEvent = {
            id: '{{object.pk}}',
            title: $('#id_title').val(),
            title_en: $('#id_title_en').val(),
            ticket_code: $('#id_ticket_code').val(),
            start: new Date( $('#id_start_date').val() + "T" + $('#start_time').val() ).toISOString(),
            end: new Date( $('#id_end_date').val() + "T" + $('#end_time').val() ).toISOString(),
            expected_visitors: $('#id_expected_visitors').val(),
            actual_visitors: $('#id_actual_visitors').val(),
            arrangement: '{{object.arrangement.pk}}',
            people: inspectEventDialog__getSelectedPeopleIds(),
            rooms: inspectEventDialog__getSelectedRoomIds(),
            display_layouts: [...document.querySelectorAll("input[name='display_layouts'][type='checkbox']:checked")]
                                .map(element => element.value)
        };

        document.dispatchEvent(
            new CustomEvent("eventInspector.submit", { "detail": {
                dialog: "inspectEventDialog",
                event: qualifiedEvent,
                csrf_token: '{{ csrf_token }}',
            }})
        );
    }

    function triggerFocusTo(slug, event_pk) {
        document.dispatchEvent(
            new CustomEvent(
                "plannerCalendar.inspectThisArrangement",
                { detail: { slug: slug, event_pk: event_pk } }
            )
        )
    }

    function removePerson(el) {
      let key = $(el).attr("person-key");
      peopleMap.delete(parseInt(key));
      el.remove();
    }

    function removeRoom(el) {
      let key = $(el).attr("room-key");
      roomsMap.delete(parseInt(key));
      el.remove();
    }

    $(document).ready(function () {
        const personAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_people_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let people = []
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (peopleMap.has(entry.fields.id) !== true) {
            people.push(entry.fields)
          }
        }

        return people;
      };

      const roomAsyncFilter = async (query) => {
        const url = `{% url "arrangement:search_room_ajax_view" %}?term=${encodeURI(query)}`;
        const response = await fetch(url);
        const data = JSON.parse(await response.json());

        let rooms = [];
        for (let i = 0; i < data.length; i++) {
          let entry = data[i]
          entry.fields.id = entry.pk;
          if (roomsMap.has(entry.fields.id) !== true) {
            rooms.push(entry.fields);
          }
        }

        return rooms;
      };
    })
</script>
