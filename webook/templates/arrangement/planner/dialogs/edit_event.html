{% load static i18n %}

<div class="modal" tabindex="-1" role="dialog" id="editEventDialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-edit"></i>&nbsp; {% trans "Edit event" %}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#editEventDialog').modal('hide')">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="eventEditMockForm">
            <input type="submit" style="display:none" />

            <input type="hidden" id="event_id" code-qualified-name="event_id" />

            <div class="form-group">
              <label class="d-block">{% trans "Title" %} <small class="text-muted float-end"> * Required</small></label>
              <input type="text" class="form-control" id="title" code-qualified-name="title" required/>
            </div>

            <div class="form-group mt-2">
              <label class="d-block">{% trans "From" %} <small class="text-muted float-end"> * Required</small></label>
              <div class="row">
                <div class="col-6">
                  <input type="date" class="form-control" id="fromDate" code-qualified-name="fromDate" required>
                </div>
                <div class="col-6">
                  <input type="time" class="form-control" id="fromTime" code-qualified-name="fromTime" required>
                </div>
              </div>
            </div>
            
            <div class="form-group mt-2">
              <label class="d-block">{% trans "To" %} <small class="text-muted float-end"> * Required</small></label>
              <div class="row">
                <div class="col-6">
                  <input type="date" class="form-control" id="toDate" code-qualified-name="toDate" required>
                </div>
                <div class="col-6">
                  <input type="time" class="form-control" id="toTime" code-qualified-name="toTime" required>
                </div>
              </div>
            </div>

            <div class="form-group mt-2">
              <label class="d-block">{% trans "People" %}</label>
              <select class="select" multiple id="personSelect" code-qualified-name="personSelect" data-mdb-filter="true" data-mdb-container="#editEventDialog" advanced-select="true">
                <option value="1">
                  Person A
                </option>
                <option value="2">Person A</option>
              <option value="3">Person B</option>
              </select>
            </div>

            <div class="form-group mt-2">
            <label>{% trans "Farge" %}</label>
              <input type="color" class="form-control" id="color" code-qualified-name="color">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="$(eventEditDialog).modal('hide')">{% trans "Cancel" %}</button>
          <button type="button" class="btn btn-primary" onclick="saveEvent()">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  </div>
    
<script>

    let selectExt;
    $(document).ready(function () {
      selectExt = new ExtendedSelect({
        jqElement: $('#personSelect'),
        getUrl: '{% url "arrangement:search_people_ajax_view" %}',
        extraHeaders: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        dataParser: function (item) {
          return {
            value: item.pk,
            text: [item.fields.first_name, item.fields.middle_name, item.fields.last_name].join(" "),
            secondary_text: item.fields.personal_email
          }
        }
      });
    })
   

    function bindHotkeys() {
      hotkeys('alt+enter', function (event, handler) {
        switch (handler.key) {
          case 'alt+enter':
            saveEvent();
            break;
        }
      });

      // needed to make sure hotkeys work when INPUT elements are in focus
      hotkeys.filter = function(event) { 
        return true;
      }
    }

    function releaseHotkeys() {
      hotkeys.unbind("alt+enter");
    }

    let eventEditDialog = document.getElementById('editEventDialog');

    var eventDialogManager = new InputGroupManager(
        [
            document.getElementById('event_id'),
            document.getElementById('title'),
            document.getElementById('fromDate'),
            document.getElementById('fromTime'),
            document.getElementById('toTime'),
            document.getElementById('toDate'),
            document.getElementById('color'),
            document.getElementById('personSelect'),
        ]
    )

    function newEventDialog() {
        eventDialogManager.flush();
        let eventEditDialog = document.getElementById('editEventDialog');
        eventDialogManager.event_id.value = -1;
        $(eventEditDialog).modal('show');
    }

    function updateEventDialog(event_uuid) {
        eventDialogManager.flush();
        console.log("Event Edit::>> " + event_uuid)
        let event = planner.local_context.events.get(event_uuid);
        // Write in existing values for this event
        eventDialogManager.event_id.value = event_uuid;
        eventDialogManager.title.value = event.title;
        eventDialogManager.fromDate.valueAsDate = event.from;
        eventDialogManager.fromTime.value = parseDateObjTimeToString(event.from);
        eventDialogManager.toDate.valueAsDate = event.to;
        eventDialogManager.toTime.value = parseDateObjTimeToString(event.to);
        eventDialogManager.color.value = event.color;
        //event.people

        let mdbSelectInstance = mdb.Select.getInstance($('#personSelect')[0])
        let values = []
        for (let i = 0; i < event.people.length; i++) {
          values.push(String(event.people[i]));
        }
        mdbSelectInstance.setValue(values);

        $(eventEditDialog).modal('show');
    }

    $(eventEditDialog).on('hidden.bs.modal', function (e) {
      hotkeys.unbind("alt+enter");
    })

    $(eventEditDialog).on('shown.bs.modal', function (e) {
      bindHotkeys();
    });

    function saveEvent() {
        let mockForm = document.getElementById('eventEditMockForm');
        let inputs = mockForm.querySelectorAll("input");
        let is_valid = true;
        for (let i = 0; i < inputs.length; i++) {
          if (inputs[i].checkValidity() === false) {
            $('#eventEditMockForm').find(':submit').click();
            return;
          }
        }

        let event_obj = {
            title: eventDialogManager.title.value,
            from: new Date(eventDialogManager.fromDate.value + "T" + eventDialogManager.fromTime.value),
            to: new Date(eventDialogManager.toDate.value + "T" + eventDialogManager.toTime.value),
            color: eventDialogManager.color.value,
            people: $(eventDialogManager.personSelect).val()
        }

        console.log(event_obj)

        let toastrMessage = "";
        console.log(eventDialogManager.event_id.value);
        if (eventDialogManager.event_id.value !== "-1") {
          planner.local_context.update_event(event_obj, eventDialogManager.event_id.value);
          toastrMessage = '{% trans "Event updated!" %}';
        }
        else {
          planner.local_context.add_event(event_obj);
          toastrMessage = '{% trans "Event created!" %}'
        }

        $(eventEditDialog).modal('hide');
        toastr["success"](toastrMessage);

        releaseHotkeys();
    }
</script>