{% load static i18n %}

<div class="modal" tabindex="-1" role="dialog" id="editEventDialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{% trans "Edit event" %}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#editEventDialog').modal('hide')">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="eventEditMockForm">
            <input type="submit" style="display:none" />

            <input type="hidden" id="event_id" code-qualified-name="event_id" />

            <div class="form-group">
              <label>{% trans "Title" %}</label>
              <input type="text" class="form-control" id="title" code-qualified-name="title" required/>
            </div>

            <label>{% trans "From" %}</label>
            <div class="row">
              <div class="col-6">
                <input type="date" class="form-control" id="fromDate" code-qualified-name="fromDate" required>
              </div>
              <div class="col-6">
                <input type="time" class="form-control" id="fromTime" code-qualified-name="fromTime" required>
              </div>
            </div>

            <label>{% trans "To" %}</label>
            <div class="row">
              <div class="col-6">
                <input type="date" class="form-control" id="toDate" code-qualified-name="toDate" required>
              </div>
              <div class="col-6">
                <input type="time" class="form-control" id="toTime" code-qualified-name="toTime" required>
              </div>
            </div>

            <label>{% trans "Farge" %}</label>
            <input type="color" class="form-control" id="color" code-qualified-name="color">
          </form>
        </div>
        <div class="modal-footer">
          <em style="float:left!important;text-align:left!important;">alt + enter</em>
          <button type="button" class="btn btn-secondary" onclick="$(eventEditDialog).modal('hide')">{% trans "Cancel" %}</button>
          <button type="button" class="btn btn-primary" onclick="saveEvent()">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  </div>

<script>
    function bindHotkeys() {
      hotkeys('alt+enter', function (event, handler) {
        switch (handler.key) {
          case 'alt+enter':
            saveEvent();
            break;
        }
      });

      // needed to make sure hotkeys work when INPUT elements are in focus
      hotkeys.filter = function(event){ 
        return true;
      }
    }

    function releaseHotkeys() {
      hotkeys.unbind("alt+enter");
    }

    let eventEditDialog = document.getElementById('editEventDialog');

    var eventDialogManager = new InputGroupManager(
        [
            document.getElementById('event_id'),
            document.getElementById('title'),
            document.getElementById('fromDate'),
            document.getElementById('fromTime'),
            document.getElementById('toTime'),
            document.getElementById('toDate'),
            document.getElementById('color'),
        ]
    )

    function newEventDialog() {
        eventDialogManager.flush();
        let eventEditDialog = document.getElementById('editEventDialog');
        eventDialogManager.event_id.value = -1;
        $(eventEditDialog).modal('show');
    }

    function updateEventDialog(event_uuid) {
        eventDialogManager.flush();
        console.log("Event Edit::>> " + event_uuid)
        let event = planner.local_context.events.get(event_uuid);
        // Write in existing values for this event
        eventDialogManager.event_id.value = event_uuid;
        eventDialogManager.title.value = event.title;
        eventDialogManager.fromDate.valueAsDate = event.from;
        eventDialogManager.fromTime.value = parseDateObjTimeToString(event.from);
        eventDialogManager.toDate.valueAsDate = event.to;
        eventDialogManager.toTime.value = parseDateObjTimeToString(event.to);
        eventDialogManager.color.value = event.color;

        $(eventEditDialog).modal('show');
    }

    $(eventEditDialog).on('hidden.bs.modal', function (e) {
      hotkeys.unbind("alt+enter");
    })

    $(eventEditDialog).on('shown.bs.modal', function (e) {
      bindHotkeys();
    });

    function saveEvent() {
        let mockForm = document.getElementById('eventEditMockForm');
        let inputs = mockForm.querySelectorAll("input");
        let is_valid = true;
        for (let i = 0; i < inputs.length; i++) {
          if (inputs[i].checkValidity() === false) {
            $('#eventEditMockForm').find(':submit').click();
            return;
          }
        }

        let event_obj = {
            title: eventDialogManager.title.value,
            from: new Date(eventDialogManager.fromDate.value + "T" + eventDialogManager.fromTime.value),
            to: new Date(eventDialogManager.toDate.value + "T" + eventDialogManager.toTime.value),
            color: eventDialogManager.color.value,
        }

        console.log(event_obj)

        let toastrMessage = "";
        console.log(eventDialogManager.event_id.value);
        if (eventDialogManager.event_id.value !== "-1") {
          planner.local_context.update_event(event_obj, eventDialogManager.event_id.value);
          toastrMessage = '{% trans "Event updated!" %}';
        }
        else {
          planner.local_context.add_event(event_obj);
          toastrMessage = '{% trans "Event created!" %}'
        }

        $(eventEditDialog).modal('hide');
        toastr["success"](toastrMessage);

        releaseHotkeys();
    }
</script>