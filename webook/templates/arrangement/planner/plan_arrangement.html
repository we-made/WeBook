
{% load static i18n %}

{% block content %}
<style>
  #designerCalendar .fc-day-sun, #designerCalendar .fc-day-sat {
    background-color: #f4f5d7;
}
* { user-select: none; }

  .shadow-event {
    pointer-events: none;
  }

  .stepper {
    border: solid 1px;
  }

  .stepper-active .stepper-head-icon {
    background-color: green;
  }

  .stepper-completed {
    background-color: lightgreen;
  }

  .stepper-active {
    background-color: whitesmoke;
  }

  .stepper-active#last_step {
    background-color: lightgreen;
  }

  .focused-cell {
    border: solid 1px blue!important;
    background-color: ghostwhite;
    color:black
  }

  .collision_analysis_shadow_event {
    color: red;
    background-color: smokewhite;
    border: dotted 3px red!important;
  }

  .popover {
    border: solid 1px black;
  }

  .cut-highlight-daygrid-event {
    border: dotted 1px red!important;
    background-color: ghostwhite!important;
    color: black!important;;
  }

   /* menu header */
   .css-title:before {
        content: "some CSS title";
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        background: #DDD;
        padding: 2px;

        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-size: 11px;
        font-weight: bold;
    }
    .css-title :first-child {
        margin-top: 20px;
    }

    .ds-selected * {
      /* position: absolute!important; */
      pointer-events: none;
    }

    /* menu header via data attribute */
    .data-title:before {
        content: attr(data-menutitle);
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        background: #DDD;
        padding: 2px;

        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-size: 11px;
        font-weight: bold;
    }
    .data-title :first-child {
        margin-top: 20px;
    }

    .wemade-tabs > .nav-item {
    background-color: #21384B;
    width: 100%;
  }

  .wemade-tabs > .nav-item > .nav-link {
    color:white;
  }
  .wemade-tabs > .nav-item > .active {
    background-color:#386080;;
  }

  .stageIsDone {
    color:white;
  }

  #plannerTab > li.nav-item > button.nav-link {
    padding: 0.8rem;
    /* border: initial; */
  }
  #plannerTab > li.nav-item > button.nav-link.active {
    padding: 0.8rem;
    /* border: initial; */
  }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.css" integrity="sha512-EF5k2tHv4ShZB7zESroCVlbLaZq2n8t1i8mr32tgX0cyoHc3GfxuP7IoT8w/pD+vyoq7ye//qkFEqQao7Ofrag==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://dragselect.com/v2/ds.min.js"></script>
<script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>

<h3>Arrangementsplanlegger</h3>
<button class="btn btn-sm btn-light mb-2" style="box-shadow: none;"><i class="fas fa-list"></i>&nbsp; Gå til arrangementslisten</button>
<button class="btn btn-sm btn-light mb-2" style="box-shadow: none;"><i class="fas fa-plus"></i>&nbsp; Opprett nytt arrangement</button>

<div class="row">
  <div class="col-10">
    <div class="input-group mb-3">
      <span class="input-group-text">
        <i class="fas fa-suitcase"></i>
      </span>
      <input type="text" class="form-control form-control-lg" />

      <span class="input-group-text">
        <i class="fas fa-folder"></i>
      </span>
      <span class="input-group-text">
        <i class="fas fa-chevron-down"></i>
      </span>
    </div>
  </div>
  <div class="col-2">
    <div class="clearfix">
      <div class="float-end">
        <button class="btn btn-warning" style="box-shadow: none;"><i class="fas fa-lock"></i></button>
        <button class="btn btn-danger" style="box-shadow: none;"><i class="fas fa-trash"></i></button>
        <button class="btn btn-success" style="box-shadow: none;"><i class="fas fa-copy"></i></button>
      </div>
    </div>
  </div>
</div>
<span class="badge badge-success badge-md"><strong>Hovedplanlegger: </strong>{{ object.responsible.full_name }}</span>
<span class="badge badge-info badge-md"><strong>Målgruppe: </strong>{{ object.audience }}</span>

<div id="collisionAnalysisWrapper" style="display: none;">
  <div class="mt-2 p-2" style="border: 3px dotted black; background-color: ghostwhite;">
    <legend class="fw-bolder">Kollisjonsanalyse</legend>

    <div id="collisionAnalysisLoader">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div> Analysis is being calculated...
    </div>

    <div id="collisionAnalysisBody">
    </div>
  </div>
</div>
<ul class="stepper mt-2" data-mdb-stepper="stepper">
  <li class="stepper-step stepper-active">
    <div class="stepper-head">
      <span class="stepper-head-icon"> <i class="fas fa-calendar"></i> </span>
      <span class="stepper-head-text"> Planlegging </span>
    </div>
    <div class="stepper-content">
    </div>
  </li>
  <li class="stepper-step">
    <div class="stepper-head">
      <span class="stepper-head-icon"> <i class="fas fa-envelope"></i> </span>
      <span class="stepper-head-text"> Rekvirering </span>
    </div>
    <div class="stepper-content">
    </div>
  </li>
  <li class="stepper-step" id="last_step">
    <div class="stepper-head">
      <span class="stepper-head-icon"> <i class="fas fa-check"></i> </span>
      <span class="stepper-head-text"> I produksjon </span>
    </div>
    <div class="stepper-content">
    </div>
  </li>
</ul>
<div class="clearfix mt-0 mb-2">
  <button class="btn btn-success float-end border-squared rounded-0 rounded-bottom" onclick="requisitioningDialog.open()" style="box-shadow: none;">
    <i class="fas fa-arrow-right"></i>&nbsp; 
    Begynn rekvirering
  </button>
</div>
<!-- /.Horizontal Steppers -->

<div class="clearfix">

    <ul class="nav nav-tabs nav-fill" id="navTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button  class="nav-link" id="overview-tab" data-mdb-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="false"><i class="fas fa-eye"></i>&nbsp; Oversikt</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="planner-tab" data-mdb-toggle="tab" href="#planner" role="tab" aria-controls="planner" aria-selected="true"><i class="fas fa-calendar"></i>&nbsp; Planlegging</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="planners-tab" data-mdb-toggle="tab" href="#planners" role="tab" aria-controls="planners" aria-selected="false"><i class="fas fa-users"></i>&nbsp; Planleggere</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="details-tab" data-mdb-toggle="tab" href="#details" role="tab" aria-controls="details" aria-selected="false"><i class="fas fa-info"></i>&nbsp; Detaljer</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="notes-tab" data-mdb-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="false"><i class="fas fa-comments"></i>&nbsp; Notater</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="receipts-tab" data-mdb-toggle="tab" href="#receipts" role="tab" aria-controls="receipts" aria-selected="false">
          <i class="fas fa-receipt"></i>&nbsp; Kvitteringer & Rekvirering
          <span class="badge  badge-info">0</span>
        </button>
      </li>
    </ul>
    <div class="p-2 border" style="background-color: ghostwhite;">
    </div>
    
    <div style="background-color: #386080; color:white" class="p-2">
      <div class="float-start">
    
      </div>
              
    </div>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane" id="overview" role="tabpanel" aria-labelledby="overview-tab">aa</div>
      <div class="tab-pane fade show active" id="planner" role="tabpanel" aria-labelledby="planner-tab">
        <br>
        <div class="clearfix">
          <div class="float-end">
            <div class="mb-1 mt-1">
              <div>
                <button class="btn btn-info" onclick="planner.collision_analyzer.requestCollisionAnalysis()" style="box-shadow: none;">
                  <i class="fas fa-flask"></i>&nbsp;
                  Kjør kollisjonsanalyse
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="btn-group float-start" style="box-shadow: none;">
          <button class="btn btn-info mb-2" onclick="iconsDialog.open()"><i class="fas fa-info"></i>&nbsp; {% trans "Icons" %}</button>
          <button class="btn btn-info mb-2"><i class="fas fa-info-circle"></i>&nbsp; {% trans "User guide" %}</button>
        </div>
        <div class="clearfix">
          <div class="btn-group float-end" style="box-shadow: none;">
            <button class="btn btn-success mb-2" onclick="newEventDialog()"><i class="fas fa-plus"></i>&nbsp; {% trans "New event" %}</button>
            <button class="btn btn-success mb-2" onclick="loadNewSerieDialog()"><i class="fas fa-plus"></i>&nbsp; {% trans "New repeating event" %}</button>
          </div>
        </div>

        <div id="designerCalendar" class="bg-white"></div>

      </div>
      <div class="tab-pane fade" id="planners" role="tabpanel" aria-labelledby="planners-tab"><br><span id="arrangement_plannersWrapper"></span></div>
      <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
        <br>
        <form>
          <div>
            <label>Navn på arrangement</label>
            <input type="text" class="form-control" />
          </div>

          <div class="mt-2">
            <label>Målgruppe</label>
            <select class="form-control"></select>
          </div>
        </form>
      </div>
      <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab"> <span id="arrrangementNotesWrapper"></span>
      </div>
      <div class="tab-pane fade" id="receipts" role="tabpanel" aria-labelledby="receipts-tab">
        
        <div class="row mt-5">
          <div class="col-6">
            <span id="peopleRequisitionsWrapper"></span>
            <br>
            <span id="peopleToRequisitionWrapper"></span>
          </div>

          <div class="col-6">
            <span id="serviceRequisitionsWrapper"></span>
          </div>
        </div>
      </div>
    </div>
  
  </div>

<div class="row g-0" style=" background-color: #21384B;">

  <div class="col-12 bg-white p-3 tabContent">
    <div class="tab-content" id="arrangement-content">

    </div>
  </div>
</div>



  <script src="{% static 'fullcalendar-scheduler/main.min.js' %}"></script>
  <script src="{% static 'fullcalendar-scheduler/locales-all.min.js' %}"></script>
  <script src="{% static 'js/planner.js' %}"></script>
  <script src="{% static 'js/notes.js' %}"></script>
  <script src="{% static 'js/inputGroupManager.js' %}"></script>
  

<script>
    let selectAllow = true;

    window.addEventListener('DOMContentLoaded', (event) => {
      bind_global_hotkeys();
      $('#arrrangementNotesWrapper').load('{% url "arrangement:notes_on_entity_component" %}?entityType=arrangement&entityPk={{object.pk}}');
      $('#arrangement_ordersWrapper').load('{% url "arrangement:requisitions_on_arrangement" %}?arrangementId={{object.pk}}');
      $('#arrangement_plannersWrapper').load('{% url "arrangement:planners_on_arrangement" %}?arrangementId={{object.pk}}');

      new ExtendedSelect({
        jqElement: $('#arrangement_audienceSelect'),
        getUrl: '{% url "arrangement:audience_search" %}',
        extraHeaders: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        initialSearchValue: '',
        dataParser: function (item) {
          return {
              value: item.pk,
              text: item.fields.name,
              secondary_text: ""
          }
        }
      })
      new MonthSelectComponent("monthNavigationSelect");
      new YearSelectComponent({ 
        element_id: "yearNavigationSelect", 
        breadth: 20, 
        focusYear: (new Date().getFullYear()) 
      });

      document.getElementById('yearNavigationSelect').addEventListener("change", function () {
        calendarManager.go_to_year(document.getElementById('yearNavigationSelect').value);
      });

      document.getElementById('monthNavigationSelect').addEventListener("change", function () {
        calendarManager.go_to_month(document.getElementById('monthNavigationSelect').value - 1);
      });
    });

    function bind_global_hotkeys() {
      hotkeys('fn+n, fn+s', function (event, handler) {
        event.preventDefault();
        switch (handler.key) {
          case 'ctrl+z+n': 
            newEventDialog();
            break;
          case 'ctrl+z+s':
            loadNewSerieDialog();
            break;
        }
      });
    }

    class SelectComponent {
        constructor (element_id, options) {
            this.element_id = element_id
            this.options = options
        }

        insert_options () {
            for (let [key, value] of this.options) {
                let option = document.createElement('option');
                option.setAttribute("value", key);
                option.innerText = value;
                document.getElementById(this.element_id).append(option);
            }
        }

        set_selected(value) {
          $("#" + this.element_id).val(value).change();
        }
    }
    
    class MonthSelectComponent extends SelectComponent {
        constructor (element_id) {
            let options = new Map([
              ["1", '{% trans "january" %}'],
              ["2", '{% trans "februar" %}'],
              ["3", '{% trans "march" %}'],
              ["4", '{% trans "april" %}'],
              ["5", '{% trans "may" %}'],
              ["6", '{% trans "june" %}'],
              ["7", '{% trans "july" %}'],
              ["8", '{% trans "august" %}'],
              ["9", '{% trans "september" %}'],
              ["10", '{% trans "october" %}'],
              ["11", '{% trans "november" %}'],
              ["12", '{% trans "december" %}'],
            ]);

            super(element_id, options)

            this.insert_options();
        }
    }

    class YearSelectComponent extends SelectComponent {
      constructor ({ element_id, breadth, focusYear } = {}) {

        let options = new Map();
        let years = [];

        for (let i = 0; i < breadth; i++) {
          years.push((focusYear + i), (focusYear + i));
          years.push((focusYear - i), (focusYear - 1));
        }

        years = years.sort();
        years.forEach( (item) => {
          options.set(item, item)
        })

        super(element_id, options);
        this.insert_options();
        this.set_selected(focusYear);
      }
    }

    function parseDateObjTimeToString (date_obj, separator=":", include_seconds=false) {
      let hours = String(date_obj.getHours());
      let minutes = String(date_obj.getMinutes());
      let seconds = String(date_obj.getSeconds());

      if (hours.length == 1) {
        hours = "0" + hours;
      }
      if (minutes.length == 1) {
        minutes += "0";
      }
      if (seconds.length == 1 && include_seconds === true) {
        seconds += "0";
      }

      return hours + separator + minutes + (include_seconds === true ? separator + seconds : "");
    }

    let translatedTextsMap = new Map([
      ["create", '{% trans "Create" %}'],
      ["edit", '{% trans "Edit" %}'],
      ["delete", '{% trans "Delete" %}'],
      ["info", '{% trans "Info" %}']
    ]);

    var planner = new Planner({
      onClickEditButton: function (eventId) { updateEventDialog(eventId); },
      onClickOrderServiceButton: function (events) { openOrderServiceDialog(events); },
      onSelectionCopied: function (clipboard) {
        console.log("==> onSelectionCopied")
        console.log(clipboard);

        let rootNode = $("<span></span>")
        clipboard.events.forEach(function (event) {
          rootNode.append($('<p>'+event.title+'</p>'))
        });

        $('#clipboardCounter').text(clipboard.events.length);

        console.log(document.getElementById('clipboardPopover'))
        let popover = new mdb.Popover(document.getElementById('clipboardPopover'), { 
          html: true,
          title: "Utklippstavle",
          content: rootNode.html(),
          container: 'body',
        })
      },
      csrf_token: '{% csrf_token %}',
      csrf_token2: '{{ csrf_token }}',
      texts: translatedTextsMap,
      arrangement_id: {{ object.id }},
      $serviceRequisitionsWrapperEl: $('#serviceRequisitionsWrapper'),
      $peopleRequisitionsWrapperEl: $('#peopleRequisitionsWrapper'),
      $peopleToRequisitionWrapperEl: $('#peopleToRequisitionWrapper'),
    });

    var calendarManager = new CalendarManager(
      "designerCalendar",
      {
        "initialView": "dayGridMonth",
        "navLinks": true,
        "locale": 'nb',
        "weekNumbers": true,
        "selectable": true,
        "selectMirror": false,
        "loading": (isLoading) => {
          console.log(isLoading)
        },
        "editable": true,
        "unselectAuto": true,
        "selectMinDistance": 1,
        "select": function ( selectionInfo ) {
            eventDialogManager.flush();
            eventDialogManager.event_id.value = -1;

            eventDialogManager.fromDate.valueAsDate = selectionInfo.start;
            eventDialogManager.fromTime.value = parseDateObjTimeToString(selectionInfo.start);

            eventDialogManager.toDate.valueAsDate = selectionInfo.end;
            eventDialogManager.toTime.value = parseDateObjTimeToString(selectionInfo.end);

            eventDialogManager.title.value = "";

            $(eventEditDialog).modal('show');
        },
        "datesSet": function (arg) {

          $('.fc-daygrid-day').on('click', function () {
              calendarManager.cellSel.selectCell($(this));
          })

          $('.fc-timegrid-col, .fc-timegrid-slot').on('click', function () {
            calendarManager.cellSel.selectCell($(this));
          })

          calendarManager.setup_cell_select(arg.view.type);

          $('#monthNavigationSelect').val(arg.view.getCurrentData().currentDate.getMonth() + 1);
          $('#yearNavigationSelect').val(arg.view.getCurrentData().currentDate.getFullYear())

        },
        "headerToolbar": {
          "left": 'prev,next today',
          "center": 'title',
          "right": 'dayGridMonth,timeGridWeek,timeGridDay'
        } 
      },
    );

    planner.renderer_manager.add_renderer(calendarManager);
    planner.init()
  </script>

  {% include 'arrangement/planner/dialogs/edit_event.html' %}
  {% include 'arrangement/planner/dialogs/new_serie.html' %}
  {% include 'arrangement/planner/dialogs/order_service.html' %}
  {% include 'arrangement/planner/dialogs/allocate_rooms.html' %}
  {% include 'arrangement/planner/dialogs/allocate_people.html' %}
  {% include 'arrangement/planner/dialogs/color_selection.html' %}
  {% include 'arrangement/planner/dialogs/icons_dialog.html' %}
  {% include 'arrangement/requisitioneer/requisition_dialog.html' %}
{% endblock %}