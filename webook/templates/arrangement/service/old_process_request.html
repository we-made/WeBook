
# Old process_request to work with the now benched old way of doing it

{% extends request.user.is_authenticated|yesno:"base.html,secondary_public_base.html" %}
{% load static i18n %}
{% load custom_tags %}
{% load crispy_forms_tags %}

{% block header %}
<div class="margin-auto mt-3 d-flex justify-content-center">
    <img src="/{{APP_LOGO}}"  width="40px" alt="">
</div>
<h4 class="text-center mt-2 mb-0">Behandling av bestilling</h4>
<hr>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

{% endblock %}

{% block container_classes %}
container-fluid
{% endblock %}

{% block content %}

{% include "arrangement/service/shared/_processChangelogComponent.html" %}
{% include "arrangement/service/shared/_provisioneerComponent.html" %}
{% include "arrangement/service/shared/_dateReelComponent.html" %}

<div id="app" v-cloak>
    <!-- {% if request.user.is_authenticated %}

    <div class="wb-bg-secondary p-3 rounded-3 d-flex justify-content-between align-items-center">

        <div>
            <a href="#">{{ object.related_to_order.service.name }}</a>
            /
            <a href="#"># {{ object.related_to_order.id }}</a>
        </div>

        <button class="wb-btn-main">
            <i class="fas fa-arrow-right"></i>
            Til dashboard for {{ object.related_to_order.service.name }}
        </button>
    </div>



    {% endif %} -->

    <div class="row">
        <div class="col-2">
            <div class="p-3  text-center rounded-3 w-auto">
                <h2>
                    {{object.related_to_order.service}}
                </h2>
                
                <h5 class="mb-0 fw-bold">
                    Bestilling #{{object.related_to_order.id}}
                </h5>            
            
                {% if request.user.is_authenticated %}
                <a class="btn wb-btn-main mt-3"
                    href="{% url 'arrangement:service_detail' id=object.related_to_order.service.id %}">
                    Til dashboard
                </a>
                {% endif %}
            </div>

            <table class="table border-0 ms-3 w-100 table-sm text-center">
                <tbody>
                    <tr>
                        <th class="fw-bold">Status</th>
                        <td>
                            <div class="badge badge-md badge-success" v-if="order.state == 'confirmed'">
                                <h6 class="mb-0">
                                    <i class="fas fa-check"></i>
                                    Ferdig behandlet
                                </h6>
                            </div>
                            <div class="badge badge-warning" v-if="order.state == 'awaiting'">
                                <h6 class="mb-0">
                                    <i class="fas fa-hourglass"></i>
                                    Venter behandling
                                </h6>
                            </div>
                            <div class="badge badge-danger" v-if="order.state == 'denied'">
                                <h6 class="mb-0">
                                    <i class="fas fa-hand-paper"></i>
                                    Avslått
                                </h6>
                            </div>
                            <div class="badge badge-danger" v-if="order.state == 'cancelled'">
                                <h6 class="mb-0">
                                    <i class="fas fa-times"></i>
                                    Kansellert
                                </h6>
                            </div>
                            <div class="badge badge-secondary" v-if="order.state == 'in_revision'">
                                <h6 class="mb-0">
                                    <i class="fas fa-edit"></i>
                                    Under Revisjon
                                </h6>
                            </div>
                            <div class="badge badge-warning" v-if="order.state == 'changed'">
                                <h6 class="mb-0">
                                    <i class="fas fa-edit"></i>
                                    Endringer er gjort
                                </h6>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="fw-bold">Arrangement</th>
                        <td>{{ ARRANGEMENT_NAME }}</td>
                    </tr>
                    <tr>
                        <th class="fw-bold">Opprettet</th>
                        <td>{{ object.created }}</td>
                    </tr>
                    <tr>
                        <th class="fw-bold">Plassert av</th>
                        <td>{{ object.related_to_order.created_by }}</td>
                    </tr>
                </tbody>
            </table>

            <div class="rounded-3 w-100 mt-5">
                <h4 class="text-center">Kommentar fra planlegger</h4>
                <textarea name="" id="" class="w-100" cols="30" rows="10" disabled>
    {{object.related_to_order.freetext_comment}}
                </textarea>
            </div>
        </div>
        <div class="col-10 ps-5">
            <div v-if="focusedProvision">
                <div class="row">
                    <div class="col-12">
                        <date-reel-component
                            :provisions="allProvisions.map((p) => p)"
                            :selected-date="focusedProvision.time_display"
                            @focus-on-provision="(provision) => focusedProvision = provision">

                        </date-reel-component>
                    </div>
                </div>


                <provisioneer-component
                    :provision="focusedProvision">
                </provisioneer-component>
            </div>
            <div v-else>
                <div v-if="order.state == 'awaiting'" class="text-center" v-cloak>
                    <div class="alert alert-warning" v-if="completedProvisionsCount != allProvisions.length" >
                        <h5><i class="fas fa-exclamation-triangle h2"></i></h5>
                        <h4>Alle datoer må behandles før bestillingen kan ferdigstilles</h4>
    
                        <div class="mt-3">
                            <button class="btn wb-btn-secondary shadow-0" @click="denyOrder()"
                            {% if object.related_to_order.state == 'confirmed' or object.related_to_order.state == 'cancelled' %}disabled{% endif %}>
                            <i class="fas fa-times"></i>
                            Avvis bestilling
                            </button>
                            <button class="btn wb-btn-main shadow-0 ms-3" @click="confirmOrder()"
                                :disabled="completedProvisionsCount != allProvisions.length">
                                <i class="fas fa-check"></i>
                                Bekreft og ferdigstill bestillingen
                            </button>
                        </div>
    
                    </div>
                    <div class="alert alert-success" v-else>
                        <h5><i class="fas fa-check h2"></i></h5>
                        <h4>Alle datoer er ferdigbehandlet og bestilling kan fullføres</h4>
    
                        <div class="mt-3">
                            <button class="btn wb-btn-secondary shadow-0" @click="denyOrder()"
                            {% if object.related_to_order.state == 'confirmed' or object.related_to_order.state == 'cancelled' %}disabled{% endif %}>
                            <i class="fas fa-times"></i>
                            Avvis bestilling
                            </button>
                            <button class="btn wb-btn-main shadow-0 ms-3" @click="confirmOrder()"
                                :disabled="completedProvisionsCount != allProvisions.length">
                                <i class="fas fa-check"></i>
                                Bekreft og ferdigstill bestillingen
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else-if="order.state == 'cancelled'">
                    <div class="alert alert-danger text-center">
                        <h5><i class="fas fa-times h2"></i></h5>
                        <h4>Denne bestillingen har blitt kansellert av planlegger og kan ikke lenger redigeres</h4>
                    </div>
                </div>
                <div v-else-if="order.state == 'denied'">
                    <div class="alert alert-danger text-center">
                        <h5><i class="fas fa-hand-paper h2"></i></h5>
                        <h4>Denne bestillingen har blitt avslått</h4>
    
                        
                        <div class="mt-3">
                            <button class="btn wb-btn-main" @click="openOrderForRevisioning()">
                                <i class="fas fa-unlock"></i>&nbsp;
                                Åpne bestillingen for redigering
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else-if="order.state == 'confirmed'">
                    <div class="alert alert-success mild-success text-center">
                        <h5><i class="fas fa-check h2"></i></h5>
                        <h4>Denne bestillingen er ferdig behandlet</h4>
    
                        <div class="mt-3">
                            <button class="btn wb-btn-main" @click="openOrderForRevisioning()">
                                <i class="fas fa-unlock"></i>&nbsp;
                                Åpne bestillingen for redigering
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else-if="order.state == 'in_revision'">
                    <div class="alert alert-warning text-center">
                        <h5><i class="fas fa-edit h2"></i></h5>
                        <h4>Bestillingen er åpnet for revidering</h4>
    
                        <div class="mt-3">
                            <button class="btn wb-btn-secondary me-2" @click="completeRevisioning('deny')">
                                <i class="fas fa-times"></i>&nbsp;
                                Avslå bestillingen
                            </button>
                            <button class="btn wb-btn-main ms-2" @click="completeRevisioning('confirm')">
                                <i class="fas fa-check"></i>&nbsp;
                                Ferdigstill bestillingen
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else-if="order.state == 'changed'">
                    <div class="alert alert-warning text-center">
                        <h5><i class="fas fa-edit h2"></i></h5>
                        <h4>Bestillingen har blitt revidert av planlegger. Under ser du en oversikt over de endringene som har blitt gjort.
                            Alle datoene må være ferdig behandlet før bekfreftelse er mulig.
                        </h4>
    
                        <div class="mt-2">
                            <button class="btn wb-btn-main shadow-0 ms-1" @click="confirmOrder()"
                                :disabled="completedProvisionsCount != allProvisions.length">
                                <i class="fas fa-check"></i>
                                Bekreft og ferdigstill bestillingen
                            </button>
                        </div>
                    </div>
                </div>
    
                <ul class="nav nav-tabs webook-tabs mb-3">
                    <li class="nav-item">
                        <a href="#activitiesTab" class="nav-link active" role="tab" data-mdb-toggle="tab">
                            <i class="fas fa-table"></i>&nbsp;
                            Linjer
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#changelogsTab" class="nav-link" role="tab" data-mdb-toggle="tab">
                            <i class="fas fa-clipboard"></i>&nbsp;
                            Endringsmeldinger / Revisjoner
                        </a>
                    </li>
                </ul>
        
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="activitiesTab" role="tabpanel" aria-labelledby="linesTab">
                        <div class="bg-white rounded-3 ">
                            <div class="row">
                                <div class="col-12">
                                    <div v-if="order.state == 'changed'">
                                        
                                        <process-changelog-table-component
                                            sopr-token="{{SOPR_TOKEN}}"
                                            :provisions="allProvisions"
                                            @open-line-for-processing="openProvisioningWizard">
    
                                        </process-changelog-table-component>
                                    </div>
                                    <div v-else>
                                        <div class="d-flex justify-content-between align-items-middle">
                                            <span :class="[{ 'light-3 p-2 rounded-3 text-dark': true }, 'text-small']"
                                                style="background-color: #ccf1db">
                                                [[ completedProvisionsCount ]] ut av [[ entitiesCount ]] aktiviteter behandlet
                                            </span>
                
                                            <div class="input-group w-25">
                                                
                                                <select name="" id="" class="form-control form-control-lg"
                                                        v-model="displayedTypesFilter">
                                                    <option value="all">Vis alle aktiviteter</option>
                                                    <option value="onlyAwaiting">Vis bare ubehandlede aktiviteter</option>
                                                    <option value="onlyFinished">Vis bare ferdigbehandlede aktiviteter</option>
                                                </select>
                                            </div>
                                        </div>
    
                                        <table class="table table-sm" id="provision_[[provision.provision_id]]">
                                            <thead>
                                                <tr>
                                                    <th></th> 
                                                    <th class="h4">Dato & Tid</th>
                                                    <th class="h4">Valg</th>
                                                </tr>
                                            </thead>
                
                                            <tbody class="align-middle">
                                                <tr v-for="provision in visibleItems">
                                                    <td style="width: 1rem">
                                                        <div v-if="provision.is_complete">
                                                            <div class="badge p-2 badge-success">Ferdigbehandlet</div>
                                                        </div>
                                                        <div v-else>
                                                            <div class="badge p-2 badge-warning">Venter behandling</div>
                                                        </div>
                                                    </td>
                                                    <td>[[ provision.start ]] - [[ provision.end ]]</td>
                                                    <td>
                                                        <!-- @click="openProvisioningWizard(provision.provision_id)" -->
                                                        <button class="btn wb-btn-main wb-sm"
                                                                @click="focusedProvision = provision"
                                                                :disabled="!isEditable">
                                                            Behandle
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <nav aria-label="" class="d-flex" style="justify-content: space-between; align-items: center;">
                                            <div>
                                              <em><strong>[[totalPages]]</strong> sider, totalt <strong>[[allViewableItems.length]]</strong> elementer</em>
                                            </div>
                                            <ul class="pagination">
                                                <li class="page-item" :class="{ disabled: page == 1 }"><a class="page-link" href="javascript:void(0)" @click.stop="page--">Forrige</a></li>
                                                <li class="page-item" :class="{ active: thisPage == page }" v-for="thisPage in totalPages"><a class="page-link" @click.stop="page = thisPage">[[thisPage]]</a></li>
                                                <li class="page-item" :class="{ disabled: page == totalPages }"><a class="page-link" href="javascript:void(0)" @click.stop="page++">Neste</a></li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>  
                    </div>
        
                    <div class="tab-pane fade" id="changelogsTab" role="tabpanel" aria-labelledby="changelogsTab">
                        {% if object.related_to_order.changelogs.exists %}
                        <table class="table table-bordered border-0 text-center table-sm">
                            <tbody>
                                <tr class="wb-bg-secondary">
                                    <td class="h5 mb-0"><i class="fas fa-calendar"></i></td>
                                    <td class="h5 mb-0">Hvem</td>
                                    <td class="h5 mb-0">Melding</td>
                                </tr>
                                {% for log in object.related_to_order.sorted_changelogs.all %}
                                <tr>
                                    <td>
                                        {{log.created}}
                                    </td>
                                    <td>
                                        {{log.source_sopr.recipient}}
                                    </td>
                                    <td>
                                    {{log.changelog_message}}
                                    </td>
                                </tr>
                                {% endfor %}        
                            </tbody>
                        </table>
                        {% else %}
                        
                        <div class="alert alert-info text-center">
                            <h3><i class="fas fa-info-circle "></i></h3>
                            <h5 class="text-center">
                                Endringsmeldinger vil dukke opp her.
                            </h5>
    
                            <h6>
                                Etter bestillingen er ansett som gjennomført <i>(bekreftet eller avslått)</i> så kan den åpnes for revideringer.
                                Ved revidering må en skrive en summering av forandringer som har blitt gjort. Disse vil vises her.
                            </h6>
                        </div>
    
    
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>  

<script>
    function openProvisioningDialog(provisionId) {
        document.dispatchEvent(new CustomEvent(
            "requestProcessingDialogManager.provision_personell_dialog.trigger",
            { detail: { provisionId: provisionId } }
        ));
    }
</script>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.1/index.min.js" integrity="sha512-88/heKGrsHjGwV3/5hCfhqseY7Nge7OmzbufE3VSHGK79SiMhypEbexl6i13hh7fKhh5hlomX/6kkQtFZernQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script type="module">
    import { Dialog, DialogManager, DialogSimpleRenderer, DialogFormInterceptorPlugin } from  "{% static 'modules/planner/dialog_manager/dialogManager.js' %}";
    import { ColorRepository } from "{% static 'js/colorRepository.js' %}";
    import { MessagesFacility } from "{% static 'modules/planner/broadcast.js' %}";
    
    $(document).ready(function () {
        window.MessagesFacility = new MessagesFacility();
    });

    const ARIA_ATTRIBUTE_PATTERN = /^aria-[\w-]*$/i;

    document.addEventListener('DOMContentLoaded', function() {
        const app = Vue.createApp({
            components: {
                ProcessChangelogTableComponent,
                ProvisioneerComponent,
                DateReelComponent,
            },
            data() {
                return {
                    allProvisions: [],
                    order: {
                        service_name: "{{ object.related_to_order.service.name }}",
                        created_when: "{{ object.created_when }}",
                        state: "{{object.related_to_order.state}}"
                    },
                    displayedTypesFilter: "all",
                    page: 1,
                    pageSize: 10,
                    navPageCircumference: 3,
                    token: '{{SOPR_TOKEN}}',
                    focusedProvision: null
                }
            },
            watch: {
            },
            computed: {
                isEditable() {
                    return this.order.state == "awaiting" || this.order.state == "in_revision";
                },
                entitiesCount() {
                    return this.allProvisions.length;
                },
                completedProvisionsCount() {
                    return this.allProvisions.filter((provision) => provision.is_complete).length
                },
                allViewableItems() {
                    let items = this.allProvisions;

                    if (this.displayedTypesFilter == "onlyAwaiting")
                        items = items.filter((item) => item.is_complete === false)
                    if (this.displayedTypesFilter == "onlyFinished")
                        items = items.filter((item) => item.is_complete === true)

                    return items;
                },
                totalPages() {
                    return Math.ceil(this.allViewableItems.length / this.pageSize);
                },
                visibleItems() {
                    return this.allViewableItems.slice((this.page - 1) * this.pageSize, this.page * this.pageSize );
                },
            },
            methods: {
                openProvisioningWizard(provisionId) {
                    document.dispatchEvent(new CustomEvent(
                        "requestProcessingDialogManager.provision_personell_dialog.trigger",
                        { detail: { provisionId: provisionId } }
                    ));
                },
                async getProvisions() {
                    return await fetch("/arrangement/service/process/{{SOPR_TOKEN}}/provisions", {
                        method: 'GET'
                    }).then(async response => await response.json());
                },
                async _denyOrder() {
                    let formData = new FormData();
                    formData.append("token", "{{SOPR_TOKEN}}")

                    await fetch("/arrangement/service/provisioning/deny", {
                      method: 'POST',
                      headers: {
                          "X-CSRFToken": "{{ csrf_token }}",
                      },
                      body: formData
                    }).then(async response => {
                      if (response.status == 200)
                          return await response.json();
                      
                      console.log(await response.text());

                      throw Error("Denying service order failed", response);
                    }).then((responseObj) => console.log("Denied"))
                },
                denyOrder() {
                    Swal.fire({
                        title: 'Er du sikker?',
                        text: "Er du sikker på at du vil avvise denne bestillingen?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Avbryt',
                        confirmButtonText: 'Avvis bestilling'
                      }).then((result) => {
                        if (result.isConfirmed) {
                            this._denyOrder();
                        }
                      })
                },
                async _confirmOrder() {
                    let formData = new FormData();
                    formData.append("token", "{{SOPR_TOKEN}}")

                    await fetch("/arrangement/service/provisioning/confirm", {
                        method: 'POST',
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: formData
                    }).then(async response => {
                        if (response.status == 200)
                            return await response.json();

                        throw Error("Confirming service order failed", response);
                    }).then((responseObj) => location.reload());
                },
                confirmOrder() {
                    Swal.fire({
                        title: 'Er du sikker?',
                        text: "Er du sikker på at du vil bekrefte denne bestillingen?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Avbryt',
                        confirmButtonText: 'Bekreft bestilling'
                      }).then((result) => {
                        if (result.isConfirmed) {
                            this._confirmOrder();
                        }
                      })
                },
                openOrderForRevisioning() {
                    Swal.fire({
                        title: 'Er du sikker?',
                        text: "Er du sikker på at du vil åpne denne bestillingen for revisjon?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Avbryt',
                        confirmButtonText: 'Åpne bestillingen'
                      }).then((result) => {
                        if (result.isConfirmed) {
                            let formData = new FormData();
                            formData.append("service_order_id", "{{object.related_to_order.id}}");
                        
                            fetch("/arrangement/service/open_for_revision/{{SOPR_TOKEN}}", {
                                method: 'POST',
                                headers: {
                                    "X-CSRFToken": "{{ csrf_token }}",
                                },
                                body: formData
                            }).then(async response => {
                                if (response.status == 200)
                                    return await response.json()

                                throw Error("Opening order for revision failed", response);
                            }).then(_ => location.reload());
                        }
                      })
                },
                completeRevisioning(nextAction) {
                    Swal.fire({
                        title: 'Vennligst beskriv endringene utført',
                        input: 'textarea',
                        icon: 'question',
                        html: `<i>
                            Skriv en kort summering av hva som har blitt endret.
                            Endringsmeldingen vil sendes til planleggere på e-post og internt i WeBook
                        </i>`,
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Avbryt',
                        confirmButtonText: 'Lagre'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            let formData = new FormData();
                            formData.append("changelog_message", result.value);
                            formData.append("service_order", "{{object.related_to_order}}")

                            await fetch("/arrangement/service/changenote/{{SOPR_TOKEN}}", {
                                method: 'POST',
                                headers: {
                                    "X-CSRFToken": "{{csrf_token}}"
                                },
                                body: formData
                            }).then(async response => {
                                if (response.ok) {
                                    if (nextAction == "confirm")
                                        await this._confirmOrder();
                                    else if (nextAction == "deny")
                                        await this._denyOrder();
                                    else
                                        throw new Error("Unrecognized next action specified");

                                    debugger;
                                }
                                else {
                                    throw new Error("Failed writing changenote")
                                }
                            }).then(_ => location.reload());
                        }
                    })
                }
            },
            async mounted() {
                window.refreshTable = async () => {
                    console.log(">> Refreshing Vue Table")
                    this.allProvisions = await this.getProvisions();
                }

                this.allProvisions = await this.getProvisions();

                console.log(this.allProvisions);
            },
            delimiters: ["[[", "]]"]
        });
        
        app.mount('#app');
    
        class CustomDialogFormInterceptorPlugin extends DialogFormInterceptorPlugin {
            constructor (csrf_token) {
                super(csrf_token);
            }
    
            onResponseOk() {
            }
        }

        const dialogManager = new DialogManager({
            managerName: "requestProcessingDialogManager",
            allowMultipleOpenAtOnce: false,
            dialogs: [
                [
                    "provision_personell_dialog",
                    new Dialog({
                        dialogElementId: 'provision_personell_dialog',
                        triggerElementId: undefined,
                        triggerByEvent: true,
                        formUrl: "/arrangement/service/provisioning/{{SOPR_TOKEN}}/<<provision>>",
                        dialogOptions: {
                            hide: { effect: "none", duration: 150 },
                            show: { effect: "none", duration: 150 },
                            width: "75%",
                            height: 'auto',
                            position: {
                                my: 'center',
                                at: 'center',
                              },
                            dialogClass: "no-titlebar",
                            modal: true,
                        },
                        modal: true,

                        plugins: [ new CustomDialogFormInterceptorPlugin("{{csrf_token}}") ],
                        htmlFabricator: async (context, dialog) => {
                            console.log(">> htmlFabricator")
                            dialog.formUrl = "/arrangement/service/provisioning/{{SOPR_TOKEN}}/" + context.lastTriggererDetails.provisionId
                            return dialogManager.loadDialogHtml({
                                url: "/arrangement/service/provisioning/{{SOPR_TOKEN}}/" + context.lastTriggererDetails.provisionId,
                                dialogId: "provision_personell_dialog",
                                managerName: "requestProcessingDialogManager",
                                customParameters: {
                                    sopr_token: "{{SOPR_TOKEN}}"
                                }
                            })
                        },
                        onRenderedCallback: (dialogManager, context) => {},
                        onUpdatedCallback: (dialogManager, context) => {},
                        onSubmit: async (context, details) => {
                            window.refreshTable();
                        }
                    })
                ]
            ]
        });

        dialogManager._makeAware();
    });
</script>

{% endblock %}