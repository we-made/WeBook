{% extends "secondary_public_base.html" %}   
{% load static i18n %}
{% load custom_tags %}
{% load crispy_forms_tags %}

{% block content %}

<div id="app">
    <h1 class="text-center">Behandling av bestilling</h1>
    <h3 class="text-center">{{ object.related_to_order.service }}</h3>
    <hr>

    <div class="row mb-3">
        <div class="col-2">
            <div class="bg-white rounded-3 shadow-3 p-4">
                <h3 class="text-center"><i class="fas fa-receipt"></i>&nbsp; Bestilling</h3>
                <div class="rounded-4 p-3 shadow-0">
                    <table class="table">
                        <tbody>
                            <tr>
                                <th class="fw-bold text-upper">TIDSSTEMPEL: </th>
                                <td>{{ object.created }}</td>
                            </tr>
                            <tr>
                                <th class="fw-bold text-upper">TIDSSTEMPEL: </th>
                                <td>{{ object.created }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <h6 class="fw-bold">Kommentar fra planlegger:</h6>
                    <textarea name="" id="" cols="30" rows="10" class="form-control" disabled>
{{object.related_to_order.freetext_comment}}
                    </textarea>
                </div>
            </div>



        </div>
        <div class="col-10">
            <div class="bg-white rounded-3 shadow-3 p-4">
                <div class="row">
                    <div class="col-2 border-end">
                        <div>
                            <div>
                                <h3 class="text-center fw-bold">Aktiviteter</h3>
                                <hr>
                                <table class="table">
                                    <tbody>
                                        {% for event in object.related_to_order.events.all %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex" style="justify-content: space-between; align-items: center;">
                                                        <h5>{{event.start}} - {{event.end}}</h5>
                                                        <button class="btn wb-btn-main">Tildel</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <h3 class="text-center fw-bold">Ressurser</h3>
                                <h6 class="text-center">Huk av en ressurs for Ã¥ vise de i kalenderen</h6>
                                
                                <div class="form-check mt-3 rounded-3 pl-5 ps-5 pt-2 pb-2"
                                    v-for="resource in resources">
                                    <input class="form-check-input" type="checkbox" :value="resource.id" :id="resource.id" v-model="focusedResources" />
                                    <label class="form-check-label" :for="resource.id">[[ resource.name ]]</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-10">
                        <div id="activitiesCalendar">

                        </div>
                    </div>
                </div>
            </div>        
        </div>
    </div>


    <div class="clearfix mt-3 bg-white rounded-3 shadow-3 p-4">
        <div class="float-end">
            <button class="btn btn-danger btn-lg">
                <i class="fas fa-times"></i>
                Avvis
            </button>
            <button class="btn btn-success btn-lg ms-3" disabled>
                <i class="fas fa-check"></i>
                Bekreft
            </button>
        </div>
    </div>
</div>  

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.1/index.min.js" integrity="sha512-88/heKGrsHjGwV3/5hCfhqseY7Nge7OmzbufE3VSHGK79SiMhypEbexl6i13hh7fKhh5hlomX/6kkQtFZernQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script >
    
    document.addEventListener('DOMContentLoaded', function() {
        const app = Vue.createApp({
            components: {
    
            },
            data() {
                return {
                    focusedResources: [],
                    order: {
                        service_name: "{{ object.related_to_order.service.name }}",
                        created_when: "{{ object.created_when }}",
                        planners_comment: "{{ object.related_to_order.freetext_comment }}"
                    },
                    activities: [
                        {% for item in object.related_to_order.events.all %}
                        {
                            id: '{{item.id}}',
                            title: '{{item.title}}',
                            start: '{{item.start|date:'Y-m-d H:i'}}',
                            end: '{{item.end|date:'Y-m-d H:i'}}'
                        },
                        {% endfor %}
                    ],
                    resources: [
                        {% for item in object.related_to_order.service.resources.all %}
                        {
                            id: '{{item.id}}',
                            name: '{{item.full_name}}'
                        },
                        {% endfor %}
                    ],
                }
            },
            watch: {
                focusedResources() {
                    console.log(this.focusedResources)
                }
            },
            computed: {
    
            },
            methods: {
                initializeCalendar() {
                    var calendarEl = document.getElementById('activitiesCalendar');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                      initialView: 'listYear',
                      views: [ "dayGridWeek" ],
                      eventTimeFormat: { 
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12:false
                        },
                        eventBackgroundColor: '#14a9ad',
                        displayEventEnd: true,
                      headerToolbar: {
                        start: 'title', // will normally be on the left. if RTL, will be on the right
                        center: 'dayGridWeek,listYear',
                        end: 'today prev,next' // will normally be on the right. if RTL, will be on the left
                      },
                      eventContent: function (arg) {
                            const formatTime = function (text) {
                                if (text.length == 1 || text.length == 3)
                                    text = "0" + text
                                if (text.length == 2)
                                    text += ":00"
                                    
                                return text;
                            }
            
                            let nodes = [];
            
                            let wrapper = document.createElement('div');
            
                            console.log(arg);

                            let timeText = document.createElement('strong');
                            timeText.classList.add('d-block');
                            timeText.innerText = `(${formatTime(arg.timeText)})`;
                            wrapper.appendChild(timeText);
            
                            let eventTitle = document.createElement('strong');
                            eventTitle.classList.add("mb-2", "event-title-text");
                            eventTitle.innerText = arg.event.title;
                            wrapper.appendChild(eventTitle);
            
                            nodes.push(wrapper);
            
                            return { domNodes: nodes };
                        },
                      schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                      resources: this.resources.map(x => { return {id: x.id, title: x.name} }),
                      events: this.activities
                    });
                    calendar.render();
                }
            },
            mounted() {
                console.log(this.activities);
                this.initializeCalendar();
            },
            delimiters: ["[[", "]]"]
        });
    
        app.mount('#app');
    });
</script>

{% endblock %}